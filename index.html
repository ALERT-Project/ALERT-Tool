<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9F9;
        }
        .category-2 { background-color: #4FD1C5; color: #134E4A; }
        .category-1 { background-color: #F6E05E; color: #1A202C; }
        .category-1-high { background-color: #F97316; color: #FFFFFF; }
        .unsafe { background-color: #FC8181; color: #1A202C; }
        .header-gradient {
            background: linear-gradient(to right, #0D9488, #0F766E);
        }
        .final-score-bg {
            background-color: #134E4A;
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 text-sm;
        }
        .sub-label {
            @apply block text-sm font-medium text-gray-600;
        }
        .module-bg-a { background-color: #fff1f2; }
        .module-bg-b { background-color: #f0f9ff; }
        .module-bg-c { background-color: #f0fdf4; }
        .module-bg-d { background-color: #fffbeb; }
        .module-bg-e { background-color: #fef2f2; }
        .module-bg-f { background-color: #faf5ff; }
        .module-title {
            @apply font-bold text-xl mb-3 p-3 rounded-t-lg;
        }
        .remove-btn {
            @apply ml-2 text-red-500 hover:text-red-700 font-bold;
        }
        .mod-score {
            color: #2563EB; /* A distinct blue for modified scores */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="header-gradient p-6 flex items-center justify-center text-white">
                <div class="bg-white/20 rounded-full p-2 mr-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
            </div>
            <div class="p-6 bg-gray-100 border-t-4 border-teal-100 border rounded-b-xl">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                        <input type="text" id="patientInitials" class="form-input bg-white">
                    </div>
                    <div>
                        <label for="urnLast4" class="block font-medium text-gray-700">Last 4 Digits of URN:</label>
                        <input type="text" id="urnLast4" class="form-input bg-white">
                    </div>
                     <div>
                        <label for="ward" class="block font-medium text-gray-700">Ward & Room No.:</label>
                        <div class="flex space-x-2">
                            <input type="text" id="ward" class="form-input bg-white" placeholder="Ward">
                            <input type="text" id="roomNumber" class="form-input bg-white" placeholder="Room">
                        </div>
                    </div>
                    <div>
                        <label for="losDays" class="block font-medium text-gray-700">ICU LOS (days):</label>
                        <input type="number" id="losDays" min="0" class="form-input bg-white">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Clinical Parameters (for auto-scoring)</h2>
            <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-gray-700">A-E Assessment</h3>
                    <div class="text-right">
                        <span class="text-sm font-medium text-gray-500">Calculated ADDS:</span>
                        <span id="calculatedADDSScore" class="font-bold text-lg text-teal-600">0</span>
                    </div>
                </div>
                <div class="flex flex-wrap gap-x-6 gap-y-4">
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">Airway</label><input type="text" id="airway_input" class="form-input" value="Patent"></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">Resp Rate</label><input type="number" id="rr_input" class="form-input vital-input"></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">SpO2 (%)</label><input type="number" id="spo2_input" class="form-input vital-input"></div>
                    <div class="flex items-end space-x-2 flex-grow basis-48 min-w-[220px]">
                        <div><label class="sub-label">O2 Flow</label><input type="number" id="o2_flow_input" class="form-input vital-input w-24" placeholder="Value"></div>
                        <div><label class="sub-label">Unit</label><select id="o2_unit_input" class="form-input vital-input w-28"><option value="lpm">L/min</option><option value="fio2">% FiO2</option></select></div>
                    </div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">Heart Rate</label><input type="number" id="hr_input" class="form-input vital-input"></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">SBP (mmHg)</label><input type="number" id="sbp_input" class="form-input vital-input"></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">DBP (mmHg)</label><input type="number" id="dbp_input" class="form-input"></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">Consciousness</label><select id="consciousness_input" class="form-input vital-input"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                    <div class="flex-grow basis-24 min-w-[120px]"><label class="sub-label">Temp (°C)</label><input type="number" step="0.1" id="temp_input" class="form-input vital-input"></div>
                </div>
            </div>
             <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-700 mb-2">ADDS Modifications</h3>
                <div class="space-y-2">
                    <label class="flex items-center"><input type="checkbox" id="addsModificationCheckbox" class="vital-input"> <span class="ml-2 text-sm">Apply MODS to ADDS</span></label>
                    <div id="addsModificationDetails" class="hidden ml-6 mt-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="RR"> <span class="ml-2 font-medium">Resp Rate</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5">
                                    <select data-param="rr" class="mod-operator form-input w-auto p-1 text-sm"><option value="between">between</option><option value="less_than">&lt;</option><option value="greater_than">&gt;</option></select>
                                    <input type="number" id="mod_rr_val1" placeholder="Min RR" class="form-input w-20 p-1">
                                    <span class="mod-val2-container" id="mod_rr_val2_container">- <input type="number" id="mod_rr_val2" placeholder="Max RR" class="form-input w-20 p-1"></span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="SpO2"> <span class="ml-2 font-medium">SpO2</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5">
                                    <span class="text-sm">Target &gt;</span>
                                    <input type="number" id="mod_spo2_lower" placeholder="e.g. 88" class="form-input w-24 p-1">
                                    <span class="text-sm">%</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="HR"> <span class="ml-2 font-medium">Heart Rate</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5">
                                    <select data-param="hr" class="mod-operator form-input w-auto p-1 text-sm"><option value="between">between</option><option value="less_than">&lt;</option><option value="greater_than">&gt;</option></select>
                                    <input type="number" id="mod_hr_val1" placeholder="Min HR" class="form-input w-20 p-1">
                                    <span class="mod-val2-container" id="mod_hr_val2_container">- <input type="number" id="mod_hr_val2" placeholder="Max HR" class="form-input w-20 p-1"></span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="SBP"> <span class="ml-2 font-medium">SBP</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5">
                                    <span class="text-sm">Target &gt;</span>
                                    <input type="number" id="mod_sbp_lower" placeholder="e.g. 90" class="form-input w-24 p-1">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="FiO2"> <span class="ml-2 font-medium">FiO2</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5">
                                    <span class="text-sm">Target &lt;</span>
                                    <input type="number" id="mod_fio2_upper" placeholder="e.g. 60" class="form-input w-24 p-1">
                                    <span class="text-sm">%</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="addsModificationText" class="sub-label">Modification Rationale:</label>
                            <textarea id="addsModificationText" rows="2" class="form-input"></textarea>
                        </div>
                    </div>
                </div>
            </div>
             <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Fluid Balance</h3>
                    <div class="flex flex-wrap gap-4">
                        <div><label class="sub-label">24hr Fluid Balance (mL)</label><input type="number" id="fbc_24hr_input" class="form-input fluid-input w-36" placeholder="+/- mL" step="500"></div>
                        <div><label class="sub-label">Total ICU Balance (mL)</label><input type="number" id="fbc_total_input" class="form-input fluid-input w-36" placeholder="+/- mL" step="500"></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Cognition</h3>
                    <div>
                        <label class="sub-label">AMT Score</label>
                        <select id="amt_score_input" class="form-input w-48"><option value="Unable to assess">Unable to assess</option><option value="4/4">4/4</option><option value="3/4">3/4</option><option value="2/4">2/4</option><option value="1/4">1/4</option><option value="0/4">0/4</option></select>
                    </div>
                </div>
            </div>
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-700 mb-2">Key Bloods</h3>
                <div class="flex flex-wrap gap-x-6 gap-y-4 items-end">
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">Lactate</label><input type="number" step="0.1" id="lactate_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" step="0.1" id="lactate_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">Creatinine</label><input type="number" id="creatinine_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" id="creatinine_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">Albumin</label><input type="number" id="albumin_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" id="albumin_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">CRP</label><input type="number" id="crp_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" id="crp_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">Hb</label><input type="number" id="hb_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" id="hb_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">K+</label><input type="number" step="0.1" id="k_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" step="0.1" id="k_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div class="flex items-end space-x-2"><div class="w-24"><label class="sub-label">Mg++</label><input type="number" step="0.1" id="mg_input" class="form-input blood-input" placeholder="Current"></div><div class="w-24"><input type="number" step="0.1" id="mg_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                </div>
                 <div class="mt-4 pt-4 border-t border-gray-300">
                    <label class="flex items-center">
                        <input type="checkbox" id="cts_cardiac_checkbox" class="blood-input">
                        <span class="ml-2 text-sm font-medium text-gray-700">CTS/Cardiac Patient (apply stricter K+/Mg++ targets)</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="scoringContainer">
            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
               <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
               <div class="space-y-6">
                    <div class="p-4 rounded-lg module-bg-a"><h3 class="module-title bg-rose-200 text-rose-800">Critical Risk Factors</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="15" data-id="crit_met" id="crit_met_checkbox"> <span class="ml-2">Currently in MET criteria (+15)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_adds4" id="crit_adds4_checkbox"> <span class="ml-2">ADDS Score ≥ 4 (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_lactate_high" id="crit_lactate_high_checkbox"> <span class="ml-2">Lactate ≥ 3.5 mmol/L (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_af"> <span class="ml-2">Unstable Atrial Fibrillation (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_hb_drop" id="crit_hb_drop_checkbox"> <span class="ml-2">New Hb drop >20g/L OR Active Bleeding (+10)</span></label></div></div>
                    <div class="rounded-lg module-bg-b"><h3 class="module-title bg-blue-200 text-blue-800">Physiological & Respiratory Stability</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="0" data-id="adds_0" id="adds_0_radio" checked> <span class="ml-2">Current ADDS Score 0 (+0)</span></label><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="1" data-id="adds_1-2" id="adds_1-2_radio"> <span class="ml-2">Current ADDS Score 1-2 (+1)</span></label><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="5" data-id="adds_3" id="adds_3_radio"> <span class="ml-2">Current ADDS Score 3 (+5)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="5" data-id="adds_worsening"> <span class="ml-2">Worsening ADDS Trend (last 12-24h) (+5)</span></label><hr class="my-3"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="resp_increasing_o2"> <span class="ml-2">Increasing O2 requirements in last 12h (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="6" data-id="resp_rapid_wean"> <span class="ml-2">Rapid weaning of respiratory support in last 4h (+6)</span></label></div></div>
                    <div class="p-4 rounded-lg module-bg-c"><h3 class="module-title bg-green-200 text-green-800">Bloods</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_electrolytes" id="bloods_electrolytes"> <span class="ml-2">Abnormal Electrolytes (K+, Mg++, Na+, Phos) (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_lactate_mid" id="bloods_lactate_mid_checkbox"> <span class="ml-2">Lactate 2.0 - 3.4 (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_creatinine" id="bloods_creatinine_checkbox"> <span class="ml-2">Creatinine >200 µmol/L (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_albumin" id="bloods_albumin_checkbox"> <span class="ml-2">Albumin &lt;25 g/L (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_crp" id="bloods_crp_checkbox"> <span class="ml-2">CRP >100 mg/L (static/rising) (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_anaemia" id="bloods_anaemia_checkbox"> <span class="ml-2">Anaemia (Hb &lt; 80 g/L) (+3)</span></label></div></div>
                    <div class="p-4 rounded-lg module-bg-d"><h3 class="module-title bg-yellow-200 text-yellow-800">Clinical</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="0" data-id="pain_0" checked> <span class="ml-2 text-gray-500">Pain: None / Well Controlled</span></label><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="3" data-id="pain_iv"> <span class="ml-2">Pain: Requires regular IV/potent analgesia (+3)</span></label><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="5" data-id="pain_pca"> <span class="ml-2">Pain: Poorly controlled / PCA (+5)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" data-id="fluid_0" id="fluid_0_radio" checked> <span class="ml-2 text-gray-500">Fluid Status: Euvolaemic</span></label><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="2" data-id="fluid_mild" id="fluid_mild_radio"> <span class="ml-2">Mild Dehydration/Overload (+2)</span></label><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-id="fluid_sig" id="fluid_sig_radio"> <span class="ml-2">Significant Dehydration/Overload (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="0" data-id="diet_0" checked> <span class="ml-2 text-gray-500">Diet: Normal</span></label><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="2" data-id="diet_modified"> <span class="ml-2">Diet: Supplements / Modified (+2)</span></label><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="4" data-id="diet_nbm"> <span class="ml-2">Diet: NBM / NG / TPN (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="0" data-id="delirium_0" checked> <span class="ml-2 text-gray-500">Delirium: None</span></label><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="4" data-id="delirium_mild"> <span class="ml-2">Delirium: Mild / Subsyndromal (+4)</span></label><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-id="delirium_mod"> <span class="ml-2">Delirium: Moderate to Severe (+8)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="0" data-id="mobility_0" checked> <span class="ml-2 text-gray-500">Mobility: At Baseline</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="1" data-id="mobility_limited"> <span class="ml-2">Mobility: Limited by devices/attachments (+1)</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="2" data-id="mobility_assisted"> <span class="ml-2">Mobility: Assisted (+2)</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="5" data-id="mobility_bedbound"> <span class="ml-2">Mobility: Bed-bound (+5)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="lines_score" class="score-input" data-score="0" data-id="lines_0" checked> <span class="ml-2 text-gray-500">Lines: None / PIVC only</span></label><label class="flex items-center"><input type="radio" name="lines_score" class="score-input" data-score="5" data-id="lines_cvc"> <span class="ml-2">Central Line present (CVC/PICC/Vascath) (+5)</span></label><hr class="my-3"><div class="space-y-2"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bowels_issue"> <span class="ml-2">Bowels: Not opened >3 days / Ileus (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="5" data-id="airway_altered"> <span class="ml-2">Altered Airway (Tracheostomy/Laryngectomy) (+5)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="drains_high_risk"> <span class="ml-2">High-Risk Drain present (+3)</span></label></div><hr class="my-3"><div class="pt-2"><label class="flex items-center"><input type="radio" name="concern_score" class="score-input" data-score="0" data-id="concern_0" checked> <span class="ml-2 text-gray-500">Nursing Concern: None</span></label><label class="flex items-center"><input type="radio" name="concern_score" class="score-input" data-score="5" data-id="concern_present"> <span class="ml-2">Nursing Concern Present (+5)</span></label><textarea id="nursingConcernText" class="mt-2 ml-6 w-full rounded-md border-gray-300 shadow-sm text-sm" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div></div>
                    <div class="p-4 rounded-lg module-bg-e"><h3 class="module-title bg-red-200 text-red-800">Systemic</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" id="losCheckbox" class="score-input" data-score="4" data-id="systemic_los"> <span class="ml-2">LOS > 3 days (+4)</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="0" data-id="frailty_0" checked> <span class="ml-2 text-gray-500">Frailty: Not Frail</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="2" data-id="frailty_mild"> <span class="ml-2">Frailty: Mild (+2)</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="4" data-id="frailty_mod"> <span class="ml-2">Frailty: Mod-Severe (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" id="comorbiditiesCheckbox" data-id="systemic_comorbid"> <span class="ml-2"><span class="comorbidity-main-text">≥3 chronic comorbidities</span> <span class="text-gray-400 text-xs">(e.g. IHD, COPD, T2DM)</span> (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="systemic_ooh"> <span class="ml-2">Out-of-Hours Discharge (+3)</span></label></div></div>
               </div>
           </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">FINAL REVIEW & STRATIFICATION</h2>
            <div class="space-y-4">
                <div class="p-4 rounded-lg module-bg-f">
                    <h3 class="module-title bg-purple-200 text-purple-800">Post-ICU Syndrome (PICS) Screening</h3>
                    <div class="space-y-2 p-4">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="negative" checked> <span class="ml-2">Negative</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="positive"> <span class="ml-2">Positive</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="unable"> <span class="ml-2">Unable to assess</span></label>
                        </div>
                        <div id="pics_unable_details" class="hidden ml-6 mt-2">
                            <label for="pics_unable_notes" class="sub-label">Reason:</label>
                            <textarea id="pics_unable_notes" rows="2" class="form-input"></textarea>
                        </div>
                    </div>
                </div>
                <div class="final-score-bg text-white rounded-xl shadow-lg p-6">
                     <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">TOTAL SCORE</span><div id="totalScore" class="text-5xl font-bold">0</div></div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="riskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300">Category 2: Standard follow-up</div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Optional Narrative Details for DMR</h2>
            <div class="grid grid-cols-1 gap-6 text-sm">
                <div><label for="admissionReason" class="block font-medium text-gray-600">Reason for ICU Admission:</label><textarea id="admissionReason" rows="2" class="form-input"></textarea></div>
                <div><label for="pmh" class="block font-medium text-gray-600">Past Medical History (PMH):</label><textarea id="pmh" rows="3" class="form-input"></textarea></div>
                <div><label for="icuSummary" class="block font-medium text-gray-600">ICU Summary / Timeline:</label><textarea id="icuSummary" rows="6" class="form-input"></textarea></div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Lines, Drains & Wounds</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">Vascular Access</h4>
                            <div class="space-y-2">
                                <label class="flex items-center"><input type="checkbox" id="device_cvc"> <span class="ml-2">CVC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_picc"> <span class="ml-2">PICC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_vascath"> <span class="ml-2">Vascath</span></label>
                                <div class="pt-2">
                                    <h5 class="font-medium text-gray-600 mb-2 text-sm">PIVCs</h5>
                                    <div id="pivcs_container" class="space-y-2"></div>
                                    <button type="button" id="addPivcButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add PIVC</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">Other Devices</h4>
                            <div class="space-y-2">
                                <label class="flex items-center"><input type="checkbox" id="device_idc"> <span class="ml-2">IDC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_ng"> <span class="ml-2">NG Tube</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_pacing_wire"> <span class="ml-2">Epicardial Pacing Wires</span></label>
                                <div class="flex items-center space-x-2 pt-1">
                                    <input type="checkbox" id="device_other">
                                    <input type="text" id="device_other_text" placeholder="Other device..." class="text-sm p-1 border rounded-md w-full">
                                </div>
                            </div>
                        </div>
                         <div>
                            <h4 class="font-medium text-gray-600 mb-2">Drains</h4>
                            <div id="drains_container" class="space-y-2"></div>
                            <button type="button" id="addDrainButton" class="mt-2 text-sm bg-teal-100 text-teal-800 hover:bg-teal-200 px-3 py-1 rounded-md">+ Add Drain</button>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">Wounds</h4>
                            <div id="wounds_container" class="space-y-2"></div>
                            <button type="button" id="addWoundButton" class="mt-2 text-sm bg-pink-100 text-pink-800 hover:bg-pink-200 px-3 py-1 rounded-md">+ Add Wound</button>
                        </div>
                    </div>
                </div>
                
                <div><label for="impression" class="block font-medium text-gray-600">Impression:</label><textarea id="impression" rows="3" class="form-input"></textarea></div>
                <div><label for="emrAdditionalNotes" class="block font-medium text-gray-600">Additional Plan Notes:</label><textarea id="emrAdditionalNotes" rows="3" class="form-input"></textarea></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">DMR Summary Generator</h2>
            <div class="flex space-x-4 mb-4"><button id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Generate DMR Summary</button><button id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Copy to Clipboard</button></div>
            <textarea id="emrSummary" rows="15" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" readonly placeholder="Your summary will appear here..."></textarea>
            <div class="mt-6 text-center"><button id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reset Form</button></div>
        </div>
    </div>
    
    <div class="text-center mt-8 text-gray-500 text-sm">Major update version 3 28/8/25</div>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const scoreInputs = document.querySelectorAll('.score-input');
            const totalScoreEl = document.getElementById('totalScore');
            const riskCategoryEl = document.getElementById('riskCategory');
            const resetButton = document.getElementById('resetButton');
            const generateSummaryButton = document.getElementById('generateSummaryButton');
            const copySummaryButton = document.getElementById('copySummaryButton');
            const emrSummaryEl = document.getElementById('emrSummary');
            const bloodInputs = document.querySelectorAll('.blood-input');
            const calculatedADDSEl = document.getElementById('calculatedADDSScore');
            const addsModCheckbox = document.getElementById('addsModificationCheckbox');
            const addsModDetails = document.getElementById('addsModificationDetails');
            const addDrainButton = document.getElementById('addDrainButton');
            const drainsContainer = document.getElementById('drains_container');
            const addWoundButton = document.getElementById('addWoundButton');
            const woundsContainer = document.getElementById('wounds_container');
            const addPivcButton = document.getElementById('addPivcButton');
            const pivcsContainer = document.getElementById('pivcs_container');
            const picsRadios = document.querySelectorAll('input[name="pics_status"]');
            const picsUnableDetails = document.getElementById('pics_unable_details');
            const vitalInputs = document.querySelectorAll('.vital-input');
            const modParamCheckboxes = document.querySelectorAll('input[name="mod_param"]');
            const modOperators = document.querySelectorAll('.mod-operator');
            const nursingConcernRadios = document.querySelectorAll('input[name="concern_score"]');
            const nursingConcernText = document.getElementById('nursingConcernText');
            
            // --- Data Maps & Constants ---
            const categoryMap = {'unsafe':'Unsafe for Ward: Immediate senior review required','category-1-high':'Category 1 - High Risk: Escalate to ALERT medical rounding team','category-1':'Category 1: Enhanced follow-up for 72 hours','category-2':'Category 2: Standard follow-up'};
            const carePlanMap = {'resp_increasing_o2':'Respiratory Risk: Perform focused respiratory assessment. Escalate for review of increasing O2 demand.','resp_rapid_wean':'Respiratory Risk: Increase frequency of respiratory observations. Monitor for signs of fatigue.','bloods_electrolytes':'Biochemical Risk: Monitor electrolyte trends. Ensure replacement therapy is charted and administered.','bloods_lactate_mid':'Biochemical Risk: Liaise with medical team for serial lactate measurements to ensure clearance.','bloods_creatinine':'Renal Risk: Maintain strict fluid balance chart. Monitor renal function. Review nephrotoxic medications.','bloods_albumin':'Nutritional Risk: Refer to Dietitian for nutritional assessment. Monitor for oedema and poor wound healing.','bloods_crp':'Infection/Inflammatory Risk: Continue vigilant monitoring for signs of infection. Ensure timely antibiotics.','bloods_anaemia':'Bleeding Risk: Monitor for signs of active bleeding. Discuss transfusion threshold with medical team.','pain_iv':'Pain Management: Perform comprehensive pain assessment. Escalate to Acute Pain Service if poorly controlled.','pain_pca':'Pain Management: Perform comprehensive pain assessment. Escalate to Acute Pain Service if poorly controlled.','fluid_mild':'Fluid Balance Risk: Maintain strict fluid balance chart. Perform clinical fluid assessment.','fluid_sig':'Fluid Balance Risk: Maintain strict fluid balance chart. Perform clinical fluid assessment.','diet_modified':'Nutritional Risk: Ensure referrals to Dietitian/Speech Pathology are in place. Monitor intake.','diet_nbm':'Nutritional Risk: Ensure referrals to Dietitian/Speech Pathology are in place. Monitor intake.','bowels_issue':'Gastrointestinal Risk: Implement bowel management plan. Monitor for signs of ileus.','delirium_mild':'Cognitive Risk: Implement non-pharmacological delirium prevention/management strategies.','delirium_mod':'Cognitive Risk: Implement non-pharmacological delirium prevention/management strategies.','mobility_assisted':'Mobility Deficit: Ensure Physiotherapy referral is active. Implement pressure injury prevention strategies.','mobility_bedbound':'Mobility Deficit: Ensure Physiotherapy referral is active. Implement pressure injury prevention strategies.','mobility_limited':'Mobility Deficit: Liaise with Physiotherapy to create a safe mobilisation plan that accounts for complex device management. Ensure adequate staff assistance for transfers.','airway_weak':'Airway Clearance Risk: Collaborate with Physiotherapy on secretion management plan.','airway_altered':'Airway Risk: Confirm ward staff competency with tracheostomy/laryngectomy care.','lines_cvc':'Infection Risk: Daily review of Central Line necessity with medical team. Maintain strict ANTT for all access.','drains_high_risk':'Drain Management: Maintain vigilance over drain patency and output. Escalate any changes.','concern_present':"Nursing Concern: Articulate and escalate specific concerns to senior staff for 'fresh eyes' review.",'frailty_mild':'Frailty Risk: Ensure appropriate referrals (Geriatrics, OT, Physio). Focus on safe mobilization.','frailty_mod':'Frailty Risk: Ensure appropriate referrals (Geriatrics, OT, Physio). Focus on safe mobilization.','systemic_comorbid':'Systemic Risk: Confirm relevant specialty teams have been consulted and a consolidated plan is in place.','systemic_ooh':'Systemic Risk: Provide a detailed, structured handover to the after-hours team.','crit_met':'Critical Risk: Patient is in MET criteria. Initiate MET call and immediate resuscitation.','crit_adds4':'Critical Risk: Patient has high ADDS score. Escalate for urgent medical review (<30 mins).','crit_lactate_high':'Critical Risk: Patient is critically unwell. Escalate for immediate senior medical review for shock.','crit_af':'Critical Risk: Patient is in unstable AF. Escalate for urgent cardiology/medical review.','crit_hb_drop':'Critical Risk: Significant Hb drop or active bleeding. Escalate for urgent medical/surgical review.'};
            const assessmentNarrativeMap = {'crit_met':'currently in MET criteria','crit_adds4':'a high ADDS score','crit_lactate_high':'a critically high lactate','crit_af':'unstable atrial fibrillation','crit_hb_drop':'a significant drop in haemoglobin or active bleeding','adds_worsening':'a worsening trend in observations','resp_increasing_o2':'increasing oxygen requirements','resp_rapid_wean':'a recent rapid wean of respiratory support','bloods_lactate_mid':'a moderately elevated lactate','bloods_creatinine':'a significant renal impairment','bloods_albumin':'hypoalbuminaemia, indicating nutritional risk','bloods_crp':'a significant inflammatory response (CRP > 100)','pain_pca':'poorly controlled pain requiring advanced analgesia','fluid_sig':'a significant fluid imbalance','diet_nbm':'is receiving no oral nutrition (NBM/NG/TPN)','delirium_mod':'moderate to severe delirium','mobility_bedbound':'is currently bed-bound with significant mobility deficits', 'mobility_limited':'mobility is limited by devices/attachments', 'airway_altered':'a surgically altered airway (tracheostomy/laryngectomy)','concern_present':'specific concerns raised by the bedside nurse'};
            const standardScores = { getRrScore(rr) { let s=0,m=false; if(rr>=36||rr<5)m=true;else if(rr>=30&&rr<=35)s=3;else if(rr>=25&&rr<=29)s=2;else if(rr>=21&&rr<=24)s=1;else if(rr>=5&&rr<=9)s=3; return {score:s, isMet:m}; }, getSpo2Score(spo2) { let s=0,m=false; if(spo2<=84)m=true;else if(spo2>=85&&spo2<=90)s=2;else if(spo2>=91&&spo2<=93)s=1; return {score:s, isMet:m}; }, getO2Score(o2Flow, o2Unit) { let s=0; if(o2Unit==='lpm'){if(o2Flow>10)s=3;else if(o2Flow>=5&&o2Flow<=9)s=2;else if(o2Flow>=2&&o2Flow<=4)s=1}else{if(o2Flow>=40)s=3;else if(o2Flow>=29)s=2;else if(o2Flow>=21)s=1} return {score:s, isMet:false}; }, getHrScore(hr) { let s=0,m=false; if(hr>=140||hr<30)m=true;else if(hr>=130&&hr<=139)s=3;else if(hr>=120&&hr<=129)s=2;else if(hr>=100&&hr<=119)s=1;else if(hr>=40&&hr<=49)s=1;else if(hr>=30&&hr<=39)s=2; return {score:s, isMet:m}; }, getSbpScore(sbp) { let s=0,m=false; if(sbp<90)m=true;else if(sbp>=190&&sbp<=199)s=3;else if(sbp>=180&&sbp<=189)s=2;else if(sbp>=150&&sbp<=179)s=1;else if(sbp>=80&&sbp<=99)s=1;else if(sbp>=70&&sbp<=79)s=2; return {score:s, isMet:m}; } };
            
            // --- Helper Functions ---
            const safeGet = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
            const safeIsChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
            const getSelectText = (id) => {
                const el = document.getElementById(id);
                if (el && el.selectedIndex > -1) { return el.options[el.selectedIndex].text; }
                return '';
            };
            const getTrend = (current, previous, tolerance, higherIsWorse = true) => { if (isNaN(current) || isNaN(previous)) return ''; if (Math.abs(current - previous) <= tolerance) return ' (static)'; if (higherIsWorse) { return current > previous ? ' (worsening)' : ' (improving)'; } else { return current < previous ? ' (worsening)' : ' (improving)'; } };
            
            // --- Core Functions ---
            function generateSummary() {
                try {
                    const output = [];
                    const initials = safeGet('patientInitials').toUpperCase(), urn = safeGet('urnLast4'), ward = safeGet('ward'), room = safeGet('roomNumber'), los = safeGet('losDays');
                    output.push(`ALERT ASSESSMENT: ${initials || '??'} (URN: ...${urn || 'XXXX'}) - ${ward || 'WARD'} Rm ${room || '??'}`);
                    if (los) output.push(`Post-ICU Day ${los}`);
                    output.push('');
                    output.push(`RISK SCORE: ${totalScoreEl.textContent} (${riskCategoryEl.textContent})`);
                    const impression = safeGet('impression');
                    if (impression.trim()) {
                        output.push('\nIMPRESSION:');
                        output.push(impression);
                    }
                    output.push('');
                    const riskNarratives = [], carePlanItems = [];
                    scoreInputs.forEach(input => {
                        if (input.checked && input.dataset.score !== "0") {
                            const id = input.dataset.id;
                            if (assessmentNarrativeMap[id]) riskNarratives.push(assessmentNarrativeMap[id]);
                            if (carePlanMap[id]) carePlanItems.push(carePlanMap[id]);
                        }
                    });
                    if (riskNarratives.length > 0) {
                        output.push('KEY RISKS IDENTIFIED:');
                        output.push(`Patient has ${riskNarratives.join(', ')}.`);
                        const concern = safeGet('nursingConcernText');
                        if (safeIsChecked('concern_present') && concern.trim()) output.push(`Specific Nursing Concern: ${concern}`);
                        output.push('');
                    }
                    output.push('PLAN & FOCUS:');
                    if (carePlanItems.length > 0) {
                        carePlanItems.forEach(item => output.push(`- ${item}`));
                    } else {
                        output.push('- Continue standard ward-based care.');
                    }
                    const additionalNotes = safeGet('emrAdditionalNotes');
                    if (additionalNotes.trim()) output.push(`- Additional Notes: ${additionalNotes}`);
                    output.push('');
                    output.push('A-E ASSESSMENT:');
                    output.push(`- Airway: ${safeGet('airway_input') || 'Not assessed'}`);
                    const o2_flow = safeGet('o2_flow_input');
                    const o2_delivery = (o2_flow && parseFloat(o2_flow) > 0) ? `${o2_flow} ${getSelectText('o2_unit_input')}` : 'Room Air';
                    output.push(`- Breathing: RR ${safeGet('rr_input') || 'N/A'}, SpO2 ${safeGet('spo2_input') || 'N/A'}% on ${o2_delivery}`);
                    output.push(`- Circulation: HR ${safeGet('hr_input') || 'N/A'}, BP ${safeGet('sbp_input') || 'N/A'}/${safeGet('dbp_input') || 'N/A'}`);
                    output.push(`- Disability: ${getSelectText('consciousness_input') || 'N/A'}`);
                    output.push(`- Exposure: Temp ${safeGet('temp_input') || 'N/A'}°C`);
                    let addsLine = `- ADDS Score: ${calculatedADDSEl.textContent}`;
                    if (safeIsChecked('addsModificationCheckbox')) {
                        const rationale = safeGet('addsModificationText');
                        if (rationale.trim()) addsLine += ` (MODS active: ${rationale})`;
                    }
                    output.push(addsLine);
                    output.push('');
                    const bloodLines = [];
                    const formatBlood = (name, id_curr, id_prev, tol, higherIsWorse=true) => {
                        const currVal = safeGet(id_curr);
                        if (!currVal) return;
                        const curr = parseFloat(currVal), prev = parseFloat(safeGet(id_prev));
                        const trend = getTrend(curr, prev, tol, higherIsWorse);
                        const prevText = isNaN(prev) ? '' : ` (prev ${prev})`;
                        bloodLines.push(`- ${name}: ${curr}${prevText}${trend}`);
                    };
                    formatBlood('Lactate', 'lactate_input', 'lactate_input_prev', 0.2);
                    formatBlood('Creatinine', 'creatinine_input', 'creatinine_input_prev', 10);
                    formatBlood('Albumin', 'albumin_input', 'albumin_input_prev', 2, false);
                    formatBlood('CRP', 'crp_input', 'crp_input_prev', 10);
                    formatBlood('Hb', 'hb_input', 'hb_input_prev', 5, false);
                    formatBlood('K+', 'k_input', 'k_input_prev', 0.2);
                    formatBlood('Mg++', 'mg_input', 'mg_input_prev', 0.1);
                    if (bloodLines.length > 0) {
                        output.push('KEY BLOODS:');
                        output.push(...bloodLines);
                        output.push('');
                    }
                    const deviceLines = [];
                    const centralLines = ['device_cvc', 'device_picc', 'device_vascath'].filter(safeIsChecked).map(id => id.split('_')[1].toUpperCase());
                    if(centralLines.length > 0) deviceLines.push(`- Vascular Access: ${centralLines.join(', ')}`);
                    const pivcs = [];
                    document.querySelectorAll('#pivcs_container input[type="text"]').forEach(i => { if (i.value.trim()) pivcs.push(i.value.trim()); });
                    if (pivcs.length > 0) deviceLines.push(`- PIVCs: ${pivcs.join('; ')}`);
                    const otherDevices = ['device_idc', 'device_ng', 'device_pacing_wire'].filter(safeIsChecked).map(id => document.getElementById(id).nextElementSibling.textContent.trim());
                    const otherDeviceText = safeGet('device_other_text');
                    if (safeIsChecked('device_other') && otherDeviceText.trim()) otherDevices.push(otherDeviceText);
                    if(otherDevices.length > 0) deviceLines.push(`- Other Devices: ${otherDevices.join(', ')}`);
                    const drains = [];
                    document.querySelectorAll('#drains_container input[type="text"]').forEach(i => { if (i.value.trim()) drains.push(i.value.trim()); });
                    if (drains.length > 0) deviceLines.push(`- Drains: ${drains.join('; ')}`);
                    const wounds = [];
                    document.querySelectorAll('#wounds_container input[type="text"]').forEach(i => { if (i.value.trim()) wounds.push(i.value.trim()); });
                    if (wounds.length > 0) deviceLines.push(`- Wounds: ${wounds.join('; ')}`);
                    if (deviceLines.length > 0) {
                        output.push('LINES, DRAINS & WOUNDS:');
                        output.push(...deviceLines);
                        output.push('');
                    }
                    const admissionReason = safeGet('admissionReason'), pmh = safeGet('pmh'), icuSummary = safeGet('icuSummary');
                    if (admissionReason.trim() || pmh.trim()) {
                        output.push('BACKGROUND:');
                        if (admissionReason.trim()) output.push(`- Admission: ${admissionReason}`);
                        if (pmh.trim()) output.push(`- PMH: ${pmh}`);
                        output.push('');
                    }
                    if(icuSummary.trim()) {
                        output.push('ICU SUMMARY:');
                        output.push(icuSummary);
                        output.push('');
                    }
                    emrSummaryEl.value = output.join('\n');
                } catch (error) {
                    emrSummaryEl.value = `An error occurred while generating the summary. Please check the console for details.\n\nError: ${error.message}`;
                    console.error("Summary generation failed:", error);
                }
            }

            function handleBloodInputs() {
                const getF = (id) => parseFloat(safeGet(id));
                const check = (id, condition) => { const el = document.getElementById(id); if (el) el.checked = condition; };
                const lactate = getF('lactate_input');
                if (!isNaN(lactate)) { check('crit_lactate_high_checkbox', lactate >= 3.5); check('bloods_lactate_mid_checkbox', lactate >= 2.0 && lactate < 3.5); }
                const creatinine = getF('creatinine_input');
                if (!isNaN(creatinine)) check('bloods_creatinine_checkbox', creatinine > 200);
                const albumin = getF('albumin_input');
                if (!isNaN(albumin)) check('bloods_albumin_checkbox', albumin < 25);
                const crp = getF('crp_input');
                if (!isNaN(crp)) check('bloods_crp_checkbox', crp > 100);
                const hb = getF('hb_input'), hb_prev = getF('hb_input_prev');
                if (!isNaN(hb)) check('bloods_anaemia_checkbox', hb < 80);
                if (!isNaN(hb) && !isNaN(hb_prev)) check('crit_hb_drop_checkbox', (hb_prev - hb) > 20);
                const k = getF('k_input'), mg = getF('mg_input'), isCardiac = safeIsChecked('cts_cardiac_checkbox');
                let abnormalElectrolytes = false;
                if (!isNaN(k)) { if ((isCardiac && (k < 4.0 || k > 5.0)) || (!isCardiac && (k < 3.5 || k > 5.2))) abnormalElectrolytes = true; }
                if (!isNaN(mg)) { if ((isCardiac && (mg < 0.8 || mg > 1.0)) || (!isCardiac && (mg < 0.7 || mg > 1.0))) abnormalElectrolytes = true; }
                check('bloods_electrolytes', abnormalElectrolytes);
                calculateScore();
            }

            function addDynamicInput(container, placeholder) { const row = document.createElement('div'); row.className = 'flex items-center'; row.innerHTML = `<input type="text" placeholder="${placeholder}" class="form-input flex-grow"><button type="button" class="remove-btn">✖</button>`; container.appendChild(row); }
            function resetForm(){
                document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el=>{if(el.type==='select-one'){el.selectedIndex=0}else{el.value=''}});
                document.querySelectorAll('input[type="checkbox"]').forEach(input=>input.checked=false);
                document.querySelectorAll('input[type="radio"]').forEach(rb=>{if(rb.dataset.score==="0" || rb.value==="negative"){rb.checked=true}});
                document.getElementById('airway_input').value='Patent'; document.querySelector('input[name="concern_score"][data-score="0"]').checked=true; nursingConcernText.style.display='none';
                drainsContainer.innerHTML=''; addDynamicInput(drainsContainer, 'Drain type & site...');
                woundsContainer.innerHTML=''; addDynamicInput(woundsContainer, 'Wound location & description...');
                pivcsContainer.innerHTML=''; addDynamicInput(pivcsContainer, 'e.g., Pink 20G Lt forearm...');
                picsUnableDetails.classList.add('hidden'); document.getElementById('pics_unable_notes').value = '';
                document.querySelectorAll('.mod-details').forEach(el => el.classList.add('hidden'));
                emrSummaryEl.value = '';
                calculateADDS();
            }
            function calculateADDS() {
                let adds = 0; let met = false;
                const modsActive = safeIsChecked('addsModificationCheckbox');
                const getMod = (name) => modsActive && document.querySelector(`input[name="mod_param"][value="${name}"]`).checked;
                const rr = parseInt(safeGet('rr_input'),10); if (!isNaN(rr)) { if (getMod('RR')) { const op = document.querySelector('[data-param="rr"]').value; const v1 = parseFloat(safeGet('mod_rr_val1')); const v2 = parseFloat(safeGet('mod_rr_val2')); let breach = false; if (op==='between'&&(!isNaN(v1)&&rr<v1||!isNaN(v2)&&rr>v2)) breach=true; if (op==='less_than'&&!isNaN(v1)&&rr>=v1) breach=true; if (op==='greater_than'&&!isNaN(v1)&&rr<=v1) breach=true; if(breach){ const res = standardScores.getRrScore(rr); adds+=res.score; met=met||res.isMet; } } else { const res = standardScores.getRrScore(rr); adds+=res.score; met=met||res.isMet; } }
                const spo2 = parseInt(safeGet('spo2_input'),10); const o2Flow = parseFloat(safeGet('o2_flow_input')); const o2Unit = safeGet('o2_unit_input'); if (getMod('SpO2')) { const l = parseFloat(safeGet('mod_spo2_lower')); if(!isNaN(spo2) && !isNaN(l) && spo2 < l) { const res = standardScores.getSpo2Score(spo2); adds+=res.score; met=met||res.isMet; } } else if (!isNaN(spo2)) { const res = standardScores.getSpo2Score(spo2); adds+=res.score; met=met||res.isMet; }
                if (getMod('FiO2')) { if (o2Unit === 'fio2') { const u = parseFloat(safeGet('mod_fio2_upper')); if (!isNaN(o2Flow) && !isNaN(u) && o2Flow > u) { const res = standardScores.getO2Score(o2Flow, o2Unit); adds+=res.score; } } } else if (!isNaN(o2Flow) && o2Flow > 0 && !getMod('SpO2')) { const res = standardScores.getO2Score(o2Flow, o2Unit); adds+=res.score; }
                const hr = parseInt(safeGet('hr_input'),10); if (!isNaN(hr)) { if (getMod('HR')) { const op = document.querySelector('[data-param="hr"]').value; const v1 = parseFloat(safeGet('mod_hr_val1')); const v2 = parseFloat(safeGet('mod_hr_val2')); let breach = false; if (op==='between'&&(!isNaN(v1)&&hr<v1||!isNaN(v2)&&hr>v2)) breach=true; if (op==='less_than'&&!isNaN(v1)&&hr>=v1) breach=true; if (op==='greater_than'&&!isNaN(v1)&&hr<=v1) breach=true; if(breach){ const res = standardScores.getHrScore(hr); adds+=res.score; met=met||res.isMet; } } else { const res = standardScores.getHrScore(hr); adds+=res.score; met=met||res.isMet; } }
                const sbp = parseInt(safeGet('sbp_input'),10); if (!isNaN(sbp)) { if (getMod('SBP')) { const l = parseFloat(safeGet('mod_sbp_lower')); if (!isNaN(l) && sbp < l) { const res = standardScores.getSbpScore(sbp); adds+=res.score; met=met||res.isMet; } } else { const res = standardScores.getSbpScore(sbp); adds+=res.score; met=met||res.isMet; } }
                const temp = parseFloat(safeGet('temp_input')); if (!isNaN(temp)) { if(temp>=38.6||temp<35.1)adds+=2;else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36))adds+=1; }
                const consciousness = parseInt(safeGet('consciousness_input'),10); if (!isNaN(consciousness)) { if(consciousness===3)met=true;else adds+=consciousness; }
                calculatedADDSEl.textContent = met ? 'MET' : adds; calculatedADDSEl.classList.remove('mod-score', 'text-red-600', 'text-teal-600');
                if (met) { calculatedADDSEl.classList.add('text-red-600'); } else if (modsActive) { calculatedADDSEl.textContent = `MODS ${adds}`; calculatedADDSEl.classList.add('mod-score'); } else { calculatedADDSEl.classList.add('text-teal-600'); }
                document.getElementById('crit_met_checkbox').checked=met;document.getElementById('crit_adds4_checkbox').checked=false;document.getElementById('adds_0_radio').checked=false;document.getElementById('adds_1-2_radio').checked=false;document.getElementById('adds_3_radio').checked=false;
                if(!met&&adds>=4)document.getElementById('crit_adds4_checkbox').checked=true;else if(!met&&adds===3)document.getElementById('adds_3_radio').checked=true;else if(!met&&adds>=1)document.getElementById('adds_1-2_radio').checked=true;else if(!met)document.getElementById('adds_0_radio').checked=true;
                calculateScore();
            }
            
            function calculateScore(){let total=0;scoreInputs.forEach(input=>{if(input.checked&&input.dataset.score!=="0"){total+=parseInt(input.dataset.score,10)}});totalScoreEl.textContent=total;updateRiskCategory(total)}
            function updateRiskCategory(score){riskCategoryEl.classList.remove('category-2','category-1','category-1-high','unsafe');let categoryKey='category-2';if(score>40){categoryKey='unsafe'}else if(score>=30){categoryKey='category-1-high'}else if(score>=12){categoryKey='category-1'}riskCategoryEl.textContent=categoryMap[categoryKey];riskCategoryEl.classList.add(categoryKey)}
            function copySummary(){emrSummaryEl.select();try{document.execCommand('copy');copySummaryButton.textContent='Copied!';setTimeout(()=>{copySummaryButton.textContent='Copy to Clipboard'},2000)}catch(err){alert('Could not copy text.')}}
            function handleFluidBalance(){const fbc24=parseFloat(safeGet('fbc_24hr_input')),fbcTotal=parseFloat(safeGet('fbc_total_input')),isSig=(!isNaN(fbc24)&&Math.abs(fbc24)>2000)||(!isNaN(fbcTotal)&&Math.abs(fbcTotal)>2000),isMild=(!isNaN(fbc24)&&Math.abs(fbc24)>1000)||(!isNaN(fbcTotal)&&Math.abs(fbcTotal)>1000);if(isSig)document.getElementById('fluid_sig_radio').checked=true;else if(isMild)document.getElementById('fluid_mild_radio').checked=true;else document.getElementById('fluid_0_radio').checked=true;calculateScore()}
            
            // --- Event Listeners ---
            resetButton.addEventListener('click', resetForm);
            generateSummaryButton.addEventListener('click', generateSummary);
            copySummaryButton.addEventListener('click', copySummary);
            addDrainButton.addEventListener('click', () => addDynamicInput(drainsContainer, 'Drain type & site...'));
            addWoundButton.addEventListener('click', () => addDynamicInput(woundsContainer, 'Wound location & description...'));
            addPivcButton.addEventListener('click', () => addDynamicInput(pivcsContainer, 'e.g., Pink 20G Lt forearm...'));
            [drainsContainer, woundsContainer, pivcsContainer].forEach(c => c.addEventListener('click', e => { if (e.target.classList.contains('remove-btn')) e.target.parentElement.remove(); }));
            bloodInputs.forEach(input => input.addEventListener('input', handleBloodInputs));
            scoreInputs.forEach(input => input.addEventListener('change', calculateScore));
            nursingConcernRadios.forEach(radio => radio.addEventListener('change', () => { nursingConcernText.style.display = safeIsChecked('concern_present') ? 'block' : 'none'; if (!safeIsChecked('concern_present')) nursingConcernText.value = ''; }));
            addsModCheckbox.addEventListener('change', () => { addsModDetails.classList.toggle('hidden', !addsModCheckbox.checked); calculateADDS(); });
            picsRadios.forEach(radio => radio.addEventListener('change', (e) => { picsUnableDetails.classList.toggle('hidden', e.target.value !== 'unable'); }));
            modParamCheckboxes.forEach(cb => { cb.addEventListener('change', (e) => { e.target.closest('.space-y-1').querySelector('.mod-details').classList.toggle('hidden', !e.target.checked); calculateADDS(); }); });
            modOperators.forEach(op => { op.addEventListener('change', (e) => { const param = e.target.dataset.param; const val2Container = document.getElementById(`mod_${param}_val2_container`); if (val2Container) { val2Container.style.display = e.target.value === 'between' ? 'inline' : 'none'; } calculateADDS(); }); });
            vitalInputs.forEach(i=>i.addEventListener('input', calculateADDS));
            document.getElementById('losDays').addEventListener('input', () => { const days = parseFloat(safeGet('losDays')); document.getElementById('losCheckbox').checked = days > 3; document.getElementById('losCheckbox').dispatchEvent(new Event('change')); });
            document.querySelectorAll('.fluid-input').forEach(i=>i.addEventListener('input', handleFluidBalance));

            // --- Initialise Form ---
            resetForm();
        });
    </script>
</body>
</html>
