<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALERT Nursing Risk Assessment Tool v4.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f0f9f9; --card:#ffffff; --ink:#111827; --muted:#4b5563; --accent:#007a7a;
      --red:#ef4444; --amber:#f59e0b; --green:#10b981; --line:#d1e3e3; --input-bg:#f8fbfb;
      --blue-hint:#2563eb; --toast-bg: rgba(0,0,0,0.8); --toast-color:#fff;
    }
    body.dark { --bg:#0b1112; --card:#0f1720; --ink:#e6eef0; --muted:#9aa9ad; --line:#132022; --input-bg:#071018; --toast-bg: rgba(255,255,255,0.06); --toast-color:#e6eef0; }
    html,body{height:100%}
    body{font-family:'Inter', system-ui, sans-serif; background:var(--bg); color:var(--ink); margin:0 0 220px 0; line-height:1.4; -webkit-font-smoothing:antialiased;}
    header{padding:14px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; flex-wrap:wrap; background: var(--card); z-index:30;}
    header h1 { font-size: 2.0rem; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; margin: 0; flex: 1; text-align: center; }
    header h1 .logo-em { color: var(--red); margin: 0 4px; font-weight: 800; }
    .header-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .top-meta { font-size:0.9rem; color:var(--muted); white-space:nowrap; }
    .last-saved { font-size:0.85rem; color:var(--muted); }
    .container{max-width:980px; margin:12px auto; padding:12px;}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); column-gap:12px; row-gap:18px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin-bottom:14px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);}
    .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    label{display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px; font-weight:500;}
    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); box-sizing:border-box;
      background:var(--input-bg); color:var(--ink); outline:none; font-size:1rem;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,122,0.12); }
    textarea{min-height:80px; resize:vertical; max-height:240px;}
    .concern-note { margin-top: 8px; }
    .concern-note textarea { min-height: 40px; font-size: 0.95rem; }
    
    .btn, .override-btn, .select-btn, .seg-btn { background-color: var(--bg); color: var(--muted); border: 1px solid var(--line); padding: 8px 12px; border-radius: 10px; cursor:pointer; font-weight: 600; transition: all 0.15s; min-height:44px; display:inline-flex; align-items:center; justify-content:center; gap:8px;}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent);}
    .btn.danger{background: transparent; color: var(--red); border-color: rgba(239,68,68,0.15); }
    .btn.small { padding: 6px 10px; font-size: 0.9rem; min-height:40px; }
    .override-btn:hover, .select-btn:hover, .seg-btn:hover { background-color: var(--line); }
    .override-btn.amber.active { background-color: var(--amber); color:white; border-color:var(--amber);}
    .override-btn.red.active { background-color: var(--red); color:white; border-color:var(--red); }
    .select-btn.active, .seg-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .select-btn.safe.active { background-color: var(--muted); border-color: var(--muted); color: #fff; opacity: 0.8; }
    .button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    
    .segmented-group { display: flex; width: 100%; max-width: 400px; background: var(--input-bg); border: 1px solid var(--line); border-radius: 10px; overflow: hidden; }
    .seg-btn { flex: 1; border: none; border-radius: 0; margin: 0; background: transparent; min-height: 44px; color: var(--muted); }
    .seg-btn:first-child { border-right: 1px solid var(--line); }
    .seg-btn[data-value="false"].active { background: var(--muted); opacity: 0.8; color: white; border-color: var(--muted); } 

    .toggle-label {
      display: flex; align-items: center; justify-content:space-between; gap:12px; background-color: var(--bg); padding: 12px; border-radius: 10px;
      border: 1px solid var(--line); cursor: pointer; transition: all 0.12s; margin-bottom: 8px; font-weight:600; color:var(--muted);
    }
    .toggle-label.active { background-color: var(--accent); color: white; border-color: var(--accent); }
    .toggle-label .state { font-weight:700; font-size:0.9rem; color:var(--muted); }
    .toggle-label.active .state { color: #fff; }

    .kpi{display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:12px;}
    .kpi .box{background:var(--bg); border:1px solid var(--line); padding:12px; border-radius:12px; text-align:center}
    #categoryBox { padding: 16px 12px; border-width: 2px; transition: border-color 0.2s; }
    #categoryBox h3 { font-size: 2.25rem; margin-top: 4px; font-weight: 800; }
    .kpi .box h3{margin:0; font-size:1.75rem}
    .kpi .box small{color:var(--muted); font-size: 0.9rem;}
    .status{font-weight:700}
    .status.red{color:var(--red)} .status.amber{color:var(--amber)} .status.green{color:var(--green)}
    .section-title{margin-bottom:12px; font-size:1.05rem; font-weight:700;}
    
    /* Standardized Question Styles */
    .question-row { display: block; margin-bottom: 24px; }
    .question-label { display: block; font-weight: 600; color: var(--muted); font-size: 0.95rem; margin-bottom: 8px; }
    .question-label small { display: block; font-weight: 400; font-size: 0.85rem; margin-top: 2px; }
    .sub-question-wrapper { margin-left: 18px; padding-left: 12px; border-left: 2px solid var(--line); margin-bottom: 12px; display: none; }
    .sub-question-wrapper.show { display: block; animation: fadeIn .2s; }
    
    .comorbidity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
    .bloods-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px 12px;}
    .blood-item { display: grid; grid-template-columns: 50px 1fr 80px; align-items: center; gap: 6px; position: relative;}
    .blood-item label { margin-bottom: 0; font-size:0.9rem; color:var(--muted); }
    .blood-item input { font-size:0.95rem; padding: 8px; }
    .trend-buttons { display: flex; justify-self: end;}
    .trend-btn { font-size: 0.9rem; border: 1px solid var(--line); background: transparent; border-radius: 6px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--muted); padding:0;}
    .trend-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .blood-abnormal { border-color: var(--red) !important; background-color: rgba(239,68,68,.06) !important; }
    .range-annotation { font-size: 0.75rem; color: var(--muted); position: absolute; bottom: -14px; left: 56px; display: none; }
    
    footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); border-top: 1px solid var(--line); padding: 8px 16px; display: flex; flex-wrap:wrap; align-items: center; justify-content: space-between; gap: 8px 12px; box-sizing: border-box; z-index:25; }
    .footer-item { color: var(--muted); font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
    .footer-item.reason { flex: 1 1 auto; min-width: 120px; }
    .footer-score { padding: 6px 12px; border-radius: 8px; font-weight: 700; text-align: center; flex-shrink: 0;}
    .footer-buttons { display:flex; gap: 8px; }
    
    .tag{display:inline-flex; align-items:center; padding: 4px 10px; border-radius:999px; font-size:.85rem; margin:2px; border:1px solid; font-weight:600;}
    .tag.red{background:rgba(239,68,68,.08); color:var(--red); border-color:rgba(239,68,68,.2)}
    .tag.amber{background:rgba(245,158,11,.08); color:var(--amber); border-color:rgba(245,158,11,.18)}
    .tag.green{background:rgba(16,185,129,.07); color:var(--green); border-color:rgba(16,185,129,.12)}
    
    hr { border: none; height: 1px; background-color: var(--line); margin: 24px 0 18px 0; }
    .optional-note { text-align:center; color: var(--muted); font-size: 0.9rem; margin: 18px 0; }
    
    .accordion-wrapper { border: 1px solid var(--line); border-radius: 12px; overflow:hidden; margin-bottom: 12px;}
    .accordion { background-color: transparent; color: var(--ink); cursor: pointer; padding: 14px; width: 100%; border: none; border-bottom: 1px solid var(--line); text-align: left; outline: none; font-size: 1rem; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    .accordion .icon { color: var(--muted); font-size:0.9rem; margin-left:8px; }
    .panel { padding: 14px; background-color: transparent; display: none; overflow: hidden; }
    
    .device-entry { background: var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; margin-bottom:10px; display:flex; flex-direction:column; gap:8px; }
    .device-entry textarea { width:100%; min-height:44px; font-size:1rem; background:var(--input-bg); }
    .remove-entry { background: transparent; border:1px solid rgba(239,68,68,0.12); color:var(--red); border-radius:8px; padding:8px; cursor:pointer; text-align:center; font-weight:700; }
    
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:110px; background:var(--toast-bg); color:var(--toast-color); padding:10px 14px; border-radius:8px; z-index:60; display:none; font-weight:600; text-align: center; }
    .toast.show { display:block; animation: fadeIn .18s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateX(-50%) translateY(6px); } to { opacity:1; transform:translateX(-50%) translateY(0);} }
    
    /* Vitals & A-E specific */
    .quick-select-group { margin-bottom: 6px; }
    .btn.quick-select { padding: 4px 8px; font-size: 0.8rem; min-height: 28px; background: var(--bg); border-color: var(--line); color: var(--muted); font-weight: 500; }
    .btn.quick-select:hover { background: var(--line); }
    .input-with-trend { display: grid; grid-template-columns: 1fr 80px; gap: 6px; align-items: center; }
    .input-with-trend .trend-buttons { justify-self: end; }
    .quick-select-container { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap;}

    /* A-E Alignment Fix */
    #panel_ae .col-3, #panel_ae .col-4, #panel_ae .col-12 {
        display: flex;
        flex-direction: column;
        justify-content: flex-start; 
        height: 100%;
    }

    .flag-red { box-shadow: 0 0 0 2px var(--red); }
    .flag-amber { box-shadow: 0 0 0 2px var(--amber); }

    @media (max-width:900px){
      .col-2,.col-3,.col-4,.col-6,.col-8{grid-column:span 12}
      .grid { column-gap:10px; row-gap:12px; }
      input, textarea { font-size:1.05rem; padding:12px; }
      .btn, .select-btn, .seg-btn { padding:10px 12px; font-size:1rem; min-height:48px; }
      .segmented-group { max-width: 100%; }
    }
  </style>
</head>
<body>
<header role="banner">
  <h1><span class="logo-em">!</span> ALERT <span class="logo-em">!</span> <br> Nursing Risk Assessment Tool</h1>
  <div class="header-controls">
    <div style="display:flex; gap:8px;">
        <button class="btn small" id="darkToggle" aria-pressed="false">Dark mode</button>
        <button class="btn danger small" id="clearDataBtnTop">Clear Data / Next Patient</button>
    </div>
    <div class="top-meta last-saved" id="lastSaved">Last saved: --:--</div>
  </div>
</header>

<main class="container" role="main">
  <div class="card" aria-labelledby="patientHeading">
    <div class="grid">
       <div class="col-6">
        <label>Clinician Role</label>
        <div style="display:flex; gap:8px; padding-top:6px;">
          <label style="font-weight:500"><input type="radio" name="clinicianRole" value="ALERT CNS" checked> CNS</label>
          <label style="font-weight:500"><input type="radio" name="clinicianRole" value="ALERT CN"> CN</label>
        </div>
      </div>
       <div class="col-6">
        <label>Review Type</label>
        <div style="display:flex; gap:8px; padding-top:6px;">
          <label style="font-weight:500"><input type="radio" name="reviewType" value="pre"> Pre-Stepdown</label>
          <label style="font-weight:500"><input type="radio" name="reviewType" value="post" checked> Post-Stepdown</label>
        </div>
      </div>
      <div class="col-6"><label for="ptName">Patient Initials</label><input id="ptName" type="text" autocomplete="off" /></div>
      <div class="col-6"><label for="ptMrn">Last 3 digits of URN</label><input id="ptMrn" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="3" autocomplete="off" /></div>
      
      <div class="col-3"><label for="ptAge">Age</label><input id="ptAge" type="number" min="0" /></div>
      <div class="col-3"><label for="icuLos">ICU LOS (days)</label><input id="icuLos" type="number" min="0" /></div>
      
      <div class="col-6">
          <label for="ptWard">Ward</label>
          <select id="ptWard">
              <option value="" selected disabled>Select Ward...</option>
          </select>
      </div>
      <div class="col-2">
          <label for="ptBed">Bed</label>
          <input id="ptBed" type="number" min="1" />
      </div>
      <div class="col-6" id="ptWardOtherWrapper" style="display:none;">
          <label for="ptWardOther">Specify Other Ward</label>
          <input id="ptWardOther" type="text" />
      </div>
      <div class="col-12"><label for="ptAdmissionReason">Reason for ICU Admission</label><input id="ptAdmissionReason" type="text" /></div>
      <div class="col-4"><label>Stepdown Date</label><input type="date" id="stepdownDate"></div>
      <div class="col-8">
        <label>Stepdown Time</label>
        <div class="button-group" id="stepdownTime" role="tablist">
          <button class="select-btn" data-value="Morning">Morning</button>
          <button class="select-btn" data-value="Afternoon">Afternoon</button>
          <button class="select-btn" data-value="Evening">Evening</button>
          <button class="select-btn" data-value="Night">Night</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    
    <div class="question-row">
        <div class="question-label">ADDS</div>
        <input id="adds" type="number" min="0" max="10" />
    </div>
    
    <div class="question-row">
        <div class="question-label">Lactate (mmol/L)</div>
        <input id="lactate" type="number" step="0.1" min="0"/>
    </div>

    <div class="question-row">
        <div class="grid">
            <div class="col-6">
                <div class="question-label">Hb (g/L)</div>
                <input id="hb" type="number" step="1" min="0"/>
            </div>
            <div class="col-6" style="align-self: end;">
                <div class="segmented-group" id="seg_hb_dropping" style="height: 44px;">
                   <button class="seg-btn" data-value="true">Hb Dropping</button>
                   <button class="seg-btn" data-value="false">Stable</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="question-row">
      <div class="question-label">Oxygen Modality?</div>
      <div class="button-group" id="oxMod" role="tablist">
        <button class="select-btn safe" data-value="RA">Room Air</button>
        <button class="select-btn" data-value="NP">Nasal Prongs</button>
        <button class="select-btn" data-value="HFNP">HFNP</button>
        <button class="select-btn" data-value="NIV">NIV</button>
        <button class="select-btn" data-value="Trache">Trache / Lary</button>
      </div>

      <div class="grid">
        <div class="col-6 npOnly" style="display:none"><label for="npFlow">NP Flow (L/min)</label><input id="npFlow" type="number" step="0.5" min="0" /></div>
        <div class="col-3 hfnpOnly" style="display:none"><label for="hfnpFio2">HFNP FiO2 (%)</label><input id="hfnpFio2" type="number" step="1" min="21" max="100" /></div>
        <div class="col-3 hfnpOnly" style="display:none"><label for="hfnpFlow">HFNP Flow (L/min)</label><input id="hfnpFlow" type="number" step="1" min="0" /></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivFio2">FiO2 (%)</label><input id="nivFio2" type="number" min="21" max="100"/></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivPeep">PEEP</label><input id="nivPeep" type="number" min="0"/></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivPs">PS</label><input id="nivPs" type="number" min="0"/></div>
      </div>
      
      <div class="grid tracheOnly" style="display:none; margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px;">
          <div class="col-12"><label>Tracheostomy / Laryngectomy Details</label></div>
          <div class="col-6">
              <label>Type</label>
              <div class="button-group" id="tracheType" role="tablist">
                  <button class="select-btn" data-value="Tracheostomy">Tracheostomy</button>
                  <button class="select-btn" data-value="Laryngectomy">Laryngectomy</button>
              </div>
          </div>
          <div class="col-6">
              <label>Status</label>
              <div class="button-group" id="tracheStatus" role="tablist">
                  <button class="select-btn" data-value="Stable">Long-term / Stable</button>
                  <button class="select-btn" data-value="New">New / Unstable</button>
              </div>
          </div>
          <div class="col-12" style="margin-top: 8px;">
              <label for="trache_details_note">Optional Airway Details</label>
              <textarea id="trache_details_note" placeholder="e.g., size, cuffed/uncuffed, date of change..."></textarea>
          </div>
      </div>
    </div>

    <div class="question-row">
      <div class="question-label">Respiratory Concern?</div>
        <div class="button-group" id="dyspneaConcern">
          <button class="select-btn safe" data-value="none">None</button>
          <button class="select-btn" data-value="mild">Mild</button>
          <button class="select-btn" data-value="mod">Moderate</button>
          <button class="select-btn" data-value="severe">Severe</button>
        </div>
        <div id="dyspneaConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="dyspneaConcern_note" placeholder="Optional: e.g., tachypnea, increased WOB, dyspnea"></textarea>
        </div>
    </div>
    
    <div class="question-row">
      <div class="question-label">Neurological Concern?</div>
      <div class="button-group" id="neuroConcern">
        <button class="select-btn safe" data-value="none">None</button>
        <button class="select-btn" data-value="mild">Mild</button>
        <button class="select-btn" data-value="mod">Moderate</button>
        <button class="select-btn" data-value="severe">Severe</button>
      </div>
      <div class="button-group" id="neuroType" style="display:none; margin-top:8px;">
          <button class="select-btn small" data-value="Confusion">Confusion</button>
          <button class="select-btn small" data-value="Delirium">Delirium</button>
          <button class="select-btn small" data-value="Other">Other</button>
      </div>
      <div id="neuroConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="neuroConcern_note" placeholder="Optional: Specific details (e.g. GCS 13). Typing here overrides the label."></textarea>
      </div>
    </div>
    
    <div class="question-row">
      <div class="question-label">Electrolyte Concern?</div>
      <div class="button-group" id="electrolyteConcern" role="tablist">
        <button class="select-btn safe" data-value="none">None</button>
        <button class="select-btn" data-value="mild">Mild/moderate</button>
        <button class="select-btn" data-value="severe">Severe</button>
      </div>
       <div id="electrolyteConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="electrolyteConcern_note" placeholder="Optional: enter details (e.g., Na 128, K 2.9)"></textarea>
      </div>
    </div>
    
    <div class="question-row">
        <div class="question-label">Discharged after-hours? <small>(Home team not on ward OR reduced nursing ratio/overnight)</small></div>
        <div class="segmented-group" id="seg_after_hours">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="after_hours_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="after_hours_note" placeholder="Optional: enter details"></textarea>
    </div>

    <div class="question-row">
        <div class="question-label">Vasopressors in last 24h?</div>
        <div class="segmented-group" id="seg_pressors">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div class="sub-question-wrapper" id="sub_pressors_reason">
        <label>Reason for vasopressors?</label>
        <div class="button-group" id="pressorReason">
            <button class="select-btn small" data-value="routine">Routine / Short term (elective/planned)</button>
            <button class="select-btn small" data-value="shock">Medical shock / Prolonged / Complicated</button>
        </div>
    </div>
    <div id="pressors_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="pressors_note" placeholder="Optional: enter details of vasopressor use"></textarea>
    </div>

    <div class="question-row">
        <div class="question-label">Historical O2: NP ≥3L, HFNP >30%, or NIV in last 12h?</div>
        <div class="segmented-group" id="seg_hist_o2">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="hist_o2_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="hist_o2_note" placeholder="Optional: enter details"></textarea>
    </div>

    <div class="question-row">
        <div class="question-label">Intubated in last 24h?</div>
        <div class="segmented-group" id="seg_intubated">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div class="sub-question-wrapper" id="sub_intubated_reason">
        <label>Intubation Context?</label>
        <div class="button-group" id="intubatedReason">
            <button class="select-btn small" data-value="routine">Routine/Elective (no lasting concerns)</button>
            <button class="select-btn small" data-value="concern">Complicated / Concerns</button>
        </div>
        <label style="margin-top:8px;">Intubation Details</label>
        <textarea id="intubation_details" placeholder="Tube size, grade, specific issues..."></textarea>
    </div>

    <div class="question-row">
        <div class="question-label">Rapid oxygen wean in last 12h?</div>
        <div class="segmented-group" id="seg_rapid_wean">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="rapid_wean_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="rapid_wean_note" placeholder="Optional: enter details"></textarea>
    </div>
    
    <div class="question-row">
        <div class="question-label">Renal Concern? <small>(AKI, rising Cr, or ESRD/dialysis)</small></div>
        <div class="segmented-group" id="seg_renal">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="renal_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="renal_note" placeholder="Optional: enter details"></textarea>
    </div>

    <div class="question-row">
        <div class="question-label">UOP concerning / downtrending? <small>(&lt;0.5 mL/kg/hr)</small></div>
        <div class="segmented-group" id="seg_uop">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="uop_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
         <textarea id="uop_note" placeholder="Optional: enter urine output details"></textarea>
    </div>
    
    <div class="question-row">
        <div class="question-label">Immobility >48h?</div>
        <div class="segmented-group" id="seg_immobility">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="immobility_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
        <textarea id="immobility_note" placeholder="Optional: enter details"></textarea>
    </div>
    
    <div class="question-row">
        <div class="question-label">Infection Concern?</div>
        <div class="segmented-group" id="seg_infection">
            <button class="seg-btn" data-value="true">Yes</button>
            <button class="seg-btn" data-value="false">No</button>
        </div>
    </div>
    <div id="infection_note_wrapper" class="concern-note" style="display:none; margin-bottom:12px;">
        <textarea id="infection_note" placeholder="Optional: enter details"></textarea>
        <div id="infectionMarkers" style="margin-top:12px; padding:12px; border-radius:10px; background:var(--bg)">
            <label style="margin-bottom:8px; display:block; font-weight:600;">Optional: Enter Infection Markers</label>
            <div class="grid">
              <div class="col-4" style="position: relative;"><label for="wcc">WCC (x10^9/L)</label><input id="wcc" type="number" step="0.1" /><span id="wcc_range" class="range-annotation" style="left:0;"></span></div>
              <div class="col-4" style="position: relative;"><label for="crp">CRP (mg/L)</label><input id="crp" type="number" step="1" /><span id="crp_range" class="range-annotation" style="left:0;"></span></div>
              <div class="col-4">
                <label for="neut">Neut / Lymph (NLR)</label>
                <div style="position: relative; margin-bottom: 22px;">
                    <input id="neut" type="number" step="0.1" placeholder="Neut" />
                    <span id="neut_range" class="range-annotation" style="left: 0; bottom: -16px;"></span>
                </div>
                <div style="position: relative; margin-bottom: 22px;">
                    <input id="lymph" type="number" step="0.1" placeholder="Lymph" />
                     <span id="lymph_range" class="range-annotation" style="left: 0; bottom: -16px;"></span>
                </div>
                <div id="nlrCalc" style="margin-top:6px; font-size:0.9rem; color:var(--muted)">NLR: --</div>
              </div>
            </div>
        </div>
    </div>
    
    <div class="input-group">
      <div class="section-title">Concerning Comorbidities?</div>
      <div class="comorbidity-grid">
        <div class="toggle-label" id="toggle_comorb_copd" data-value="false" role="button" aria-pressed="false">COPD/Asthma <span class="state"></span></div>
        <div class="toggle-label" id="toggle_comorb_hf" data-value="false" role="button" aria-pressed="false">Active HF <span class="state"></span></div>
        <div class="toggle-label" id="toggle_comorb_esrd" data-value="false" role="button" aria-pressed="false">ESRD/Dialysis <span class="state"></span></div>
        <div class="toggle-label" id="toggle_comorb_diabetes" data-value="false" role="button" aria-pressed="false">Diabetes (Uncontrolled) <span class="state"></span></div>
        <div class="toggle-label" id="toggle_comorb_cirrhosis" data-value="false" role="button" aria-pressed="false">Cirrhosis <span class="state"></span></div>
        <div class="toggle-label" id="toggle_comorb_other" data-value="false" role="button" aria-pressed="false">Other <span class="state"></span></div>
      </div>
      <div id="comorb_other_note_wrapper" class="concern-note" style="display:none; margin-top: 10px;">
          <label for="comorb_other_note">Specify other comorbidity</label>
          <textarea id="comorb_other_note" placeholder="Enter details..."></textarea>
      </div>
    </div>

    <div class="section-title">Clinical Judgement Override?</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <button class="override-btn red" id="override_red">Upgrade to CAT 1</button>
      <button class="override-btn amber" id="override_amber">Upgrade to CAT 2</button>
      <button class="override-btn" id="override_clear">Clear Override</button>
    </div>
    <input type="hidden" id="override" value="none">
    <div id="override_reason_box" style="display:none;"><label>Reason for override</label><input id="overrideNote" type="text"/></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box" id="categoryBox"><h3 id="catText" class="status green">CAT 3</h3></div>
      <div class="box"><small>CAT 1 Flags</small><h3 id="redCount">0</h3></div>
      <div class="box"><small>CAT 2 Flags</small><h3 id="amberCount">0</h3></div>
    </div>
    <hr>
    <div class="section-title">Identified Risk Factors</div>
    <div id="flagList" style="margin-top:12px; min-height:28px; color:var(--muted);"></div>
    <hr>
    <div class="section-title">Follow-up Plan</div>
    <div id="followUpInstructions" style="margin-top:12px; font-weight: 500;"></div>
    <div id="dischargeNudge" style="font-size: 0.9rem; color: var(--blue-hint); font-weight: 600; margin-top: 15px; display: none;"></div>
    
    <div style="margin-top:18px;">
        <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; color: var(--blue-hint); margin-bottom: 12px;">
            <input type="checkbox" id="chk_discharge_alert" style="width:auto; transform:scale(1.2);">
            Discharge from ALERT list?
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer;">
            <input type="checkbox" id="chk_medical_rounding" style="width:auto; transform:scale(1.2);">
            Add to ALERT Medical Rounding List
        </label>
    </div>

  </div>

  <div class="optional-note">The following sections are optional DMR note helpers</div>

  <div class="accordion-wrapper" data-accordion-id="ae">
    <button class="accordion" aria-expanded="false" aria-controls="panel_ae">A-E Assessment <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_ae">
      <div class="grid">
        <div class="col-12">
            <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer;">
                <input type="checkbox" id="chk_use_mods" style="width:auto; transform:scale(1.2);">
                MODS in place?
            </label>
        </div>
        <div class="col-12" id="mods_inputs" style="display:none;">
          <div class="grid">
            <div class="col-12"><label for="mods_score">MODS Score</label><input id="mods_score" type="text" placeholder="Enter score (overrides ADDS)..."/></div>
            <div class="col-12"><label for="mods_details">MODS Details</label><input id="mods_details" type="text" placeholder="Enter details..."/></div>
          </div>
        </div>
        <div class="col-12" id="adds_input_container"><label for="atoe_adds">ADDS</label><input id="atoe_adds" type="number"/></div>

        <div class="col-12">
            <label for="airway_a">A: Airway</label>
            <input id="airway_a" type="text" placeholder="" data-manual="false"/>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" data-target="airway_a" data-value="Patent">Patent</button>
            </div>
        </div>
        <div class="col-3">
            <label for="b_rr">B: RR</label>
            <div class="input-with-trend">
                <input id="b_rr" type="text" placeholder=""/>
                <div class="trend-buttons" id="b_rr_trend"></div>
            </div>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" data-target="b_rr" data-value="15-20">RR 15-20</button>
            </div>
        </div>
        <div class="col-3">
            <label for="b_spo2">SpO2 (%)</label>
            <input id="b_spo2" type="text" placeholder=""/>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" data-target="b_spo2" data-value=">94%">SpO2 >94%</button>
            </div>
        </div>
        <div class="col-3"><label for="b_device">Device</label><input id="b_device" type="text" placeholder="" data-manual="false"/></div>
        
        <div class="col-3"><label for="b_wob">WOB</label><input id="b_wob" type="text" placeholder="Description..."/></div>

        <div class="col-3">
            <label for="c_hr">C: HR</label>
            <div class="input-with-trend">
                <input id="c_hr" type="text" placeholder="Rate"/>
                <div class="trend-buttons" id="c_hr_trend"></div>
            </div>
            <div class="quick-select-container">
               <button type="button" class="btn small quick-select" onclick="$('c_hr_rhythm').value='Regular';$('c_hr_rhythm').dispatchEvent(new Event('input'));">Regular</button>
               <button type="button" class="btn small quick-select" onclick="$('c_hr_rhythm').value='Irregular';$('c_hr_rhythm').dispatchEvent(new Event('input'));">Irregular</button>
            </div>
            <input id="c_hr_rhythm" type="text" placeholder="Rhythm..." style="margin-top:4px;" />
        </div>
        <div class="col-3">
            <label for="c_nibp">NIBP</label>
            <div class="input-with-trend">
                <input id="c_nibp" type="text" placeholder=""/>
                <div class="trend-buttons" id="c_nibp_trend"></div>
            </div>
        </div>
        <div class="col-3"><label for="c_cr">Cap Refill</label><input id="c_cr" type="text" placeholder=""/></div>
        <div class="col-3"><label for="c_perf">Perfusion</label><input id="c_perf" type="text" placeholder=""/></div>

        <div class="col-4">
            <label for="d_alert">D: Alert?</label>
            <input id="d_alert" type="text" placeholder=""/>
             <div class="quick-select-container">
                <button type="button" class="btn small quick-select" onclick="stackText('d_alert', 'Alert')">Alert</button>
                <button type="button" class="btn small quick-select" onclick="stackText('d_alert', 'GCS 15')">GCS 15</button>
                <button type="button" class="btn small quick-select" onclick="stackText('d_alert', 'AMT 4/4')">AMT 4/4</button>
            </div>
        </div>
        
        <div class="col-4"><label for="d_pain">Pain</label><input id="d_pain" type="text" placeholder=""/></div>
        <div class="col-4"></div>

        <div class="col-4">
            <label for="e_temp">E: Temp</label>
            <input id="e_temp" type="text" placeholder=""/>
             <div class="quick-select-container">
                <button type="button" class="btn small quick-select" data-target="e_temp" data-value="Afebrile">Afebrile</button>
            </div>
        </div>
        <div class="col-4"><label for="e_bsl">BSL</label><input id="e_bsl" type="text" placeholder=""/></div>
        <div class="col-4"><label for="e_uop">UOP</label><input id="e_uop" type="text" placeholder=""/></div>

        <div class="col-12"><hr></div>
        
        <div class="col-12">
            <label for="ae_mobility">Mobility/MSK</label>
            <input id="ae_mobility" type="text" placeholder="Current mobility level"/>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" onclick="stackText('ae_mobility', 'Independent')">Independent</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_mobility', '1x Assist')">1x Assist</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_mobility', '2x Assist')">2x Assist</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_mobility', 'RIB')">RIB</button>
            </div>
        </div>
        
        <div class="col-12">
            <label for="ae_diet">Diet</label>
            <input id="ae_diet" type="text" placeholder="Current diet/fluids"/>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'Normal')">Normal</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'Clear Fluids')">Clear Fluids</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'Nourishing Fluids')">Nourishing Fluids</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'NBM')">NBM</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'TPN')">TPN</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'PPN')">PPN</button>
                <button type="button" class="btn small quick-select" onclick="stackText('ae_diet', 'NG Feed')">NG Feed</button>
            </div>
        </div>
        
        <div class="col-12">
            <label for="ae_bowels">Bowels</label>
            <input id="ae_bowels" type="text" placeholder="Note details..."/>
            <div class="quick-select-container">
                <button type="button" class="btn small quick-select" id="btn_bno">BNO</button>
                <button type="button" class="btn small quick-select" id="btn_bo">BO</button>
            </div>
            <div id="bowel_date_wrapper" style="display:none; margin-top:8px;">
                <div style="display:flex; gap:12px; align-items:center;">
                    <div style="flex:1;">
                        <label id="bowel_date_label" style="font-size:0.85rem; color:var(--accent);">Date</label>
                        <input type="date" id="bowel_date">
                    </div>
                    <div id="aperients_wrapper" style="display:none; flex:1; padding-top:20px;">
                         <label style="display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer; font-size:0.9rem;">
                            <input type="checkbox" id="chk_aperients" style="width:auto; transform:scale(1.1);">
                            Aperients charted?
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
      </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="bloods">
    <button class="accordion" aria-expanded="false" aria-controls="panel_bloods">Bloods <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_bloods">
      <div class="bloods-grid">
        <div class="blood-item"><label for="bl_lac_review">Lac</label><input id="bl_lac_review" type="number" step="0.1"/><div class="trend-buttons" id="bl_lac_review_trend"></div><span id="bl_lac_review_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_hb">Hb</label><input id="bl_hb" type="number"/><div class="trend-buttons" id="bl_hb_trend"></div><span id="bl_hb_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_wcc">WCC</label><input id="bl_wcc" type="number" step="0.1"/><div class="trend-buttons" id="bl_wcc_trend"></div><span id="bl_wcc_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_crp">CRP</label><input id="bl_crp" type="number"/><div class="trend-buttons" id="bl_crp_trend"></div><span id="bl_crp_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_cr_review">Cr</label><input id="bl_cr_review" type="number"/><div class="trend-buttons" id="bl_cr_review_trend"></div><span id="bl_cr_review_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_k">K</label><input id="bl_k" type="number" step="0.1"/><div class="trend-buttons" id="bl_k_trend"></div><span id="bl_k_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_na">Na</label><input id="bl_na" type="number" step="1"/><div class="trend-buttons" id="bl_na_trend"></div><span id_=""bl_na_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_mg">Mg</label><input id="bl_mg" type="number" step="0.1"/><div class="trend-buttons" id="bl_mg_trend"></div><span id="bl_mg_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_phos">PO4</label><input id="bl_phos" type="number" step="0.1"/><div class="trend-buttons" id="bl_phos_trend"></div><span id="bl_phos_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_plts">Plts</label><input id="bl_plts" type="number"/><div class="trend-buttons" id="bl_plts_trend"></div><span id="bl_plts_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_alb">Alb</label><input id="bl_alb" type="number"/><div class="trend-buttons" id="bl_alb_trend"></div><span id="bl_alb_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_neut">Neut</label><input id="bl_neut" type="number" step="0.1"/><div class="trend-buttons" id="bl_neut_trend"></div><span id="bl_neut_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_lymph">Lymph</label><input id="bl_lymph" type="number" step="0.1"/><div class="trend-buttons" id="bl_lymph_trend"></div><span id="bl_lymph_range" class="range-annotation"></span></div>
      </div>
      
      <div class="grid" id="infusions_wrapper" style="display:none; margin-top: 12px; row-gap: 8px;">
          <div class="col-12"><label for="infusions_note">Infusions</label><input id="infusions_note" type="text" placeholder="Note active infusions..."/></div>
      </div>

      <div style="margin-top:12px" class="grid">
        <div class="col-12"><label>Electrolyte Plan</label><input id="elec_replace_note" type="text" placeholder="Replacement plan..."/></div>
        <div class="col-12" style="margin-top:8px">
             <div class="segmented-group" id="seg_new_bloods_ordered">
                <button class="seg-btn" style="flex:3; text-align:left; padding-left:12px; pointer-events:none;">New bloods ordered?</button>
                <button class="seg-btn" data-value="true">Yes</button>
                <button class="seg-btn" data-value="false">No</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="devices">
    <button class="accordion" aria-expanded="false" aria-controls="panel_devices">Lines, Drains & Wounds <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_devices" style="display:flex; flex-direction:column; gap: 12px;">
       <div id="devices-container"></div>
       <div class="button-group" style="justify-content: flex-start; flex-wrap: wrap;">
           <button class="btn small" data-device-type="CVC">+ Add CVC</button>
           <button class="btn small" data-device-type="Other CVAD">+ Add Other CVAD</button>
           <button class="btn small" data-device-type="PIVC">+ Add PIVC</button>
           <button class="btn small" data-device-type="Enteral Tube">+ Add Enteral Tube</button>
           <button class="btn small" data-device-type="IDC">+ Add IDC</button>
           <button class="btn small" data-device-type="Pacing Wire">+ Add Pacing Wire</button>
           <button class="btn small" data-device-type="Drain">+ Add Drain</button>
           <button class="btn small" data-device-type="Wound">+ Add Wound</button>
           <button class="btn small" data-device-type="Other Device">+ Add Other Device</button>
       </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="context">
    <button class="accordion" aria-expanded="false" aria-controls="panel_context">Other Factors <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_context">
        <div class="devices-subtitle">▶ Goals of Care (GOC)</div>
        <div class="devices-input-group">
            <textarea id="goc_note" placeholder="GOC / Resuscitation Status"></textarea>
        </div>

        <div class="devices-subtitle">▶ Allergies</div>
        <div class="devices-input-group">
            <textarea id="allergies_note" placeholder="List any known allergies"></textarea>
        </div>
        
        <div class="devices-subtitle">▶ Significant Past Medical History (PMH)</div>
        <div class="devices-input-group">
            <textarea id="pmh_note" placeholder="Enter PMH here..."></textarea>
        </div>

        <div class="devices-subtitle">▶ PICS Assessment</div>
        <div class="devices-input-group">
            <textarea id="pics_note" placeholder="Note PICS assessment"></textarea>
        </div>

        <div class="devices-subtitle">▶ Other</div>
        <div class="devices-input-group">
            <textarea id="context_other_note" placeholder="Hometeam plan, other notes"></textarea>
        </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Auto-Generated Summary</div>
    <textarea id="summary" placeholder="Summary will auto-generate here..." style="min-height:240px; font-family:ui-monospace,monospace;"></textarea>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" id="copyBtn">Copy Summary</button>
      <button class="btn danger" id="clearDataBtnBottom">Clear Data / Next Patient</button>
    </div>
  </div>
  
  <div style="text-align:center; color: var(--muted); font-weight: 600; margin: 24px 0; letter-spacing: 1px;">- END ASSESSMENT -</div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<footer role="contentinfo">
  <div class="footer-item"><strong>Patient:</strong> <span id="footerName">--</span></div>
  <div class="footer-item"><strong>Room:</strong> <span id="footerLocation">--</span></div>
  <div class="footer-item reason"><strong>Reason:</strong> <span id="footerAdmission">--</span></div>
  <div id="footerScore" class="footer-score tag green">CAT 3</div>
  <div class="footer-buttons">
      <button class="btn primary" id="footerSave">Save</button>
      <button class="btn" id="footerCopy">Copy</button>
      <button onclick="openRedcapAccelerator()" class="btn" style="background-color:#d9534f; color:white; border:none; margin-left:8px;">
          Copy to REDCap
      </button>
  </div>
</footer>

<script>
/* ===========================
   Utilities & State
   =========================== */
const $ = id => document.getElementById(id);
const debounce = (fn, wait=350) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; };
const computeAllAndSave = ()=>{ computeAll(); saveState(true); };
const num = v => { const x = parseFloat(v); return isNaN(x) ? null : x; };
const STORAGE_KEY = 'alertNursingToolData_v3.8';
const ACCORDION_KEY = 'alertNursingToolAccordions_v3.8';
const UNDO_KEY = 'alertNursingToolUndo_v3.8';
const normalRanges = {
  wcc: { low: 4, high: 11 }, crp: { low: 0, high: 50 },
  neut: { low: 1.5, high: 7.5 }, lymph: { low: 1.0, high: 4.0 },
  hb: { low: 115, high: 165 }, plts: { low: 150, high: 400 },
  k: { low: 3.5, high: 5.2 }, na: { low: 135, high: 145 },
  cr_review: { low: 50, high: 98 },
  mg: { low: 0.7, high: 1.1 }, alb: { low: 35, high: 50 },
  lac_review: { low: 0.5, high: 2.0 },
  phos: { low: 0.8, high: 1.5 }
};

/* fields to automatically save/restore */
const staticInputs = [
  'ptName','ptMrn','ptAge','ptWard','ptBed','ptWardOther','ptAdmissionReason','icuLos','stepdownDate',
  'npFlow','hfnpFio2','hfnpFlow','nivFio2', 'nivPeep', 'nivPs','override','overrideNote',
  'trache_details_note',
  'mods_score','mods_details','airway_a','b_rr','b_spo2','b_device','b_wob',
  'c_hr','c_hr_rhythm','c_nibp','c_cr','c_perf','d_alert','d_pain','e_temp','e_bsl','e_uop','atoe_adds',
  'ae_mobility','ae_diet','ae_bowels','bowel_date',
  'bl_wcc','bl_crp','bl_neut','bl_lymph',
  'bl_hb','bl_plts','bl_k','bl_na',
  'bl_cr_review','bl_mg','bl_alb','bl_lac_review','bl_phos',
  'elec_replace_note', 'goc_note', 'allergies_note', 'pics_note', 'context_other_note', 'pmh_note',
  'adds','lactate','hb','wcc','crp','neut','lymph', 'infusions_note',
  'dyspneaConcern_note', 'renalConcern_note', 'uopLow_note', 'neuroConcern_note', 'infectionConcern_note',
  'electrolyteConcern_note',
  'after_hours_note', 'pressors_note', 'hist_o2_note', 'rapid_wean_note', 'immobility_note', 'comorb_other_note',
  'intubation_details'
];

// Replaced simple toggles with Segmented Controls. We need to save their 'value' (true/false/null).
const segmentedInputs = [
  'hb_dropping', 'after_hours', 'pressors', 'hist_o2', 'intubated', 'rapid_wean',
  'renal', 'uop', 'immobility', 'infection', 'new_bloods_ordered'
];

// Simple Toggles (Comorbidities)
const toggleInputs = [
  'comorb_copd','comorb_hf','comorb_esrd','comorb_diabetes','comorb_cirrhosis', 'comorb_other'
];

const selectInputs = [
    'oxMod','dyspneaConcern','neuroConcern','neuroType','electrolyteConcern','stepdownTime', 
    'tracheType', 'tracheStatus', 'pressorReason', 'intubatedReason'
];
const deviceTypes = ['CVC', 'Other CVAD', 'PIVC', 'Enteral Tube', 'IDC', 'Pacing Wire', 'Drain', 'Wound', 'Other Device'];


/* ---------------------------
   Persistence helpers
   --------------------------- */
function nowTimeStr() {
  const d = new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function showToast(msg, timeout=2500, actionText=null, actionCallback=null) {
  const t = $('toast');
  t.innerHTML = msg;
  if (actionText && actionCallback) {
    const btn = document.createElement('button');
    btn.textContent = actionText;
    btn.className = 'btn small';
    btn.style.marginLeft = '12px';
    btn.addEventListener('click', actionCallback);
    t.appendChild(btn);
  }
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), timeout);
}
function saveState(instantly=false) {
  const state = getState();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  localStorage.setItem('alertNursingToolLastSaved', new Date().toISOString());
  updateLastSaved();
}
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e){ return null; }
}
function pushUndo(snapshot) {
  try {
    localStorage.setItem(UNDO_KEY, JSON.stringify({ snapshot, created: Date.now() }));
  } catch(e){}
}
function popUndo() {
  try {
    const raw = localStorage.getItem(UNDO_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    const age = Date.now() - (obj.created || 0);
    if (age > 10000) { localStorage.removeItem(UNDO_KEY); return null; }
    localStorage.removeItem(UNDO_KEY);
    return obj.snapshot;
  } catch(e){ return null; }
}
function updateLastSaved() {
  const iso = localStorage.getItem('alertNursingToolLastSaved');
  if (!iso) { $('lastSaved').textContent = 'Last saved: --:--'; return; }
  const t = new Date(iso);
  $('lastSaved').textContent = 'Last saved: ' + t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

/* ===========================
   DOM Helpers for Dynamic lists
   =========================== */
function createDeviceEntry(type, value = '') {
    const container = $('devices-container');
    const div = document.createElement('div');
    div.className = 'device-entry';
    div.dataset.type = type;
    div.innerHTML = `
        <label>${type}</label>
        <div style="display: flex; gap: 8px; align-items: center;">
            <textarea style="flex: 1;" placeholder="Enter details for ${type}...">${value}</textarea>
            <div class="remove-entry" role="button" tabindex="0">Remove</div>
        </div>
    `;
    container.appendChild(div);

    const ta = div.querySelector('textarea');
    ta.addEventListener('input', debounce(() => { computeAll(); saveState(); }, 300));
    const rem = div.querySelector('.remove-entry');
    rem.addEventListener('click', () => { 
        div.remove(); 
        computeAll(); 
        saveState(); 
    });
    div.scrollIntoView({ behavior: 'smooth', block: 'center' });
    ta.focus();
}

function getOxyDeviceText(s) {
    let oxyDeviceText = '';
    switch (s.oxMod) {
        case 'RA': oxyDeviceText = 'RA'; break;
        case 'NP': oxyDeviceText = s.npFlow ? `${s.npFlow}L NP` : 'NP'; break;
        case 'HFNP':
            let hfnpParts = [];
            if (s.hfnpFlow) hfnpParts.push(`${s.hfnpFlow}L`);
            if (s.hfnpFio2) hfnpParts.push(`${s.hfnpFio2}%`);
            oxyDeviceText = `HFNP ${hfnpParts.join(' / ')}`;
            break;
        case 'NIV':
            let nivParts = [];
            if (s.nivFio2) nivParts.push(`${s.nivFio2}% FiO2`);
            if (s.nivPeep) nivParts.push(`${s.nivPeep} PEEP`);
            if (s.nivPs) nivParts.push(`${s.nivPs} PS`);
            oxyDeviceText = `NIV ${nivParts.join(', ')}`;
            break;
    }
    return oxyDeviceText.trim();
}

function getAirwayDeviceText(s) {
    let airwayDeviceText = '';
    if (s.oxMod === 'Trache') {
        const tracheType = s.tracheType;
        airwayDeviceText = !tracheType ? 'Altered Airway' : tracheType;
        const details = s.trache_details_note ? s.trache_details_note.trim() : '';
        if (details) airwayDeviceText += ` (${details})`;
    }
    return airwayDeviceText.trim();
}

// Helper for stacking GCS/AMT text
function stackText(id, text) {
    const el = $(id);
    let val = el.value;
    if (val.includes(text)) return; // already there
    if (val.length > 0) val += ', ';
    el.value = val + text;
    el.dispatchEvent(new Event('input'));
}


/* ===========================
   Save / Load DOM <-> State
   =========================== */
function getState() {
  const state = {};
  for (const id of staticInputs) {
    const el = $(id);
    if (!el) continue;
    state[id] = el.value;
  }
  
  // Segmented Controls state
  for (const id of segmentedInputs) {
    const group = $(`seg_${id}`);
    if(!group) continue;
    const active = group.querySelector('.seg-btn.active');
    if(active) {
        state[id] = active.dataset.value === "true";
    } else {
        state[id] = null;
    }
  }
  
  // Simple Toggles
  for (const id of toggleInputs) {
    const el = $(`toggle_${id}`);
    state[id] = el ? el.dataset.value === 'true' : false;
  }

  for (const groupId of selectInputs) {
    const el = $(groupId);
    if (!el) continue;
    const active = el.querySelector('.select-btn.active');
    state[groupId] = active ? active.dataset.value : '';
  }
  let checked = document.querySelector('input[name="reviewType"]:checked');
  state['reviewType'] = checked ? checked.value : 'post';

  checked = document.querySelector('input[name="clinicianRole"]:checked');
  state['clinicianRole'] = checked ? checked.value : 'ALERT CNS';
  
  state['chk_medical_rounding'] = $('chk_medical_rounding').checked;
  state['chk_discharge_alert'] = $('chk_discharge_alert').checked;
  state['chk_use_mods'] = $('chk_use_mods').checked;
  state['chk_aperients'] = $('chk_aperients').checked;
  
  // Bowel State
  const bowelBtn = document.querySelector('#panel_ae .quick-select.active');
  state['bowel_mode'] = bowelBtn ? bowelBtn.id : null;

  state.devices = {};
  deviceTypes.forEach(type => {
      state.devices[type] = Array.from(document.querySelectorAll(`.device-entry[data-type="${type}"] textarea`)).map(ta => ta.value);
  });
  
  // Trends
  document.querySelectorAll('.trend-buttons').forEach(group => {
    const activeBtn = group.querySelector('.trend-btn.active');
    state[group.id] = activeBtn ? activeBtn.dataset.value : '';
  });
  
  const vitalsTrends = ['b_rr_trend', 'c_hr_trend', 'c_nibp_trend'];
  vitalsTrends.forEach(id => {
      const group = $(id);
      if(group) {
        const activeBtn = group.querySelector('.trend-btn.active');
        state[id] = activeBtn ? activeBtn.dataset.value : '';
      }
  });

  return state;
}

function restoreState(state) {
  if (!state) return;
  for (const id of staticInputs) {
    const el = $(id);
    if (!el) continue;
    if (state[id] !== undefined) el.value = state[id];
  }

  // Restore Segmented Controls
  for (const id of segmentedInputs) {
    const group = $(`seg_${id}`);
    if(!group) continue;
    group.querySelectorAll('.seg-btn').forEach(btn => btn.classList.remove('active'));
    
    if (state[id] === true) {
        const btn = group.querySelector('.seg-btn[data-value="true"]');
        if(btn) btn.classList.add('active');
        handleSegmentClick(id, "true");
    } else if (state[id] === false) {
        const btn = group.querySelector('.seg-btn[data-value="false"]');
        if(btn) btn.classList.add('active');
        handleSegmentClick(id, "false");
    } else {
        handleSegmentClick(id, null);
    }
  }
  
  // Restore Simple Toggles
  for (const id of toggleInputs) {
    const el = $(`toggle_${id}`);
    if (!el) continue;
    const val = state[id];
    el.dataset.value = val ? 'true' : 'false';
    el.classList.toggle('active', !!val);
    if (id === 'comorb_other') {
        const noteWrapper = $('comorb_other_note_wrapper');
        if(noteWrapper) noteWrapper.style.display = val ? 'block' : 'none';
    }
  }

  for (const groupId of selectInputs) {
    const value = state[groupId];
    if (!value) continue;
    const btn = $(groupId).querySelector(`.select-btn[data-value="${value}"]`);
    if (btn) btn.classList.add('active');
  }
  
  if (state['reviewType']) {
    const radioEl = document.querySelector(`input[name="reviewType"][value="${state['reviewType']}"]`);
    if (radioEl) {
        radioEl.checked = true;
        updateWardOptions();
    }
  }
  
  if (state['clinicianRole']) {
    const radioEl = document.querySelector(`input[name="clinicianRole"][value="${state['clinicianRole']}"]`);
    if (radioEl) radioEl.checked = true;
  }
  
  if(state['chk_medical_rounding'] !== undefined) $('chk_medical_rounding').checked = state['chk_medical_rounding'];
  if(state['chk_discharge_alert'] !== undefined) $('chk_discharge_alert').checked = state['chk_discharge_alert'];
  if(state['chk_aperients'] !== undefined) $('chk_aperients').checked = state['chk_aperients'];
  
  if(state['chk_use_mods'] !== undefined) {
      $('chk_use_mods').checked = state['chk_use_mods'];
      $('mods_inputs').style.display = state['chk_use_mods'] ? 'block' : 'none';
  }
  
  // Restore Bowels
  if (state['bowel_mode']) {
      const btn = $(state['bowel_mode']);
      if(btn) {
          btn.classList.add('active');
          toggleBowelDate(state['bowel_mode']);
      }
  }

  // Restore ptWard AFTER options are updated
  if(state.ptWard) $('ptWard').value = state.ptWard;

  $('devices-container').innerHTML = '';
  if (state.devices) {
      deviceTypes.forEach(type => {
          if (state.devices[type]) {
              state.devices[type].forEach(value => createDeviceEntry(type, value));
          }
      });
  }
  
  document.querySelectorAll('.trend-buttons').forEach(group => {
    const value = state[group.id] || '';
    group.querySelectorAll('.trend-btn').forEach(btn => btn.classList.remove('active'));
    const btnToActivate = group.querySelector(`.trend-btn[data-value="${value}"]`);
    if(btnToActivate) btnToActivate.classList.add('active');
  });
  
  // Set manual flags
  const expectedOxyText = getOxyDeviceText(state);
  const bDeviceEl = $('b_device');
  bDeviceEl.dataset.manual = (state.b_device === expectedOxyText || state.b_device === "") ? "false" : "true";

  const aDeviceEl = $('airway_a');
  const expectedAirwayText = getAirwayDeviceText(state);
  if (state.airway_a === expectedAirwayText) {
      aDeviceEl.dataset.manual = "false";
  } else {
      aDeviceEl.dataset.manual = "true";
  }

  updateWardOtherVisibility();
  toggleInfusionsBox();
}

/* ===========================
   Interactivity wiring
   =========================== */
function initialize() {
  updateLastSaved();
  const debouncedComputeAndSave = debounce(()=>{ computeAll(); saveState(true); }, 600);
  
  // Create trend buttons
  const trends = ['↑', '↓', '→'];
  document.querySelectorAll('.trend-buttons').forEach(group => {
      trends.forEach(trend => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'trend-btn';
          btn.dataset.value = trend;
          btn.textContent = trend;
          btn.addEventListener('click', () => {
              const wasActive = btn.classList.contains('active');
              group.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
              if (!wasActive) btn.classList.add('active');
              debouncedComputeAndSave();
          });
          group.appendChild(btn);
      });
  });

  // Wiring for Segmented Groups
  document.querySelectorAll('.segmented-group').forEach(group => {
      group.querySelectorAll('.seg-btn').forEach(btn => {
         if(btn.style.pointerEvents === 'none') return; // Skip label buttons
         btn.addEventListener('click', () => {
             const val = btn.dataset.value;
             const id = group.id.replace('seg_', '');
             
             // Toggle off if already active
             if(btn.classList.contains('active')) {
                 btn.classList.remove('active');
                 handleSegmentClick(id, null);
             } else {
                 group.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
                 btn.classList.add('active');
                 handleSegmentClick(id, val);
             }
             debouncedComputeAndSave();
         });
      });
  });
  
  // Simple Toggle Labels (Comorbs)
  document.querySelectorAll('.toggle-label').forEach(el => {
    el.addEventListener('click', ()=> {
      el.dataset.value = el.dataset.value === 'true' ? 'false' : 'true';
      el.classList.toggle('active', el.dataset.value === 'true');
      if(el.id === 'toggle_comorb_other') {
          const noteWrapper = $('comorb_other_note_wrapper');
          if(noteWrapper) noteWrapper.style.display = el.dataset.value === 'true' ? 'block' : 'none';
      }
      debouncedComputeAndSave();
    });
  });

  document.querySelectorAll('.button-group').forEach(group => {
    group.querySelectorAll('.select-btn').forEach(btn => {
      btn.addEventListener('click', ()=> {
        if (group.id === 'oxMod' || group.id === 'tracheType' || group.id === 'tracheStatus') {
            $('b_device').dataset.manual = "false";
            $('airway_a').dataset.manual = "false"; 
        }
          
        group.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (group.id === 'oxMod') toggleOxyFields();
        if (group.id === 'neuroConcern') toggleNeuroFields(); // New handler
        
        const noteWrapperId = group.id + '_note_wrapper';
        const noteWrapper = $(noteWrapperId);
        if(noteWrapper && group.id !== 'neuroConcern') { // neuro handled separately
             noteWrapper.style.display = (btn.dataset.value !== 'none' && btn.dataset.value !== '') ? 'block' : 'none';
        }

        const fn = (group.id === 'stepdownTime') ? computeAllAndSave : debouncedComputeAndSave;
        fn();
      });
    });
  });

  staticInputs.forEach(id => {
    const el = $(id); if (!el) return;
    const evt = (el.tagName==='SELECT' || el.type==='date') ? 'change' : 'input';
    const fn = (id === 'stepdownDate') ? computeAllAndSave : debouncedComputeAndSave;
    el.addEventListener(evt, fn);
  });
  
  $('b_device').addEventListener('input', () => { $('b_device').dataset.manual = "true"; });
  $('airway_a').addEventListener('input', () => { $('airway_a').dataset.manual = "true"; });
  
  $('chk_medical_rounding').addEventListener('change', debouncedComputeAndSave);
  $('chk_discharge_alert').addEventListener('change', debouncedComputeAndSave);
  $('chk_use_mods').addEventListener('change', () => {
      $('mods_inputs').style.display = $('chk_use_mods').checked ? 'block' : 'none';
      debouncedComputeAndSave();
  });
  $('chk_aperients').addEventListener('change', debouncedComputeAndSave);
  
  // Bowel Buttons
  ['btn_bno', 'btn_bo'].forEach(id => {
      $(id).addEventListener('click', (e) => {
          e.preventDefault();
          const btn = $(id);
          const other = id === 'btn_bno' ? $('btn_bo') : $('btn_bno');
          const isActive = btn.classList.contains('active');
          
          if (isActive) {
              btn.classList.remove('active');
              toggleBowelDate(null);
          } else {
              btn.classList.add('active');
              other.classList.remove('active');
              toggleBowelDate(id);
          }
          debouncedComputeAndSave();
      });
  });

  // PMH Sync
  $('comorb_other_note').addEventListener('input', () => {
       $('pmh_note').value = $('comorb_other_note').value;
       debouncedComputeAndSave();
  });
  
  // Review Type Switch logic
  document.querySelectorAll('input[name="reviewType"]').forEach(r => r.addEventListener('change', () => {
      updateWardOptions();
      toggleInfusionsBox();
      debouncedComputeAndSave();
  }));

  $('ptWard').addEventListener('change', () => {
    updateWardOtherVisibility();
    debouncedComputeAndSave();
  });

  // Bloods sync
  ['neut','lymph'].forEach(id => { $(id).addEventListener('input', ()=>{ updateNLR(); debouncedComputeAndSave(); }); });
  const sync = (a,b) => { if (!$(a) || !$(b)) return; $(a).addEventListener('input', ()=>{ $(b).value = $(a).value; debouncedComputeAndSave(); }); $(b).addEventListener('input', ()=>{ $(a).value = $(b).value; debouncedComputeAndSave(); }); };
  sync('adds','atoe_adds'); sync('lactate','bl_lac_review'); sync('hb','bl_hb'); sync('wcc','bl_wcc'); sync('crp','bl_crp'); sync('neut','bl_neut'); sync('lymph','bl_lymph');
  
  // Overrides
  const ovA = $('override_amber'), ovR = $('override_red'), ovC = $('override_clear');
  const setOverride = (level) => {
    $('override').value = level;
    $('override_reason_box').style.display = level==='none' ? 'none' : 'block';
    ovA.classList.toggle('active', level==='amber');
    ovR.classList.toggle('active', level==='red');
    debouncedComputeAndSave();
  };
  ovA.addEventListener('click', ()=> setOverride('amber'));
  ovR.addEventListener('click', ()=> setOverride('red'));
  ovC.addEventListener('click', ()=> setOverride('none'));

  // Accordions
  document.querySelectorAll('.accordion-wrapper').forEach(wrapper => {
    const btn = wrapper.querySelector('.accordion');
    const panel = wrapper.querySelector('.panel');
    const id = wrapper.dataset.accordionId || Math.random().toString(36).slice(2,8);
    wrapper.dataset.accordionId = id;
    btn.addEventListener('click', ()=>{
      const open = panel.style.display !== 'block';
      panel.style.display = open ? 'block' : 'none';
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.querySelector('.icon').textContent = open ? '[-]' : '[+]';
      const maps = JSON.parse(localStorage.getItem(ACCORDION_KEY) || '{}');
      maps[id] = open;
      localStorage.setItem(ACCORDION_KEY, JSON.stringify(maps));
    });
  });
  
  // Quick Selects
  document.querySelectorAll('.quick-select').forEach(btn => {
      if(btn.onclick || btn.id.includes('btn_b')) return; // skip inline and special handlers
      btn.addEventListener('click', (e) => {
          e.preventDefault();
          const targetEl = $(btn.dataset.target);
          if (targetEl) {
              targetEl.value = btn.dataset.value;
              targetEl.dispatchEvent(new Event('input'));
          }
      });
  });

  document.querySelectorAll('#panel_devices .btn[data-device-type]').forEach(button => {
        button.addEventListener('click', () => {
            createDeviceEntry(button.dataset.deviceType);
            computeAll();
            saveState();
        });
    });

  $('copyBtn').addEventListener('click', ()=> {
    navigator.clipboard.writeText($('summary').value).then(()=> showToast('Summary copied',1400)).catch(()=> showToast('Copy failed',2000));
  });
  $('footerSave').addEventListener('click', ()=> { saveState(true); showToast('Saved',900); });
  $('footerCopy').addEventListener('click', ()=> $('copyBtn').click() );

  // Clear Data
  const clearDataAction = () => {
    if (!confirm('Are you sure you want to clear all data for this patient?')) return;
    pushUndo(getState());
    
    staticInputs.forEach(id=>{ const el=$(id); if(el) el.value=''; });
    
    // Reset segmented controls
    document.querySelectorAll('.segmented-group').forEach(group => {
        group.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    });
    // Reset simple toggles
    document.querySelectorAll('.toggle-label').forEach(el => {
        el.dataset.value = 'false';
        el.classList.remove('active');
    });

    // Hide side effects
    document.querySelectorAll('.concern-note').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.sub-question-wrapper').forEach(el => {
        el.style.display = 'none'; el.classList.remove('show');
    });
    $('infectionMarkers').style.display = 'none';
    $('mods_inputs').style.display = 'none';

    selectInputs.forEach(g=>{ const el=$(g); if(el) el.querySelectorAll('.select-btn').forEach(b=>b.classList.remove('active')); });
    
    toggleOxyFields();
    document.querySelectorAll('.trend-buttons .trend-btn').forEach(btn => btn.classList.remove('active'));
    $('devices-container').innerHTML = '';
    
    // Reset Ward list to post default
    document.querySelector('input[name="reviewType"][value="post"]').checked = true;
    updateWardOptions();
    
    $('chk_medical_rounding').checked = false;
    $('chk_discharge_alert').checked = false;
    $('chk_use_mods').checked = false;
    $('chk_aperients').checked = false;
    $('b_device').dataset.manual = "false";
    $('airway_a').dataset.manual = "false";
    $('dischargeNudge').style.display = 'none';
    
    // Reset Bowels
    $('btn_bno').classList.remove('active');
    $('btn_bo').classList.remove('active');
    toggleBowelDate(null);
    
    // Reset Override
    $('override').value = 'none';
    $('override_reason_box').style.display = 'none';
    $('override_red').classList.remove('active');
    $('override_amber').classList.remove('active');
    
    computeAll();
    saveState(true);
    showToast('Cleared — Undo?', 10000, 'Undo', ()=> {
      const snap = popUndo();
      if (snap) { restoreState(snap); computeAll(); saveState(true); showToast('Restored',1400); }
    });
  };

  $('clearDataBtnTop').addEventListener('click', clearDataAction);
  $('clearDataBtnBottom').addEventListener('click', clearDataAction);

  // Dark Mode
  const darkBtn = $('darkToggle');
  const applyDark = (on) => {
    document.body.classList.toggle('dark', !!on);
    darkBtn.setAttribute('aria-pressed', !!on);
    darkBtn.textContent = (!!on) ? 'Light mode' : 'Dark mode';
    localStorage.setItem('alertToolDark', !!on ? '1' : '0');
  };
  darkBtn.addEventListener('click', ()=> { const on = !document.body.classList.contains('dark'); applyDark(on); });
  if (localStorage.getItem('alertToolDark') === '1') applyDark(true);

  // Init sequence
  const saved = loadState();
  updateWardOptions(); // Pre-load options
  if (saved) {
    restoreState(saved);
  }
  
  toggleOxyFields();
  toggleInfusionsBox();
  toggleNeuroFields();

  // Open accordions
  const maps = JSON.parse(localStorage.getItem(ACCORDION_KEY) || '{}');
  document.querySelectorAll('.accordion-wrapper').forEach(wrapper => {
      const id = wrapper.dataset.accordionId;
      if (maps[id]) {
          const btn = wrapper.querySelector('.accordion');
          const panel = wrapper.querySelector('.panel');
          panel.style.display = 'block';
          btn.setAttribute('aria-expanded','true');
          btn.querySelector('.icon').textContent='[-]';
      }
  });

  computeAll();
  window.addEventListener('beforeunload', ()=> saveState(true));
}

/* ===========================
   UX helpers & Logic
   =========================== */

function handleSegmentClick(id, value) {
    // value is string "true", "false", or null
    // id is like "after_hours"
    
    const noteWrapper = $(id + '_note_wrapper');
    if(noteWrapper) {
        noteWrapper.style.display = (value === "true") ? 'block' : 'none';
    }
    
    if (id === 'infection') {
        $('infectionMarkers').style.display = (value === "true") ? 'block' : 'none';
    }
    if (id === 'pressors') {
        const sub = $('sub_pressors_reason');
        if(value === "true") {
            sub.style.display = 'block';
            sub.classList.add('show');
        } else {
            sub.style.display = 'none';
            sub.classList.remove('show');
        }
    }
    if (id === 'intubated') {
        const sub = $('sub_intubated_reason');
        if(value === "true") {
            sub.style.display = 'block';
            sub.classList.add('show');
        } else {
            sub.style.display = 'none';
            sub.classList.remove('show');
        }
    }
}

function updateWardOptions() {
    const type = document.querySelector('input[name="reviewType"]:checked')?.value || 'post';
    const wardSelect = $('ptWard');
    const currentVal = wardSelect.value;
    
    wardSelect.innerHTML = '<option value="" selected disabled>Select Ward...</option>';
    
    let options = [];
    if (type === 'pre') {
        options = ['ICU Pod 1', 'ICU Pod 2', 'ICU Pod 3', 'ICU Pod 4'];
    } else {
        options = [
            '3A','3B','3C','3D',
            '4A','4B','4C','4D',
            '5A','5B','5C','5D',
            '6A','6B','6C','6D',
            '7A','7B','7C','7D',
            'SRS2A','SRS1A','SRSA','SRSB',
            'Medihotel 8','Medihotel 7','Medihotel 6','Medihotel 5',
            'Short Stay','Transit Lounge',
            'Mental Health Adult','Mental Health Youth'
        ];
    }
    options.push('Other');
    
    options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        wardSelect.appendChild(o);
    });
    
    if (options.includes(currentVal)) {
        wardSelect.value = currentVal;
    } else if (currentVal === 'Other') {
        wardSelect.value = 'Other';
    }
    updateWardOtherVisibility();
}

function toggleNeuroFields() {
    const group = $('neuroConcern');
    const active = group.querySelector('.select-btn.active');
    const typeGroup = $('neuroType');
    const noteWrapper = $('neuroConcern_note_wrapper');
    
    if (active && active.dataset.value !== 'none') {
        typeGroup.style.display = 'flex';
        noteWrapper.style.display = 'block';
    } else {
        typeGroup.style.display = 'none';
        noteWrapper.style.display = 'none';
    }
}

function getRoundedTime() {
    const now = new Date();
    const minutes = now.getMinutes();
    const roundedMinutes = Math.round(minutes / 15) * 15;
    if (roundedMinutes === 60) {
        now.setHours(now.getHours() + 1);
        now.setMinutes(0);
    } else {
        now.setMinutes(roundedMinutes);
    }
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
}

function formatDateAUS(dateStr) {
    if (!dateStr) return '';
    const [y, m, d] = dateStr.split('-');
    return `${d}/${m}/${y}`;
}

function toggleOxyFields() {
  const mod = $('oxMod').querySelector('.select-btn.active')?.dataset.value || 'RA';
  document.querySelectorAll('.npOnly').forEach(el => el.style.display = (mod === 'NP') ? '' : 'none');
  document.querySelectorAll('.hfnpOnly').forEach(el => el.style.display = (mod === 'HFNP') ? '' : 'none');
  document.querySelectorAll('.nivOnly').forEach(el => el.style.display = (mod === 'NIV') ? '' : 'none');
  document.querySelectorAll('.tracheOnly').forEach(el => el.style.display = (mod === 'Trache') ? '' : 'none');
}

function toggleInfusionsBox() {
    const reviewType = document.querySelector('input[name="reviewType"]:checked')?.value || 'post';
    $('infusions_wrapper').style.display = (reviewType === 'pre') ? 'grid' : 'none';
}

function toggleBowelDate(mode) {
    const wrapper = $('bowel_date_wrapper');
    const label = $('bowel_date_label');
    const aperients = $('aperients_wrapper');
    if (!mode) {
        wrapper.style.display = 'none';
        return;
    }
    wrapper.style.display = 'block';
    label.textContent = (mode === 'btn_bno') ? 'Date Last Opened' : 'Date BO';
    if(mode === 'btn_bno') {
        aperients.style.display = 'block';
    } else {
        aperients.style.display = 'none';
        $('chk_aperients').checked = false; // reset check if switching
    }
}

function updateNLR() {
  const neut = num($('neut').value), lymph = num($('lymph').value);
  const nlrCalc = $('nlrCalc');
  if(neut !== null && lymph > 0){
    const nlr = (neut / lymph).toFixed(1);
    nlrCalc.textContent = `NLR: ${nlr}`;
    nlrCalc.className = '';
    if (nlr > 10) nlrCalc.classList.add('status', 'red');
    else if (nlr >=5) nlrCalc.classList.add('status', 'amber');
    return num(nlr);
  } else {
    nlrCalc.textContent = `NLR: --`;
    nlrCalc.className = '';
    return null;
  }
}

function updateSingleBloodFlag(key, value) {
    const range = normalRanges[key];
    if(!range) return;
    const inputEl = $(`bl_${key}`);
    const rangeEl = $(`bl_${key}_range`);
    if (inputEl) {
        const isAbnormal = value !== null && (value < range.low || value > range.high);
        inputEl.classList.toggle('blood-abnormal', isAbnormal);
        if (rangeEl) {
            if(isAbnormal){
              rangeEl.textContent = `(Normal: ${range.low}-${range.high})`;
              rangeEl.style.display = 'block';
            } else {
              rangeEl.style.display = 'none';
            }
        }
    }
}

function updateBloodFlags(s) {
  for (const key of Object.keys(normalRanges)) {
    updateSingleBloodFlag(key, num(s[`bl_${key}`]));
  }
}

function updateWardOtherVisibility() {
    const wardSelect = $('ptWard');
    const otherWrapper = $('ptWardOtherWrapper');
    if (wardSelect && otherWrapper) {
        otherWrapper.style.display = (wardSelect.value === 'Other') ? 'block' : 'none';
    }
}

/* ===========================
   Scoring Logic
   =========================== */

function calculateTimeOnWard(dateStr, timeOfDay) {
  if (!dateStr) return { text: null, hours: null };
  const timeMap = { 'Morning': 9, 'Afternoon': 15, 'Evening': 18, 'Night': 21 };
  const stepdownHour = timeMap[timeOfDay] || 12;
  const [year, month, day] = dateStr.split('-').map(Number);
  const stepdownDate = new Date(year, month - 1, day, stepdownHour, 0, 0);
  if (isNaN(stepdownDate.getTime())) return { text: null, hours: null };
  
  const diffMs = new Date().getTime() - stepdownDate.getTime();
  const diffHours = diffMs / 3600000;
  if (diffHours < 0) return { text: '(future date)', hours: diffHours };

  let text;
  if (diffHours < 24) {
      text = `${Math.round(diffHours)} hours`;
  } else if (diffHours < 72) {
      const days = (Math.round((diffHours / 24) * 2) / 2);
      text = `${days} day${days === 1 ? '' : 's'}`;
  } else {
      const days = Math.round(diffHours / 24);
      text = `${days} day${days === 1 ? '' : 's'}`;
  }
  return { text: text, hours: diffHours };
}


function computeAll() {
  const s = getState();
  
  // Auto-populate A-E
  const airwayText = getAirwayDeviceText(s);
  const airwayEl = $('airway_a');
  if (airwayEl.dataset.manual !== "true" && airwayText) {
      airwayEl.value = airwayText; s.airway_a = airwayText;
  }
  
  const oxyDeviceText = getOxyDeviceText(s);
  const bDeviceEl = $('b_device');
  if (bDeviceEl.dataset.manual !== "true") {
      bDeviceEl.value = oxyDeviceText; s.b_device = oxyDeviceText;
  }
  
  const red = [], amber = [];
  const flaggedElements = { red: [], amber: [] };
  const addRisk = (list, text, note, elementId, flagType) => {
    if (note && note.trim()) list.push(`${text} (${note.trim()})`);
    else list.push(text);
    if (elementId && flagType) flaggedElements[flagType].push(elementId);
  }

  const ward = s.ptWard === 'Other' ? s.ptWardOther : s.ptWard;
  const location = [ward, s.ptBed].filter(Boolean).join(' ').trim();
  
  // Scoring Logic
  const icuLos = num(s.icuLos);
  const immobility = s.immobility === true;
  const pressorReason = $('pressorReason').querySelector('.active')?.dataset.value;
  const pressorsRed = (s.pressors === true && pressorReason === 'shock');
  const pressorsAmber = (s.pressors === true && pressorReason === 'routine');
  
  const lactateVal = num(s.lactate);
  const hasSignificantFlags = pressorsRed || (lactateVal !== null && lactateVal > 2.0);
  
  let hasCombinedRedFlag = false;

  if ((immobility && icuLos >= 4) || (icuLos >= 4 && hasSignificantFlags)) {
      let reason = (immobility && icuLos >= 4) 
          ? `Immobility >48h + ICU LOS ${icuLos} days` 
          : `ICU LOS ${icuLos} days + Significant flag (${pressorsRed ? 'vasopressors required' : 'lactate >2'})`;
      red.push(reason);
      if (immobility) flaggedElements.red.push('seg_immobility');
      flaggedElements.red.push('icuLos');
      if (pressorsRed) flaggedElements.red.push('seg_pressors');
      if (lactateVal > 2.0) flaggedElements.red.push('lactate');
      hasCombinedRedFlag = true;
  }

  if (immobility && !hasCombinedRedFlag) {
      addRisk(amber, 'Immobility >48h', s.immobility_note, 'seg_immobility', 'amber');
  }

  if (icuLos > 7 && !hasCombinedRedFlag) {
      amber.push(`ICU LOS ${icuLos} days`);
      flaggedElements.amber.push('icuLos');
  }

  // Oxygen
  const oxModGroup = $('oxMod');
  if (s.oxMod === 'NP') {
    const flow = num(s.npFlow);
    if (flow !== null && flow >= 3) { red.push(`NP flow ${flow} L/min`); flaggedElements.red.push(oxModGroup.id); flaggedElements.red.push('npFlow'); }
    else if (flow !== null && flow >= 2) { amber.push(`NP flow ${flow} L/min`); flaggedElements.amber.push(oxModGroup.id); flaggedElements.amber.push('npFlow');}
  } else if (s.oxMod === 'HFNP') {
    const fio2 = num(s.hfnpFio2), flow = num(s.hfnpFlow);
    if (fio2 > 30 || flow > 30) { red.push(`HFNP concern`); flaggedElements.red.push(oxModGroup.id); }
    else if ((fio2 > 21) || (flow > 0)) { amber.push('On HFNP (low settings)'); flaggedElements.amber.push(oxModGroup.id); }
  } else if (s.oxMod === 'NIV') {
    red.push('On NIV'); flaggedElements.red.push(oxModGroup.id);
  } else if (s.oxMod === 'Trache') {
      const ts = s.tracheStatus;
      if (ts === 'New') addRisk(red, s.tracheType||'Trache', null, 'oxMod', 'red');
      else addRisk(amber, s.tracheType||'Trache', null, 'oxMod', 'amber');
  }

  // Historical O2
  if (s.hist_o2 === true) addRisk(red, 'Historical high O2/NIV', s.hist_o2_note, 'seg_hist_o2', 'red');
  
  // Intubation Logic
  if (s.intubated === true) {
      const reason = $('intubatedReason').querySelector('.active')?.dataset.value;
      let label = 'Intubated in last 24h';
      if (reason === 'concern') {
          addRisk(red, `${label} (Concerns)`, s.intubation_details, 'seg_intubated', 'red');
      } else {
          // Routine/Elective
          addRisk(amber, `${label} (Routine/Elective)`, s.intubation_details, 'seg_intubated', 'amber');
      }
  }

  if (s.rapid_wean === true) addRisk(red, 'Rapid oxygen wean in last 12h', s.rapid_wean_note, 'seg_rapid_wean', 'red');
  if (s.after_hours === true) addRisk(red, 'Discharged after-hours', s.after_hours_note, 'seg_after_hours', 'red');
  
  // Pressors solo logic (if not combined above)
  if (pressorsRed && !hasCombinedRedFlag) addRisk(red, 'Vasopressors required (Shock/Complicated)', s.pressors_note, 'seg_pressors', 'red');
  else if (pressorsAmber) addRisk(amber, 'Vasopressors (Routine/Short term)', s.pressors_note, 'seg_pressors', 'amber');

  if (num(s.adds) >= 3) { red.push(`ADDS ${s.adds}`); flaggedElements.red.push('adds');}
  if (lactateVal > 2.5) { red.push(`Lactate ${lactateVal}`); flaggedElements.red.push('lactate');}
  else if (lactateVal >= 2.0 && !hasCombinedRedFlag) { amber.push(`Lactate ${lactateVal}`); flaggedElements.amber.push('lactate');}
  
  if (s.uop === true) addRisk(red, 'UOP concerning / downtrending', s.uop_note, 'seg_uop', 'red');
  if (s.renal === true) addRisk(red, 'Renal Concern', s.renal_note, 'seg_renal', 'red');
  
  // Neuro - 3 Way Split
  if (s.neuroConcern === 'severe') {
      addRisk(red, 'Severe Neuro Concern', s.neuroConcern_note, 'neuroConcern', 'red');
  } else if (s.neuroConcern === 'mod') {
      addRisk(red, 'Moderate Neuro Concern', s.neuroConcern_note, 'neuroConcern', 'red');
  } else if (s.neuroConcern === 'mild') {
      addRisk(amber, 'Mild Neuro Concern', s.neuroConcern_note, 'neuroConcern', 'amber');
  }
  
  // Electrolyte
  if (s.electrolyteConcern === 'severe') addRisk(red, 'Severe electrolyte concern', s.electrolyteConcern_note, 'electrolyteConcern', 'red');
  else if (s.electrolyteConcern === 'mild') addRisk(amber, 'Electrolyte concern', s.electrolyteConcern_note, 'electrolyteConcern', 'amber');

  // Resp Concern - 3 Way Split
  if (s.dyspneaConcern === 'severe') addRisk(red, 'Severe respiratory concern', s.dyspneaConcern_note, 'dyspneaConcern', 'red');
  else if (s.dyspneaConcern === 'mod') addRisk(red, 'Moderate respiratory concern', s.dyspneaConcern_note, 'dyspneaConcern', 'red');
  else if (s.dyspneaConcern === 'mild') addRisk(amber, 'Mild respiratory concern', s.dyspneaConcern_note, 'dyspneaConcern', 'amber');

  // Hb
  const hb = num(s.hb);
  if (hb !== null && hb <= 70) { red.push(`Anemia concern (Hb ${hb})`); flaggedElements.red.push('hb'); }
  else if (hb !== null && hb <= 100 && s.hb_dropping === true) { 
      amber.push(`Anemia concern (Hb ${hb}, dropping)`); 
      flaggedElements.amber.push('hb'); flaggedElements.amber.push('seg_hb_dropping');
  }

  // Comorbs (Simple Toggles)
  const comorbIds = ['comorb_copd','comorb_hf','comorb_esrd','comorb_diabetes','comorb_cirrhosis', 'comorb_other'];
  const comorbCount = comorbIds.filter(id => s[id] === true).length;
  if (comorbCount >= 3) { 
      red.push('Multiple comorbidities'); 
      comorbIds.forEach(id => {if(s[id]) flaggedElements.red.push('toggle_'+id) });
  }
  else if (comorbCount > 0) { 
      amber.push(`Comorbidity burden`); 
      comorbIds.forEach(id => {if(s[id]) flaggedElements.amber.push('toggle_'+id) });
  }

  // Infection
  if (s.infection === true) {
     const wcc = num(s.wcc), crp = num(s.crp), nlr = updateNLR(), temp = num(s.e_temp);
     let markerParts = [];
     let hasRedMarker = false, hasAmberMarker = false;
     if (wcc !== null && (wcc < 4 || wcc > 11)) { markerParts.push(`WCC ${wcc}`); hasRedMarker = true; }
     if (crp > 100) { markerParts.push(`CRP ${crp}`); hasRedMarker = true; }
     else if (crp > 50) { markerParts.push(`CRP ${crp}`); hasAmberMarker = true; }
     if (nlr > 10) { markerParts.push(`NLR ${nlr}`); hasRedMarker = true; }
     else if (nlr >= 5) { markerParts.push(`NLR ${nlr}`); hasAmberMarker = true; }
     
     let baseText = 'Infection Concern';
     if(markerParts.length) baseText += `: High markers (${markerParts.join(', ')})`;
     
     let cat = hasRedMarker ? 'red' : (hasAmberMarker ? 'amber' : 'red'); 
     addRisk(cat === 'red' ? red : amber, baseText, s.infection_note, 'seg_infection', cat);
  }

  // Override
  const overrideNote = $('overrideNote')?.value ? ` (${$('overrideNote').value})` : '';
  if ($('override').value === 'red') red.push(`Override: CAT 1 concern${overrideNote}`);
  else if ($('override').value === 'amber') amber.push(`Override: CAT 2 concern${overrideNote}`);

  updateBloodFlags(s);

  // Category Calc
  const redCount = red.length;
  const amberCount = amber.length;
  const cat = (redCount > 0) ? {id: 'red', text: 'CAT 1', catNum: 1} : (amberCount > 0) ? {id: 'amber', text: 'CAT 2', catNum: 2} : {id: 'green', text: 'CAT 3', catNum: 3};
  
  // UI Updates
  $('redCount').textContent = redCount;
  $('amberCount').textContent = amberCount;
  $('redCount').style.color = redCount > 0 ? 'var(--red)' : 'var(--ink)';
  $('amberCount').style.color = amberCount > 0 ? 'var(--amber)' : 'var(--ink)';
  
  const catTextEl = $('catText');
  catTextEl.className = 'status ' + cat.id;
  catTextEl.textContent = cat.text;
  $('categoryBox').style.borderColor = `var(--${cat.id})`;

  const flagListEl = $('flagList');
  if (redCount > 0 || amberCount > 0) {
      const redFlagsHTML = red.map(f => `<div style="color:var(--red); font-weight:600; margin:6px 0;">[CAT 1] ${f}</div>`);
      const amberFlagsHTML = amber.map(f => `<div style="color:var(--amber); font-weight:600; margin:6px 0;">[CAT 2] ${f}</div>`);
      flagListEl.innerHTML = [...redFlagsHTML, ...amberFlagsHTML].join('');
  } else {
      flagListEl.innerHTML = `<div style="color:var(--muted)">No risk factors identified</div>`;
  }
  
  // Highlights
  document.querySelectorAll('.flag-red, .flag-amber').forEach(el => el.classList.remove('flag-red', 'flag-amber'));
  flaggedElements.red.forEach(id => { const el=$(id); if(el) el.classList.add('flag-red'); });
  flaggedElements.amber.forEach(id => { const el=$(id); if(el) el.classList.add('flag-amber'); });

  // Plan Text
  const followUpEl = $('followUpInstructions');
  let followUpHTML = '';
  if (s.chk_discharge_alert === true) {
      followUpHTML = `<div class="status" style="color:var(--blue-hint);">Discharge from ALERT nursing post ICU review list.</div>`;
  } else if (cat.id === 'red') {
      followUpHTML = `<div class="status red">${redCount >= 3 ? 'Twice-daily' : 'At least daily'} ALERT review for up to 72h post-ICU stepdown.</div>`;
  } else if (cat.id === 'amber') {
      followUpHTML = `<div class="status amber">Once-daily ALERT review for up to 48h post-ICU stepdown.</div>`;
  } else {
      followUpHTML = `<div class="status green">Single ALERT review on ward to ensure continued stability.</div>`;
  }
  followUpEl.innerHTML = followUpHTML;
  
  // Discharge Nudge
  const wardTime = calculateTimeOnWard(s.stepdownDate, s.stepdownTime);
  const nudgeEl = $('dischargeNudge');
  nudgeEl.style.display = 'none';
  if (wardTime.hours !== null && wardTime.hours > 0 && s.chk_discharge_alert !== true) {
      let nudgeText = '';
      if (cat.id === 'red' && wardTime.hours >= 72) nudgeText = `Patient stepped down ${wardTime.text} ago (CAT 1 ≥ 72h). Consider discharge.`;
      else if (cat.id === 'amber' && wardTime.hours >= 48) nudgeText = `Patient stepped down ${wardTime.text} ago (CAT 2 ≥ 48h). Consider discharge.`;
      else if (cat.id === 'green' && wardTime.hours >= 24) nudgeText = `Patient stepped down ${wardTime.text} ago (CAT 3 ≥ 24h). Consider discharge.`;
      
      if(nudgeText) { nudgeEl.textContent = nudgeText; nudgeEl.style.display = 'block'; }
  }

  // Footer
  $('footerName').textContent = s.ptName || '--';
  $('footerLocation').textContent = location || '--';
  $('footerAdmission').textContent = s.ptAdmissionReason || '--';
  const scoreEl = $('footerScore');
  scoreEl.className = `footer-score tag ${cat.id}`;
  const flagCount = redCount > 0 ? redCount : amberCount;
  scoreEl.textContent = `${cat.text}${flagCount>0 ? ` (${flagCount} Flag${flagCount>1?'s':''})` : ''}`;

  generateSummary(s, cat, location, wardTime.text, red, amber);
}

function generateSummary(s, cat, location, timeOnWardText, red, amber) {
  const clean = (str) => str ? str.trim().replace(/\.$/, '').trim() : null;
  const trendWord = val => ({ '↑': ' (uptrending)', '↓':' (downtrending)', '→':' (stable)'}[val] || '');
  
  const role = s.clinicianRole || 'ALERT CNS';
  const reviewTitle = (s.reviewType === 'post') ? `${role} post ICU review` : `${role} pre ICU stepdown review`;
  
  const headerLines = [];
  const ptDetails = [];
  if (s.ptName) ptDetails.push(`Patient: ${s.ptName}`);
  if (s.ptMrn) ptDetails.push(`URN: ...${s.ptMrn}`);
  if (location) ptDetails.push(`Location: ${location}`);
  if (ptDetails.length) headerLines.push(ptDetails.join(' | '));
  
  headerLines.push(reviewTitle, `Time of review: ${getRoundedTime()}`);
  
  // Use stepdown date as ICU discharge date
  if (s.stepdownDate) headerLines.push(`ICU Discharge Date: ${formatDateAUS(s.stepdownDate)}`);

  const stepdownParts = [];
  if (s.reviewType === 'post' && timeOnWardText) stepdownParts.push(`Time since stepdown: ${timeOnWardText}.`);
  if (s.icuLos) stepdownParts.push(`ICU LOS: ${s.icuLos} days.`);
  if (stepdownParts.length) headerLines.push('', ...stepdownParts);
  
  if(s.ptAdmissionReason) headerLines.push(`Reason for ICU Admission: ${s.ptAdmissionReason}`);
  
  const lines = [...headerLines, '', `ALERT Nursing Review Category - ${cat.text}`];
  if (s.pmh_note && s.pmh_note.trim()) lines.push('', 'PMH:', s.pmh_note.trim());
  
  // A-E
  const atoe = [];
  // MODS line
  if (s.chk_use_mods === true) {
      const modsParts = [];
      if(s.mods_score) modsParts.push(`MODS Score: ${s.mods_score}`);
      if(s.mods_details) modsParts.push(`Details: ${s.mods_details}`);
      if(modsParts.length > 0) atoe.push(modsParts.join(' | '));
  } else if(s.adds) {
      atoe.push(`ADDS: ${s.adds}`); // fallback if no mods
  }
  
  if (s.airway_a) atoe.push(`A: ${s.airway_a.trim()}`);
  
  const b_parts = [
    clean(s.b_rr) ? `RR ${clean(s.b_rr)}${trendWord(s.b_rr_trend)}`:null, 
    clean(s.b_spo2) ? `SpO2 ${clean(s.b_spo2)}${clean(s.b_spo2).includes('%') ? '' : '%'}`:null, 
    clean(s.b_device),
    clean(s.b_wob) ? `WOB ${clean(s.b_wob)}`:null
  ];
  if(b_parts.filter(Boolean).length) atoe.push(`B: ${b_parts.filter(Boolean).join(', ')}`);
  
  let hrString = clean(s.c_hr) ? `HR ${clean(s.c_hr)}${trendWord(s.c_hr_trend)}`:null;
  if (hrString && s.c_hr_rhythm) hrString += ` (${s.c_hr_rhythm})`;
  
  const c_parts = [
    hrString, 
    clean(s.c_nibp) ? `NIBP ${clean(s.c_nibp)}${trendWord(s.c_nibp_trend)}`:null, 
    clean(s.c_cr) ? `Cap Refill ${clean(s.c_cr)}`:null, 
    clean(s.c_perf)
  ];
  if(c_parts.filter(Boolean).length) atoe.push(`C: ${c_parts.filter(Boolean).join(', ')}`);
  
  // Alert + Pain
  const d_parts = [];
  if(s.d_alert && s.d_alert.trim()) d_parts.push(s.d_alert.trim());
  if(s.d_pain && s.d_pain.trim()) d_parts.push(`Pain ${s.d_pain.trim()}`);
  if(d_parts.length) atoe.push(`D: ${d_parts.join(', ')}`);
  
  const e_parts = [
    clean(s.e_temp) ? `Temp ${clean(s.e_temp)}${String(clean(s.e_temp)).toLowerCase().match(/febrile|afebrile|C/) ? '' : 'C'}`:null, 
    clean(s.e_bsl) ? `BSL ${clean(s.e_bsl)}`:null, 
    clean(s.e_uop) ? `UOP ${clean(s.e_uop)}`:null
  ];
  if(e_parts.filter(Boolean).length) atoe.push(`E: ${e_parts.filter(Boolean).join(', ')}`);
  
  const otherSys = [];
  if (s.ae_mobility) otherSys.push(`Mobility/MSK: ${s.ae_mobility.trim()}`);
  if (s.ae_diet) otherSys.push(`Diet: ${s.ae_diet.trim()}`);
  
  // Bowels Logic
  let bowelStr = s.ae_bowels ? s.ae_bowels.trim() : '';
  if (s.bowel_mode === 'btn_bno' && s.bowel_date) {
      const date = formatDateAUS(s.bowel_date);
      bowelStr = bowelStr ? `BNO (Last opened: ${date}), ${bowelStr}` : `BNO (Last opened: ${date})`;
      if (s.chk_aperients) bowelStr += ' (Aperients charted)';
  } else if (s.bowel_mode === 'btn_bo' && s.bowel_date) {
      const date = formatDateAUS(s.bowel_date);
      bowelStr = bowelStr ? `BO (Date: ${date}), ${bowelStr}` : `BO (Date: ${date})`;
  } else if (s.bowel_mode === 'btn_bno') {
      bowelStr = bowelStr ? `BNO, ${bowelStr}` : `BNO`;
      if (s.chk_aperients) bowelStr += ' (Aperients charted)';
  } else if (s.bowel_mode === 'btn_bo') {
      bowelStr = bowelStr ? `BO, ${bowelStr}` : `BO`;
  }
  
  if (bowelStr) otherSys.push(`Bowels: ${bowelStr}`);
  
  if (atoe.length || otherSys.length) {
      lines.push('', 'A-E ASSESSMENT', ...atoe);
      if(atoe.length && otherSys.length) lines.push('---');
      lines.push(...otherSys);
  }

  // Bloods
  const bloodLines = [];
  const bloodLabelMap = { 'lac_review': 'Lac', 'hb': 'Hb', 'wcc': 'WCC', 'crp': 'CRP', 'cr_review': 'Cr', 'k': 'K', 'na': 'Na', 'mg': 'Mg', 'plts': 'Plts', 'alb': 'Alb', 'neut': 'Neut', 'lymph': 'Lymph', 'phos': 'PO4' };
  const bloodParts = ['lac_review','hb','wcc','crp','cr_review','k','na','mg','phos','plts','alb','neut','lymph'];
  
  const bloods = bloodParts.map(k => {
    const v = s[`bl_${k}`]; if (!v) return null;
    const trend = s[`bl_${k}_trend`] || '';
    return `${bloodLabelMap[k]} ${v}${trendWord(trend)}`;
  }).filter(Boolean).join(', ');

  let fullBloodLine = bloods;
  if (s.new_bloods_ordered === true) fullBloodLine += `${bloods ? ' ' : ''}(new bloods ordered for next round.)`;
  
  if (fullBloodLine) bloodLines.push(`Bloods: ${fullBloodLine}`);
  if (s.elec_replace_note) bloodLines.push(`Electrolyte Plan: ${s.elec_replace_note.trim()}`);
  if (bloodLines.length) lines.push('', ...bloodLines);
  
  if (s.reviewType === 'pre' && s.infusions_note && s.infusions_note.trim()) {
      lines.push(`Infusions: ${s.infusions_note.trim()}`);
  }
  
  // Devices
  if(s.devices) {
      const devLines = [];
      deviceTypes.forEach(type => {
        if(s.devices[type] && s.devices[type].length) {
            s.devices[type].forEach(d => {
                const det = d ? d.trim() : '';
                if(type === 'Other CVAD' || type === 'Other Device') {
                    devLines.push(det || type);
                } else {
                    devLines.push(det ? `${type} (${det})` : type);
                }
            });
        }
      });
      if(devLines.length) lines.push('', 'DEVICES:', ...devLines.map(d=>'- '+d));
  }
  
  // Context
  const contextLines = [];
  if (s.goc_note) {
    const gocText = s.goc_note.trim();
    contextLines.push(gocText.toLowerCase().startsWith('goc') ? gocText : `GOC: ${gocText}`);
  }
  if (s.allergies_note) contextLines.push(`Allergies: ${s.allergies_note.trim()}`);
  if (s.pics_note) contextLines.push(`Post ICU Syndrome: ${s.pics_note.trim()}`);
  if (s.context_other_note) contextLines.push(`Other: ${s.context_other_note.trim()}`);
  if (contextLines.length) lines.push('', ...contextLines);
  
  // Risk Factors
  const allFlags = [...red, ...amber];
  if (allFlags.length) lines.push('', 'IDENTIFIED RISK FACTORS:', ...allFlags.map(f=>'- '+f));
  
  // Plan
  lines.push('', 'PLAN:');
  if (s.chk_discharge_alert === true) {
      lines.push('- Follow-up: Discharge from ALERT nursing post ICU review list.');
  } else if (cat.id === 'red') {
      lines.push(`- Follow-up: ${red.length >= 3 ? 'Twice-daily' : 'At least daily'} ALERT review for up to 72h post-ICU stepdown.`);
  } else if (cat.id === 'amber') {
      lines.push('- Follow-up: Once-daily ALERT review for up to 48h post-ICU stepdown.');
  } else {
      lines.push('- Follow-up: Single ALERT review on ward to ensure continued stability.');
  }
  
  if (s.chk_medical_rounding) {
      lines.push('- Added to ALERT Medical Rounding List.');
  }

  $('summary').value = lines.join('\n');
}

/* ===========================
   Init
   =========================== */
document.addEventListener('DOMContentLoaded', ()=> {
  initialize();
});
</script>

<script>
function openRedcapAccelerator() {
    // --- 1. GATHER DATA FROM YOUR TOOL ---
    
    // A. Role (CNS vs CN)
    var roleVal = document.querySelector('input[name="clinicianRole"]:checked')?.value || "ALERT CNS";
    var teamCode = (roleVal === "ALERT CN") ? "2" : "1"; // 1=CNS, 2=CN

    // B. Score
    var score = document.getElementById('adds').value || "0";

    // C. Discharge Status
    var isDischarge = document.getElementById('chk_discharge_alert').checked;

    // D. Ward Mapping
    var wardMap = {
        "3A": "1",  "3B": "2",  "3C": "5",  "3D": "3",
        "4A": "6",  "4B": "7",  "4C": "8",  "4D": "9",
        "5A": "10", "5B": "11", "5C": "12", "5D": "13",
        "6A": "14", "6B": "15", "6C": "16", "6D": "17",
        "7A": "18", "7B": "19", "7C": "20", "7D": "21",
        "SRS2A": "59", "SRS1A": "58", "SRSA": "60", "SRSB": "61",
        "ICU Pod 1": "43", "ICU Pod 2": "43", "ICU Pod 3": "43", "ICU Pod 4": "43", 
        "CCU": "30", "HDU": "41", "ED": "36", 
        "Short Stay": "57", "Transit Lounge": "64"
    };
    
    var currentWardName = document.getElementById('ptWard').value; 
    var locationCode = wardMap[currentWardName] || ""; 


    // --- 2. CALCULATE DATE & SHIFT (UPDATED LOGIC) ---

    var now = new Date();
    
    // Get Day and Month, ensuring they have a leading zero if needed (e.g., "05")
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    var year = now.getFullYear();

    // Combine into YYYY-MM-DD (Database format)
    var dateString = year + "-" + month + "-" + day; 

    // B. Shift: Time Band Logic
    // Day: 07:30 (7.5) to 14:30 (14.5)
    // Eve: 14:30 (14.5) to 20:00 (20.0)
    // Night: 20:00 (20.0) onwards
    
    var currentHour = now.getHours();
    var currentMin = now.getMinutes();
    var decimalTime = currentHour + (currentMin / 60);

    var shiftCode = "3"; // Default Night
    if (decimalTime >= 7.5 && decimalTime < 14.5) {
        shiftCode = "1"; // Day
    } else if (decimalTime >= 14.5 && decimalTime < 20.0) {
        shiftCode = "2"; // Evening
    }
    // Else stays "3" (Night)

    // --- 3. CATEGORY LOGIC (NEW) ---
    // The tool calculates Category and updates the footer text (e.g., "CAT 1")
    // We scrape that text to determine the REDCap code.
    // 1 = >72hrs (CAT 1), 2 = >24hrs (CAT 2), 3 = <24hrs (CAT 3)
    
    var catText = document.getElementById('footerScore').innerText || "CAT 3";
    var catCode = "3"; // Default
    if (catText.includes("CAT 1")) { catCode = "1"; }
    else if (catText.includes("CAT 2")) { catCode = "2"; }
    

    // --- 4. BUILD URL PARAMETERS ---
    var params = [];

    // Standard Admin
    params.push("site=1");              // Fiona Stanley
    params.push("contactreason=6");     // ICU Follow Up
    params.push("shifttype=" + shiftCode);
    params.push("shift_date=" + dateString);
    params.push("icu_category=" + catCode); // NEW: Add Category
    
    // Dynamic Admin
    params.push("alert_team=" + teamCode);
    if(locationCode) {
        params.push("location_fs=" + locationCode);
    }
    params.push("adds_score=" + score);

    // "Always Done" Interventions
    params.push("int_group_a___1=1");  // 01 - ICU follow up
    params.push("int_group_a___8=1");  // 08 - Perform A-E
    params.push("int_group_b___19=1"); // 19 - Cognitive assess
    params.push("int_group_c___25=1"); // 25 - Electrolytes

    // Outcome Logic (Discharge vs Continue)
    if (isDischarge) {
        params.push("outcome=1");          // Discharge from ALERT
        params.push("int_group_e___42=1"); // Meets Discharge Criteria
    } else {
        params.push("outcome=3");          // Continue ALERT review
        params.push("int_group_e___41=1"); // ALERT to continue follow up
    }

    // --- 5. LAUNCH ---
    var baseUrl = "https://datalibrary-rc.health.wa.gov.au/surveys/?s=K3WAPC4KKXWNTF3F";
    var finalUrl = baseUrl + "&" + params.join("&");
    window.open(finalUrl, '_blank');
}
</script>
</body>
</html>
