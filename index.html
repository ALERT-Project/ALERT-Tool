<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9F9;
        }
        .category-2 { background-color: #4FD1C5; color: #134E4A; }
        .category-1 { background-color: #F6E05E; color: #1A202C; }
        .category-1-high { background-color: #F97316; color: #FFFFFF; }
        .unsafe { background-color: #FC8181; color: #1A202C; }
        .header-gradient {
            background: linear-gradient(to right, #0D9488, #0F766E);
        }
        .final-score-bg {
            background-color: #134E4A;
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 text-sm transition-colors duration-150;
        }
        .sub-label {
            @apply block text-sm font-medium text-gray-700;
        }
        .module-bg-a { background-color: #fff1f2; }
        .module-bg-b { background-color: #f0f9ff; }
        .module-bg-c { background-color: #f0fdf4; }
        .module-bg-d { background-color: #fffbeb; }
        .module-bg-e { background-color: #fef2f2; }
        .module-bg-f { background-color: #faf5ff; }
        .module-title {
            @apply font-bold text-xl mb-3 p-3 rounded-t-lg;
        }
        .remove-btn {
            @apply ml-2 text-red-500 hover:text-red-700 font-bold;
        }
        .mod-score {
            color: #2563EB; /* A distinct blue for modified scores */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="header-gradient p-6 flex items-center justify-center text-white">
                <div class="bg-white/20 rounded-full p-2 mr-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
            </div>
            <div class="p-6 bg-gray-50/50">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-6">Patient Details</h2>
                 <div class="grid grid-cols-1 gap-y-4 text-sm">
                     <div>
                         <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                         <input type="text" id="patientInitials" class="form-input bg-gray-100">
                     </div>
                     <div>
                         <label for="urnLast4" class="block font-medium text-gray-700">Last 4 Digits of URN:</label>
                         <input type="text" id="urnLast4" class="form-input bg-gray-100">
                     </div>
                      <div>
                         <label for="wardAndRoom" class="block font-medium text-gray-700">Ward & Room No.:</label>
                         <input type="text" id="wardAndRoom" class="form-input bg-gray-100" placeholder="e.g. Ward 5A, Room 12">
                     </div>
                     <div>
                         <label for="losDays" class="block font-medium text-gray-700">ICU LOS (days):</label>
                         <input type="number" id="losDays" min="0" class="form-input bg-gray-100">
                     </div>
                 </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Clinical Parameters</h2>
            <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-700 mb-4">A-E Assessment</h3>
                <div class="grid grid-cols-1 gap-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div><label class="sub-label">Airway</label><input type="text" id="airway_input" class="form-input" value="Patent"></div>
                        <div><label class="sub-label">Resp Rate</label><input type="number" id="rr_input" class="form-input vital-input"></div>
                        <div><label class="sub-label">SpO2 (%)</label><input type="number" id="spo2_input" class="form-input vital-input"></div>
                        <div>
                            <label class="sub-label">Oxygen Delivery</label>
                            <div class="flex items-center space-x-2">
                                 <input type="number" id="o2_flow_input" class="form-input vital-input" placeholder="Value">
                                 <select id="o2_unit_input" class="form-input vital-input"><option value="lpm">L/min</option><option value="fio2">% FiO2</option></select>
                            </div>
                        </div>
                        <div><label class="sub-label">Heart Rate</label><input type="number" id="hr_input" class="form-input vital-input"></div>
                        <div><label class="sub-label">SBP (mmHg)</label><input type="number" id="sbp_input" class="form-input vital-input"></div>
                        <div><label class="sub-label">DBP (mmHg)</label><input type="number" id="dbp_input" class="form-input"></div>
                        <div><label class="sub-label">Consciousness</label><select id="consciousness_input" class="form-input vital-input"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                        <div><label class="sub-label">Temp (°C)</label><input type="number" step="0.1" id="temp_input" class="form-input vital-input"></div>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-lg text-center border border-teal-200">
                        <span class="text-sm font-medium text-gray-500">CALCULATED ADDS</span>
                        <div id="calculatedADDSScore" class="font-bold text-5xl text-teal-600 my-2">0</div>
                        <div id="addsBreakdown" class="text-xs text-gray-600 min-h-[3em]">Normal Parameters</div>
                    </div>
                </div>
            </div>
             <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-700 mb-2">Modifications</h3>
                <div class="space-y-2">
                    <label class="flex items-center"><input type="checkbox" id="addsModificationCheckbox" class="vital-input"> <span class="ml-2 text-sm">Apply MODS to ADDS</span></label>
                    <div id="addsModificationDetails" class="hidden ml-6 mt-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="RR"> <span class="ml-2 font-medium">Resp Rate</span></label>
                                <div class="hidden mod-details space-y-2 pl-5 pt-2">
                                    <select data-param="rr" class="mod-operator form-input"><option value="between">Between</option><option value="less_than">Less than</option><option value="greater_than">Greater than</option></select>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="mod_rr_val1" placeholder="Min" class="form-input w-full">
                                        <span class="mod-val2-container" id="mod_rr_val2_container"><input type="number" id="mod_rr_val2" placeholder="Max" class="form-input w-full"></span>
                                    </div>
                                </div>
                            </div>
                             <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="HR"> <span class="ml-2 font-medium">Heart Rate</span></label>
                                <div class="hidden mod-details space-y-2 pl-5 pt-2">
                                    <select data-param="hr" class="mod-operator form-input"><option value="between">Between</option><option value="less_than">Less than</option><option value="greater_than">Greater than</option></select>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="mod_hr_val1" placeholder="Min" class="form-input w-full">
                                        <span class="mod-val2-container" id="mod_hr_val2_container"><input type="number" id="mod_hr_val2" placeholder="Max" class="form-input w-full"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="SpO2"> <span class="ml-2 font-medium">SpO2</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5 pt-2">
                                    <span class="text-sm font-semibold">Target &gt;</span>
                                    <input type="number" id="mod_spo2_lower" placeholder="e.g. 88" class="form-input w-full">
                                    <span class="text-sm">%</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="SBP"> <span class="ml-2 font-medium">SBP</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5 pt-2">
                                    <span class="text-sm font-semibold">Target &gt;</span>
                                    <input type="number" id="mod_sbp_lower" placeholder="e.g. 90" class="form-input w-full">
                                </div>
                            </div>
                            <div class="space-y-1 col-span-1 md:col-span-2">
                                <label class="flex items-center text-sm"><input type="checkbox" name="mod_param" value="FiO2"> <span class="ml-2 font-medium">FiO2</span></label>
                                <div class="hidden mod-details flex items-center space-x-2 pl-5 pt-2">
                                    <span class="text-sm font-semibold">FiO2 &lt;</span>
                                    <input type="number" id="mod_fio2_upper" placeholder="e.g. 40" class="form-input w-48">
                                     <span class="text-sm">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4">
                            <label for="addsModificationText" class="sub-label">Modification Rationale:</label>
                            <textarea id="addsModificationText" rows="2" class="form-input"></textarea>
                        </div>
                    </div>
                </div>
            </div>
             <div class="grid grid-cols-1 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Fluid Balance</h3>
                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                        <div><label class="sub-label">24hr Fluid Balance (mL)</label><input type="number" id="fbc_24hr_input" class="form-input fluid-input" placeholder="+/- mL" step="500"></div>
                        <div><label class="sub-label">Total ICU Balance (mL)</label><input type="number" id="fbc_total_input" class="form-input fluid-input" placeholder="+/- mL" step="500"></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Cognition</h3>
                    <div>
                        <label class="sub-label">AMT Score</label>
                        <select id="amt_score_input" class="form-input w-full sm:w-48"><option value="Unable to assess">Unable to assess</option><option value="4/4">4/4</option><option value="3/4">3/4</option><option value="2/4">2/4</option><option value="1/4">1/4</option><option value="0/4">0/4</option></select>
                    </div>
                </div>
            </div>
             <div class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-700 mb-2">Key Bloods</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div><label class="sub-label">Lactate</label><div class="flex space-x-2"><input type="number" step="0.1" id="lactate_input" class="form-input blood-input" placeholder="Current"><input type="number" step="0.1" id="lactate_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">Creatinine</label><div class="flex space-x-2"><input type="number" id="creatinine_input" class="form-input blood-input" placeholder="Current"><input type="number" id="creatinine_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">Albumin</label><div class="flex space-x-2"><input type="number" id="albumin_input" class="form-input blood-input" placeholder="Current"><input type="number" id="albumin_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">CRP</label><div class="flex space-x-2"><input type="number" id="crp_input" class="form-input blood-input" placeholder="Current"><input type="number" id="crp_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">Hb</label><div class="flex space-x-2"><input type="number" id="hb_input" class="form-input blood-input" placeholder="Current"><input type="number" id="hb_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">K+</label><div class="flex space-x-2"><input type="number" step="0.1" id="k_input" class="form-input blood-input" placeholder="Current"><input type="number" step="0.1" id="k_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                    <div><label class="sub-label">Mg++</label><div class="flex space-x-2"><input type="number" step="0.1" id="mg_input" class="form-input blood-input" placeholder="Current"><input type="number" step="0.1" id="mg_input_prev" class="form-input blood-input" placeholder="Prev."></div></div>
                </div>
                 <div class="mt-4 pt-4 border-t border-gray-300">
                    <label class="flex items-center">
                        <input type="checkbox" id="cts_cardiac_checkbox" class="blood-input">
                        <span class="ml-2 text-sm font-medium text-gray-700">CTS/Cardiac Patient (apply stricter K+/Mg++ targets)</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="scoringContainer">
            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
               <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
               <div class="space-y-6">
                    <div class="p-4 rounded-lg module-bg-a"><h3 class="module-title bg-rose-200 text-rose-800">Critical Risk Factors</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="15" data-id="crit_met" id="crit_met_checkbox"> <span class="ml-2">Currently in MET criteria (+15)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_adds4" id="crit_adds4_checkbox"> <span class="ml-2">ADDS Score ≥ 4 (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_lactate_high" id="crit_lactate_high_checkbox"> <span class="ml-2">Lactate ≥ 3.5 mmol/L (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_af"> <span class="ml-2">Unstable Atrial Fibrillation (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="crit_hb_drop" id="crit_hb_drop_checkbox"> <span class="ml-2">New Hb drop >20g/L OR Active Bleeding (+10)</span></label></div></div>
                    <div class="rounded-lg module-bg-b"><h3 class="module-title bg-blue-200 text-blue-800">Physiological & Respiratory Stability</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="0" data-id="adds_0" id="adds_0_radio" checked> <span class="ml-2">Current ADDS Score 0 (+0)</span></label><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="1" data-id="adds_1-2" id="adds_1-2_radio"> <span class="ml-2">Current ADDS Score 1-2 (+1)</span></label><label class="flex items-center"><input type="radio" name="adds_score" class="score-input" data-score="5" data-id="adds_3" id="adds_3_radio"> <span class="ml-2">Current ADDS Score 3 (+5)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="5" data-id="adds_worsening"> <span class="ml-2">Worsening ADDS Trend (last 12-24h) (+5)</span></label><hr class="my-3"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="10" data-id="resp_increasing_o2"> <span class="ml-2">Increasing O2 requirements in last 12h (+10)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="6" data-id="resp_rapid_wean"> <span class="ml-2">Rapid weaning of respiratory support in last 4h (+6)</span></label></div></div>
                    <div class="p-4 rounded-lg module-bg-c"><h3 class="module-title bg-green-200 text-green-800">Bloods</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_electrolytes" id="bloods_electrolytes"> <span class="ml-2">Abnormal Electrolytes (K+, Mg++, Na+, Phos) (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_lactate_mid" id="bloods_lactate_mid_checkbox"> <span class="ml-2">Lactate 2.0 - 3.4 (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_creatinine" id="bloods_creatinine_checkbox"> <span class="ml-2">Creatinine >200 µmol/L (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_albumin" id="bloods_albumin_checkbox"> <span class="ml-2">Albumin &lt;25 g/L (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_crp" id="bloods_crp_checkbox"> <span class="ml-2">CRP >100 mg/L (static/rising) (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_anaemia" id="bloods_anaemia_checkbox"> <span class="ml-2">Anaemia (Hb &lt; 80 g/L) (+3)</span></label></div></div>
                    <div class="p-4 rounded-lg module-bg-d"><h3 class="module-title bg-yellow-200 text-yellow-800">Clinical</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="0" data-id="pain_0" checked> <span class="ml-2 text-gray-500">Pain: None / Well Controlled</span></label><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="3" data-id="pain_iv"> <span class="ml-2">Pain: Requires regular IV/potent analgesia (+3)</span></label><label class="flex items-center"><input type="radio" name="pain_score" class="score-input" data-score="5" data-id="pain_pca"> <span class="ml-2">Pain: Poorly controlled / PCA (+5)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" data-id="fluid_0" id="fluid_0_radio" checked> <span class="ml-2 text-gray-500">Fluid Status: Euvolaemic</span></label><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="2" data-id="fluid_mild" id="fluid_mild_radio"> <span class="ml-2">Mild Dehydration/Overload (+2)</span></label><label class="flex items-center"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-id="fluid_sig" id="fluid_sig_radio"> <span class="ml-2">Significant Dehydration/Overload (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="0" data-id="diet_0" checked> <span class="ml-2 text-gray-500">Diet: Normal</span></label><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="2" data-id="diet_modified"> <span class="ml-2">Diet: Supplements / Modified (+2)</span></label><label class="flex items-center"><input type="radio" name="diet_score" class="score-input" data-score="4" data-id="diet_nbm"> <span class="ml-2">Diet: NBM / NG / TPN (+4)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="0" data-id="delirium_0" checked> <span class="ml-2 text-gray-500">Delirium: None</span></label><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="4" data-id="delirium_mild"> <span class="ml-2">Delirium: Mild / Subsyndromal (+4)</span></label><label class="flex items-center"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-id="delirium_mod"> <span class="ml-2">Delirium: Moderate to Severe (+8)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="0" data-id="mobility_0" checked> <span class="ml-2 text-gray-500">Mobility: At Baseline</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="1" data-id="mobility_limited"> <span class="ml-2">Mobility: Limited by devices/attachments (+1)</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="2" data-id="mobility_assisted"> <span class="ml-2">Mobility: Assisted (+2)</span></label><label class="flex items-center"><input type="radio" name="mobility_score" class="score-input" data-score="5" data-id="mobility_bedbound"> <span class="ml-2">Mobility: Bed-bound (+5)</span></label><hr class="my-2"><label class="flex items-center"><input type="radio" name="lines_score" class="score-input" data-score="0" data-id="lines_0" checked> <span class="ml-2 text-gray-500">Lines: None / PIVC only</span></label><label class="flex items-center"><input type="radio" name="lines_score" class="score-input" data-score="5" data-id="lines_cvc"> <span class="ml-2">Central Line present (CVC/PICC/Vascath) (+5)</span></label><hr class="my-3"><div class="space-y-2"><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="bowels_issue"> <span class="ml-2">Bowels: Not opened >3 days / Ileus (+3)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="5" data-id="airway_altered"> <span class="ml-2">Altered Airway (Tracheostomy/Laryngectomy) (+5)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="drains_high_risk"> <span class="ml-2">High-Risk Drain present (+3)</span></label></div><hr class="my-3"><div class="pt-2"><label class="flex items-center"><input type="radio" name="concern_score" class="score-input" data-score="0" data-id="concern_0" checked> <span class="ml-2 text-gray-500">Nursing Concern: None</span></label><label class="flex items-center"><input type="radio" name="concern_score" class="score-input" data-score="5" data-id="concern_present"> <span class="ml-2">Nursing Concern Present (+5)</span></label><textarea id="nursingConcernText" class="mt-2 ml-6 w-full rounded-md border-gray-300 shadow-sm text-sm" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div></div>
                    <div class="p-4 rounded-lg module-bg-e"><h3 class="module-title bg-red-200 text-red-800">Systemic</h3><div class="space-y-2 p-4"><label class="flex items-center"><input type="checkbox" id="losCheckbox" class="score-input" data-score="4" data-id="systemic_los"> <span class="ml-2">LOS > 3 days (+4)</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="0" data-id="frailty_0" checked> <span class="ml-2 text-gray-500">Frailty: Not Frail</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="2" data-id="frailty_mild"> <span class="ml-2">Frailty: Mild (+2)</span></label><label class="flex items-center"><input type="radio" name="frailty_score" class="score-input" data-score="4" data-id="frailty_mod"> <span class="ml-2">Frailty: Mod-Severe (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="4" id="comorbiditiesCheckbox" data-id="systemic_comorbid"> <span class="ml-2"><span class="comorbidity-main-text">≥3 chronic comorbidities</span> <span class="text-gray-400 text-xs">(e.g. IHD, COPD, T2DM)</span> (+4)</span></label><label class="flex items-center"><input type="checkbox" class="score-input" data-score="3" data-id="systemic_ooh"> <span class="ml-2">Out-of-Hours Discharge (+3)</span></label></div></div>
               </div>
           </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Post-ICU Syndrome (PICS) Screening</h2>
            <div class="p-4 rounded-lg module-bg-f">
                <div class="space-y-2 p-4">
                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                        <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="negative" checked> <span class="ml-2">Negative</span></label>
                        <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="positive"> <span class="ml-2">Positive</span></label>
                        <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="unable"> <span class="ml-2">Unable to assess</span></label>
                    </div>
                    <div id="pics_unable_details" class="hidden ml-6 mt-2">
                        <label for="pics_unable_notes" class="sub-label">Reason:</label>
                        <textarea id="pics_unable_notes" rows="2" class="form-input"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <div class="final-score-bg text-white rounded-xl shadow-lg p-6">
                 <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                    <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">TOTAL SCORE</span><div id="totalScore" class="text-5xl font-bold">0</div></div>
                    <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="riskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300">Category 2: Standard follow-up</div></div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Optional Narrative Details for DMR</h2>
            <div class="space-y-6 text-sm">
                <div><label for="admissionReason" class="block font-medium text-gray-600">Reason for ICU Admission:</label><textarea id="admissionReason" rows="3" class="form-input"></textarea></div>
                <div><label for="pmh" class="block font-medium text-gray-600">Past Medical History (PMH):</label><textarea id="pmh" rows="5" class="form-input"></textarea></div>
                <div><label for="icuSummary" class="block font-medium text-gray-600">ICU Summary / Timeline:</label><textarea id="icuSummary" rows="10" class="form-input"></textarea></div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-4">Lines, Drains & Wounds</h3>
                    <div class="grid grid-cols-1 gap-8">
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">Vascular Access & Fixed Devices</h4>
                            <div class="space-y-4">
                                <label class="flex items-center"><input type="checkbox" id="device_cvc"> <span class="ml-2">CVC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_picc"> <span class="ml-2">PICC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_vascath"> <span class="ml-2">Vascath</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_idc"> <span class="ml-2">IDC</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_ng"> <span class="ml-2">NG Tube</span></label>
                                <label class="flex items-center"><input type="checkbox" id="device_pacing_wire"> <span class="ml-2">Epicardial Pacing Wires</span></label>
                                
                                <div class="pt-2">
                                    <h5 class="font-medium text-gray-600 mb-2 text-sm">PIVCs</h5>
                                    <div id="pivcs_container" class="space-y-2"></div>
                                    <button type="button" id="addPivcButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add PIVC</button>
                                </div>
                                <div class="pt-2">
                                    <h5 class="font-medium text-gray-600 mb-2 text-sm">Other Devices</h5>
                                    <div id="other_devices_container" class="space-y-2"></div>
                                    <button type="button" id="addOtherDeviceButton" class="mt-2 text-sm bg-indigo-100 text-indigo-800 hover:bg-indigo-200 px-3 py-1 rounded-md">+ Add Other Device</button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                             <div>
                                <h4 class="font-medium text-gray-600 mb-2">Drains</h4>
                                <div id="drains_container" class="space-y-2"></div>
                                <button type="button" id="addDrainButton" class="mt-2 text-sm bg-teal-100 text-teal-800 hover:bg-teal-200 px-3 py-1 rounded-md">+ Add Drain</button>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 mb-2">Wounds</h4>
                                <div id="wounds_container" class="space-y-2"></div>
                                <button type="button" id="addWoundButton" class="mt-2 text-sm bg-pink-100 text-pink-800 hover:bg-pink-200 px-3 py-1 rounded-md">+ Add Wound</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div><label for="impression" class="block font-medium text-gray-600">Impression:</label><textarea id="impression" rows="4" class="form-input"></textarea></div>
                <div><label for="emrAdditionalNotes" class="block font-medium text-gray-600">Additional Plan Notes:</label><textarea id="emrAdditionalNotes" rows="4" class="form-input"></textarea></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">DMR Summary Generator</h2>
            <div class="flex space-x-4 mb-4"><button id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Generate DMR Summary</button><button id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Copy to Clipboard</button></div>
            <textarea id="emrSummary" rows="15" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" readonly placeholder="Your summary will appear here..."></textarea>
            <div class="mt-6 text-center"><button id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reset Form</button></div>
        </div>
    </div>
    
    <div class="text-center mt-8 text-gray-500 text-sm">Major update version 2.3 - Professional Format III</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const scoreInputs = document.querySelectorAll('.score-input');
            const totalScoreEl = document.getElementById('totalScore');
            const riskCategoryEl = document.getElementById('riskCategory');
            const resetButton = document.getElementById('resetButton');
            const generateSummaryButton = document.getElementById('generateSummaryButton');
            const copySummaryButton = document.getElementById('copySummaryButton');
            const emrSummaryEl = document.getElementById('emrSummary');
            const bloodInputs = document.querySelectorAll('.blood-input');
            const calculatedADDSEl = document.getElementById('calculatedADDSScore');
            const addsBreakdownEl = document.getElementById('addsBreakdown');
            const addsModCheckbox = document.getElementById('addsModificationCheckbox');
            const addsModDetails = document.getElementById('addsModificationDetails');
            const addDrainButton = document.getElementById('addDrainButton');
            const drainsContainer = document.getElementById('drains_container');
            const addWoundButton = document.getElementById('addWoundButton');
            const woundsContainer = document.getElementById('wounds_container');
            const addPivcButton = document.getElementById('addPivcButton');
            const pivcsContainer = document.getElementById('pivcs_container');
            const addOtherDeviceButton = document.getElementById('addOtherDeviceButton');
            const otherDevicesContainer = document.getElementById('other_devices_container');
            const picsRadios = document.querySelectorAll('input[name="pics_status"]');
            const picsUnableDetails = document.getElementById('pics_unable_details');
            const vitalInputs = document.querySelectorAll('.vital-input');
            const modParamCheckboxes = document.querySelectorAll('input[name="mod_param"]');
            const modOperators = document.querySelectorAll('.mod-operator');
            const nursingConcernRadios = document.querySelectorAll('input[name="concern_score"]');
            const nursingConcernText = document.getElementById('nursingConcernText');
            
            // --- Data Maps & State ---
            let currentAddsBreakdown = 'Normal Parameters';
            const categoryMap = {'unsafe':'Unsafe for Ward: Immediate senior review required','category-1-high':'Category 1 - High Risk: Escalate to ALERT medical rounding team','category-1':'Category 1: Enhanced follow-up for 72 hours','category-2':'Category 2: Standard follow-up'};
            const carePlanMap = {
                'crit_met': 'CRITICAL: Patient is in MET criteria. Initiate MET call and immediate resuscitation as per local protocol.',
                'crit_adds4': 'CRITICAL: High ADDS score indicates significant physiological distress. Escalate for urgent medical review (<30 mins).',
                'crit_lactate_high': 'CRITICAL: Lactate >3.5 suggests severe tissue hypoperfusion. Escalate for immediate senior medical review for management of shock.',
                'crit_af': 'CRITICAL: Unstable AF requires urgent intervention. Escalate for cardiology/medical review, prepare for 12-lead ECG and potential cardioversion.',
                'crit_hb_drop': 'CRITICAL: Significant Hb drop or active bleeding requires urgent investigation. Escalate for urgent medical/surgical review, consider cross-match.',
                'resp_increasing_o2': 'Assess for new signs of respiratory distress (work of breathing, accessory muscle use, auscultation). Liaise with medical team to consider CXR/ABG.',
                'resp_rapid_wean': 'Increase frequency of respiratory observations (RR, SpO2, WOB) for next 4-6 hours to monitor for signs of fatigue or impending failure.',
                'bloods_electrolytes': 'Monitor electrolyte trends and ensure replacement therapy is prescribed and administered in a timely manner. Consider cardiac monitoring for severe K+ abnormalities.',
                'bloods_lactate_mid': 'Liaise with medical team for serial lactate measurements (e.g., 4-6 hourly) to ensure clearance, indicating response to resuscitation/treatment.',
                'bloods_creatinine': 'Maintain strict fluid balance chart, ensuring accurate measurement of urine output (>0.5ml/kg/hr). Liaise with pharmacy to review for nephrotoxic medications.',
                'bloods_albumin': 'Ensure active dietitian referral for nutritional assessment. Monitor closely for peripheral/pulmonary oedema and signs of poor wound healing.',
                'bloods_crp': 'Continue vigilant monitoring for signs of sepsis (Sepsis Kills pathway). Ensure timely administration of antibiotics if prescribed and follow up on microbiology.',
                'bloods_anaemia': 'Monitor for signs of occult bleeding (melaena, haematemesis) or haemodynamic instability. Liaise with medical team to clarify transfusion threshold.',
                'pain_iv': 'Perform comprehensive pain assessment using a validated tool. Ensure multimodal analgesia is optimised to reduce opioid load. Escalate to Acute Pain Service if poorly controlled.',
                'pain_pca': 'Perform comprehensive pain assessment, including sedation scoring. Ensure regular checks of respiratory rate and naloxone availability. Escalate to APS if pain remains severe.',
                'fluid_sig': 'Maintain strict FBC, including daily weights. Perform clinical fluid assessment (JVP, peripheral oedema, lung auscultation). Liaise with medical team to review fluid orders/consider diuretics.',
                'fluid_mild': 'Maintain strict fluid balance chart and perform twice-daily clinical fluid assessment to monitor trend.',
                'diet_nbm': 'Confirm feeding plan with medical team and dietitian, including caloric/protein targets. Ensure meticulous NG/PEG care and monitor for signs of intolerance.',
                'diet_modified': 'Ensure appropriate referrals to Dietitian/Speech Pathology are active. Closely monitor and document oral intake and tolerance.',
                'delirium_mod': 'Implement delirium care bundle: Frequent reorientation, maintain day/night cycle, encourage family presence, review chart for deliriogenic agents (e.g. anticholinergics, benzodiazepines).',
                'delirium_mild': 'Implement delirium prevention strategies. Screen formally with CAM-ICU/4AT. Minimise tethers and promote early mobilisation.',
                'mobility_bedbound': 'Implement pressure injury prevention bundle: Regular turns (2-4 hourly), pressure-relieving mattress, skin assessment. Liaise with physio for in-bed exercise plan.',
                'mobility_assisted': 'Ensure Physiotherapy referral is active and recommendations are followed. Implement falls risk mitigation strategies.',
                'mobility_limited': 'Liaise with Physiotherapy for a safe mobilisation plan that accounts for device management. Ensure adequate staff assistance is planned for all transfers.',
                'airway_altered': 'Confirm ward staff competency with tracheostomy/laryngectomy care. Ensure emergency equipment (e.g., spare tube, obturator) is present at bedside.',
                'lines_cvc': 'Perform daily review of Central Line necessity with medical team (line days). Maintain strict ANTT for all access and monitor site for signs of infection.',
                'drains_high_risk': 'Maintain vigilance over drain patency and output characteristics/volume. Escalate any sudden changes or signs of blockage to the parent surgical/medical team.',
                'bowels_issue': 'Implement institutional bowel management protocol. Monitor for abdominal distension and listen for bowel sounds. Escalate if signs of ileus develop.',
                'concern_present': "Articulate specific nursing concerns and escalate to senior nursing/medical staff for a 'fresh eyes' review of the patient's trajectory.",
                'frailty_mod': 'Ensure comprehensive geriatric assessment referrals are in place (Geriatrics, OT, Physio). Focus on safe mobilisation, nutritional support, and cognitive stimulation.',
                'frailty_mild': 'Focus on preventing deconditioning through active engagement with physiotherapy. Be mindful of increased risk of falls and delirium.',
                'systemic_comorbid': 'Confirm relevant specialty teams have been consulted and a consolidated, communicated management plan is in place to avoid conflicting treatments.',
                'systemic_ooh': 'Provide a detailed, structured handover to the after-hours team, highlighting key risks and specific parameters for escalation (e.g., "Call if SBP < 100 or RR > 24").'
            };
            const assessmentNarrativeMap = {'crit_met':'currently in MET criteria','crit_adds4':'a high ADDS score','crit_lactate_high':'a critically high lactate','crit_af':'unstable atrial fibrillation','crit_hb_drop':'a significant drop in haemoglobin or active bleeding','adds_worsening':'a worsening trend in observations','resp_increasing_o2':'increasing oxygen requirements','resp_rapid_wean':'a recent rapid wean of respiratory support','bloods_lactate_mid':'a moderately elevated lactate','bloods_creatinine':'a significant renal impairment','bloods_albumin':'hypoalbuminaemia, indicating nutritional risk','bloods_crp':'a significant inflammatory response (CRP > 100)','pain_pca':'poorly controlled pain requiring advanced analgesia','fluid_sig':'a significant fluid imbalance','diet_nbm':'is receiving no oral nutrition (NBM/NG/TPN)','delirium_mod':'moderate to severe delirium','mobility_bedbound':'is currently bed-bound with significant mobility deficits', 'mobility_limited':'mobility is limited by devices/attachments', 'airway_altered':'a surgically altered airway (tracheostomy/laryngectomy)','concern_present':'specific concerns raised by the bedside nurse'};
            const standardScores = { getRrScore(rr) { let s=0,m=false; if(rr>=36||rr<5)m=true;else if(rr>=30&&rr<=35)s=3;else if(rr>=25&&rr<=29)s=2;else if(rr>=21&&rr<=24)s=1;else if(rr>=5&&rr<=9)s=3; return {score:s, isMet:m}; }, getSpo2Score(spo2) { let s=0,m=false; if(spo2<=84)m=true;else if(spo2>=85&&spo2<=90)s=2;else if(spo2>=91&&spo2<=93)s=1; return {score:s, isMet:m}; }, getO2Score(o2Flow, o2Unit) { let s=0; if(o2Unit==='lpm'){if(o2Flow>10)s=3;else if(o2Flow>=5&&o2Flow<=9)s=2;else if(o2Flow>=2&&o2Flow<=4)s=1}else{if(o2Flow>=40)s=3;else if(o2Flow>=29)s=2;else if(o2Flow>=21)s=1} return {score:s, isMet:false}; }, getHrScore(hr) { let s=0,m=false; if(hr>=140||hr<30)m=true;else if(hr>=130&&hr<=139)s=3;else if(hr>=120&&hr<=129)s=2;else if(hr>=100&&hr<=119)s=1;else if(hr>=40&&hr<=49)s=1;else if(hr>=30&&hr<=39)s=2; return {score:s, isMet:m}; }, getSbpScore(sbp) { let s=0,m=false; if(sbp<90)m=true;else if(sbp>=190&&sbp<=199)s=3;else if(sbp>=180&&sbp<=189)s=2;else if(sbp>=150&&sbp<=179)s=1;else if(sbp>=80&&sbp<=99)s=1;else if(sbp>=70&&sbp<=79)s=2; return {score:s, isMet:m}; } };
            
            // --- Helper Functions ---
            const safeGet = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
            const safeIsChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
            const getSelectText = (id) => {
                const el = document.getElementById(id);
                if (el && el.selectedIndex > -1) { return el.options[el.selectedIndex].text; }
                return '';
            };
            const getTrendText = (current, previous, higherIsWorse = true) => {
                const curr = parseFloat(current);
                const prev = parseFloat(previous);
                if (isNaN(curr) || isNaN(prev)) return '';
                if (Math.abs(curr - prev) < (curr * 0.05) && Math.abs(curr - prev) < 1) return '(static)';
                if (higherIsWorse) {
                    return curr > prev ? '(worsening)' : '(improving)';
                } else {
                    return curr < prev ? '(worsening)' : '(improving)';
                }
            };
            const generateImpression = () => {
                const narratives = [];
                scoreInputs.forEach(input => {
                    if (input.checked && input.dataset.score !== "0") {
                        const id = input.dataset.id;
                        if (assessmentNarrativeMap[id]) narratives.push(assessmentNarrativeMap[id]);
                    }
                });
                if (narratives.length === 0) return 'Patient appears clinically stable with no major risk factors identified on review. Continue routine ward monitoring.';
                let impression = `Patient presents with an elevated risk score, primarily driven by: ${narratives.join(', ')}. `;
                const concernText = safeGet('nursingConcernText');
                if (safeIsChecked('concern_present') && concernText.trim()) {
                    impression += `Bedside team has also flagged specific concerns regarding: "${concernText.trim()}". `;
                }
                impression += 'Requires close monitoring and adherence to the plan below to mitigate risk of deterioration.';
                return impression;
            };

            // --- Core Functions ---
            function generateSummary() {
                try {
                    const output = [];
                    const los = safeGet('losDays');
                    const now = new Date();
                    const timeOfReview = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
                    
                    const getDischargeCategory = () => {
                        const text = riskCategoryEl.textContent;
                        if (text.includes('Unsafe')) return 'Unsafe for Ward Discharge';
                        if (text.includes('Category 1 - High Risk')) return 'Cat 1 High Risk Discharge';
                        if (text.includes('Category 1:')) return 'Cat 1 Discharge';
                        return 'Cat 2 Standard Discharge';
                    };

                    // ==== HEADER ====
                    output.push('ALERT CNS post ICU review');
                    if (los) output.push(`ICU LOS: ${los} days`);
                    output.push(getDischargeCategory());
                    output.push(`Time of review: ${timeOfReview}`);
                    output.push('');
                    
                    const admissionReason = safeGet('admissionReason').trim();
                    const pmh = safeGet('pmh').trim();
                    const userImpression = safeGet('impression').trim();
                    if (admissionReason) output.push(`Reason for admission: ${admissionReason}`);
                    if (pmh) output.push(`PMH: ${pmh}`);
                    output.push(`Impression: ${userImpression || generateImpression()}`);
                    output.push('');

                    // ==== ADDS/MODS ====
                    let addsLine = `ADDS: ${calculatedADDSEl.textContent}`;
                    if (currentAddsBreakdown && currentAddsBreakdown !== 'Normal Parameters') {
                        addsLine += ` (Triggers: ${currentAddsBreakdown})`;
                    }
                    output.push(addsLine);
                    if (safeIsChecked('addsModificationCheckbox')) {
                        output.push(`MODS Active: ${safeGet('addsModificationText') || 'Rationale not specified.'}`);
                    }
                    output.push('');
                    
                    // ==== SYSTEMS REVIEW ====
                    output.push('---- SYSTEMS REVIEW ----');

                    // A-E Assessment re-added here
                    const airway = safeGet('airway_input');
                    const rr = safeGet('rr_input'), spo2 = safeGet('spo2_input'), o2_flow = safeGet('o2_flow_input'), o2_unit = safeGet('o2_unit_input');
                    let o2_delivery = 'on Room Air.';
                    if (o2_flow && parseFloat(o2_flow) > 0) {
                        o2_delivery = `on ${o2_flow}${o2_unit === 'lpm' ? 'L via Nasal Prongs' : '% FiO2'}.`;
                    }
                    const hr = safeGet('hr_input'), sbp = safeGet('sbp_input'), dbp = safeGet('dbp_input');
                    const consciousness = getSelectText('consciousness_input');
                    const temp = safeGet('temp_input');
                    const amt = getSelectText('amt_score_input');
                    
                    output.push('Clinical Observations:');
                    output.push(`  A: ${airway}`);
                    output.push(`  B: RR ${rr || 'N/A'}, SpO2 ${spo2 || 'N/A'}% ${o2_delivery}`);
                    output.push(`  C: HR ${hr || 'N/A'}, BP ${sbp || 'N/A'}/${dbp || 'N/A'} mmHg.`);
                    output.push(`  D: AVPU-${consciousness}. AMT ${amt}.`);
                    output.push(`  E: Temp ${temp || 'N/A'} C.`);
                    
                    const bloods = [];
                    const formatBlood = (label, currId, prevId, unit, higherIsWorse = true, normalRange = null) => {
                        const curr = safeGet(currId), prev = safeGet(prevId);
                        if (!curr) return;
                        let interpretation = '';
                        if (normalRange) {
                            const val = parseFloat(curr);
                            if (val < normalRange[0]) interpretation = ' (low)';
                            if (val > normalRange[1]) interpretation = ' (high)';
                        }
                        bloods.push(`  - ${label}: ${curr}${unit} ${getTrendText(curr, prev, higherIsWorse)}${interpretation}`);
                    };
                    formatBlood('Hb', 'hb_input', 'hb_input_prev', ' g/L', false, [115, 165]);
                    formatBlood('K+', 'k_input', 'k_input_prev', ' mmol/L', true, [3.5, 5.2]);
                    formatBlood('Creatinine', 'creatinine_input', 'creatinine_input_prev', ' umol/L', true, [60, 110]);
                    formatBlood('Lactate', 'lactate_input', 'lactate_input_prev', ' mmol/L', true, [0.5, 2.0]);
                    formatBlood('CRP', 'crp_input', 'crp_input_prev', ' mg/L', true, [0, 5]);
                    formatBlood('Albumin', 'albumin_input', 'albumin_input_prev', ' g/L', false, [35, 50]);
                    if (bloods.length > 0) {
                        output.push('Bloods:');
                        output.push(...bloods);
                    }
                    
                    const fbc24 = safeGet('fbc_24hr_input'), fbcTotal = safeGet('fbc_total_input');
                    if (fbc24 || fbcTotal) {
                        let fluidText = 'Fluid Balance: ';
                        if (fbc24) fluidText += `24hr: ${parseFloat(fbc24) >= 0 ? '+' : ''}${fbc24}mL. `;
                        if (fbcTotal) fluidText += `Cumulative: ${parseFloat(fbcTotal) >= 0 ? '+' : ''}${fbcTotal}mL.`;
                        output.push(fluidText);
                    }
                    
                    const devices = [], pivcs = [], drains = [], wounds = [];
                    document.querySelectorAll('#device_cvc, #device_picc, #device_vascath, #device_idc, #device_ng, #device_pacing_wire').forEach(el => { if(el.checked) devices.push(el.nextElementSibling.textContent); });
                    document.querySelectorAll('#other_devices_container input').forEach(el => { if (el.value.trim()) devices.push(el.value.trim()); });
                    document.querySelectorAll('#pivcs_container input').forEach(el => { if (el.value.trim()) pivcs.push(el.value.trim()); });
                    document.querySelectorAll('#drains_container input').forEach(el => { if (el.value.trim()) drains.push(el.value.trim()); });
                    document.querySelectorAll('#wounds_container input').forEach(el => { if (el.value.trim()) wounds.push(el.value.trim()); });
                    if (devices.length > 0 || pivcs.length > 0 || drains.length > 0 || wounds.length > 0) {
                         output.push('Lines, Drains & Wounds:');
                         if (pivcs.length > 0) output.push(`  - PIVCs: ${pivcs.join(', ')}.`);
                         if (devices.length > 0) output.push(`  - Devices: ${devices.join(', ')}.`);
                         if (drains.length > 0) output.push(`  - Drains: ${drains.join(', ')}.`);
                         if (wounds.length > 0) output.push(`  - Wounds: ${wounds.join(', ')}.`);
                    }
                    
                    const picsStatus = document.querySelector('input[name="pics_status"]:checked').value;
                    if (picsStatus !== 'negative') {
                        let picsLine = 'PICS Screen: Positive.';
                        if (picsStatus === 'unable') picsLine = `PICS Screen: Unable to assess. Reason: ${safeGet('pics_unable_notes') || 'Not specified.'}`;
                        output.push(picsLine);
                    }
                    output.push('');
                    
                    // ==== PLAN ====
                    output.push('---- PLAN ----');
                    const planItems = {};
                    const planCategoryMap = {'crit_': 'CRITICAL RISKS - IMMEDIATE ACTION', 'resp_': 'Respiratory Plan', 'adds_': 'Observations Plan', 'bloods_': 'Biochemical / Haematology Plan', 'fluid_': 'Fluid Management Plan', 'pain_': 'Pain Management', 'diet_': 'Nutrition Plan', 'bowels_': 'Bowel Management', 'delirium_': 'Cognitive Support', 'mobility_': 'Mobility & Pressure Care', 'airway_': 'Airway Management', 'lines_': 'Line & Device Management', 'drains_': 'Drain Management', 'concern_': 'Nursing Concerns', 'systemic_': 'Systemic / Other', 'frailty_': 'Frailty Plan'};
                    scoreInputs.forEach(input => {
                        if (input.checked && input.dataset.score !== "0") {
                            const id = input.dataset.id;
                            if (carePlanMap[id]) {
                                for (const prefix in planCategoryMap) {
                                    if (id.startsWith(prefix)) {
                                        const category = planCategoryMap[prefix];
                                        if (!planItems[category]) planItems[category] = [];
                                        planItems[category].push(`- ${carePlanMap[id]}`);
                                        break;
                                    }
                                }
                            }
                        }
                    });

                    const sortedCategories = Object.keys(planItems).sort((a, b) => a.includes('CRITICAL') ? -1 : 1);
                    if (sortedCategories.length > 0) {
                        sortedCategories.forEach(category => {
                            output.push(category + ':');
                            output.push(...planItems[category]);
                        });
                    } else {
                        output.push('- Continue with standard ward-based care and observations.');
                    }

                    const additionalNotes = safeGet('emrAdditionalNotes').trim();
                    if (additionalNotes) {
                        output.push('Additional Plan Notes:');
                        additionalNotes.split('\n').forEach(line => output.push(`- ${line}`));
                    }
                    output.push('');
                    output.push('Reviewed by ALERT CNS. Please escalate any concerns.');

                    emrSummaryEl.value = output.join('\n');
                } catch (error) {
                    emrSummaryEl.value = `An error occurred while generating the summary. Please check your inputs.\n\nError: ${error.message}`;
                    console.error("Summary generation failed:", error);
                }
            }

            function handleBloodInputs() {
                const getF = (id) => parseFloat(safeGet(id));
                const check = (id, condition) => { const el = document.getElementById(id); if (el) el.checked = condition; };
                const lactate = getF('lactate_input');
                if (!isNaN(lactate)) { check('crit_lactate_high_checkbox', lactate >= 3.5); check('bloods_lactate_mid_checkbox', lactate >= 2.0 && lactate < 3.5); }
                const creatinine = getF('creatinine_input');
                if (!isNaN(creatinine)) check('bloods_creatinine_checkbox', creatinine > 200);
                const albumin = getF('albumin_input');
                if (!isNaN(albumin)) check('bloods_albumin_checkbox', albumin < 25);
                const crp = getF('crp_input');
                if (!isNaN(crp)) check('bloods_crp_checkbox', crp > 100);
                const hb = getF('hb_input'), hb_prev = getF('hb_input_prev');
                if (!isNaN(hb)) check('bloods_anaemia_checkbox', hb < 80);
                if (!isNaN(hb) && !isNaN(hb_prev)) check('crit_hb_drop_checkbox', (hb_prev - hb) > 20);
                const k = getF('k_input'), mg = getF('mg_input'), isCardiac = safeIsChecked('cts_cardiac_checkbox');
                let abnormalElectrolytes = false;
                if (!isNaN(k)) { if ((isCardiac && (k < 4.0 || k > 5.0)) || (!isCardiac && (k < 3.5 || k > 5.2))) abnormalElectrolytes = true; }
                if (!isNaN(mg)) { if ((isCardiac && (mg < 0.8 || mg > 1.0)) || (!isCardiac && (mg < 0.7 || mg > 1.0))) abnormalElectrolytes = true; }
                check('bloods_electrolytes', abnormalElectrolytes);
                calculateScore();
            }

            function addDynamicInput(container, placeholder) { const row = document.createElement('div'); row.className = 'flex items-center'; row.innerHTML = `<input type="text" placeholder="${placeholder}" class="form-input flex-grow"><button type="button" class="remove-btn">✖</button>`; container.appendChild(row); }
            function resetForm(){
                document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el=>{if(el.type==='select-one'){el.selectedIndex=0}else{el.value=''}});
                document.querySelectorAll('input[type="checkbox"]').forEach(input=>input.checked=false);
                document.querySelectorAll('input[type="radio"]').forEach(rb=>{if(rb.dataset.score==="0" || rb.value==="negative"){rb.checked=true}});
                document.getElementById('airway_input').value='Patent'; document.querySelector('input[name="concern_score"][data-score="0"]').checked=true; nursingConcernText.style.display='none';
                drainsContainer.innerHTML=''; addDynamicInput(drainsContainer, 'Drain type & site...');
                woundsContainer.innerHTML=''; addDynamicInput(woundsContainer, 'Wound location & description...');
                pivcsContainer.innerHTML=''; addDynamicInput(pivcsContainer, 'e.g., Pink 20G Lt forearm...');
                otherDevicesContainer.innerHTML = ''; addDynamicInput(otherDevicesContainer, 'Other device...');
                picsUnableDetails.classList.add('hidden'); document.getElementById('pics_unable_notes').value = '';
                document.querySelectorAll('.mod-details').forEach(el => el.classList.add('hidden'));
                emrSummaryEl.value = '';
                calculateADDS();
            }
            function calculateADDS() {
                let adds = 0; let met = false;
                const breakdownReasons = [];
                const modsActive = safeIsChecked('addsModificationCheckbox');
                const getMod = (name) => modsActive && document.querySelector(`input[name="mod_param"][value="${name}"]`).checked;
                
                const rr = parseInt(safeGet('rr_input'), 10);
                if (!isNaN(rr)) {
                    let applyScore = true;
                    if (getMod('RR')) {
                        const op = document.querySelector('[data-param="rr"]').value;
                        const v1 = parseFloat(safeGet('mod_rr_val1'));
                        const v2 = parseFloat(safeGet('mod_rr_val2'));
                        if (op === 'between' && !isNaN(v1) && !isNaN(v2) && (rr >= v1 && rr <= v2)) applyScore = false;
                        if (op === 'less_than' && !isNaN(v1) && rr < v1) applyScore = false;
                        if (op === 'greater_than' && !isNaN(v1) && rr > v1) applyScore = false;
                    }
                    if (applyScore) {
                        const res = standardScores.getRrScore(rr);
                        adds += res.score;
                        met = met || res.isMet;
                        if (res.score > 0) breakdownReasons.push(`RR ${rr} (+${res.score})`);
                    }
                }

                const hr = parseInt(safeGet('hr_input'), 10);
                if (!isNaN(hr)) {
                    let applyScore = true;
                     if (getMod('HR')) {
                        const op = document.querySelector('[data-param="hr"]').value;
                        const v1 = parseFloat(safeGet('mod_hr_val1'));
                        const v2 = parseFloat(safeGet('mod_hr_val2'));
                        if (op === 'between' && !isNaN(v1) && !isNaN(v2) && (hr >= v1 && hr <= v2)) applyScore = false;
                        if (op === 'less_than' && !isNaN(v1) && hr < v1) applyScore = false;
                        if (op === 'greater_than' && !isNaN(v1) && hr > v1) applyScore = false;
                    }
                    if (applyScore) {
                        const res = standardScores.getHrScore(hr);
                        adds += res.score;
                        met = met || res.isMet;
                        if (res.score > 0) breakdownReasons.push(`HR ${hr} (+${res.score})`);
                    }
                }
                
                const sbp = parseInt(safeGet('sbp_input'),10); if (!isNaN(sbp)) { let applyScore = true; if(getMod('SBP')) { const l = parseFloat(safeGet('mod_sbp_lower')); if(!isNaN(l) && sbp >= l) applyScore = false; } if(applyScore) { const res = standardScores.getSbpScore(sbp); adds+=res.score; met=met||res.isMet; if(res.score > 0) breakdownReasons.push(`SBP ${sbp} (+${res.score})`);} }
                const spo2 = parseInt(safeGet('spo2_input'),10); if (!isNaN(spo2)) { let applyScore = true; if(getMod('SpO2')) { const l = parseFloat(safeGet('mod_spo2_lower')); if(!isNaN(l) && spo2 >= l) applyScore = false; } if(applyScore) { const res = standardScores.getSpo2Score(spo2); adds+=res.score; met=met||res.isMet; if(res.score > 0) breakdownReasons.push(`SpO2 ${spo2}% (+${res.score})`);} }
                const o2Flow = parseFloat(safeGet('o2_flow_input')); const o2Unit = safeGet('o2_unit_input'); if (!isNaN(o2Flow) && o2Flow > 0) { let applyScore = true; if(getMod('FiO2')) { const u = parseFloat(safeGet('mod_fio2_upper')); if(!isNaN(u) && o2Flow < u) applyScore = false; } if(applyScore) { const res = standardScores.getO2Score(o2Flow, o2Unit); adds+=res.score; if(res.score > 0) breakdownReasons.push(`O2 ${o2Flow}${o2Unit === 'lpm' ? 'L/min' : '%'} (+${res.score})`);} }
                const temp = parseFloat(safeGet('temp_input')); if (!isNaN(temp)) { let tempScore = 0; if(temp>=38.6||temp<35.1) tempScore=2; else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36)) tempScore=1; if(tempScore > 0) { adds+=tempScore; breakdownReasons.push(`Temp ${temp}C (+${tempScore})`);}}
                const consciousness = parseInt(safeGet('consciousness_input'),10); if (!isNaN(consciousness)) { if(consciousness===3)met=true;else if (consciousness > 0) { adds+=consciousness; breakdownReasons.push(`${getSelectText('consciousness_input')} (+${consciousness})`);} }
                
                calculatedADDSEl.textContent = met ? 'MET' : adds; calculatedADDSEl.classList.remove('mod-score', 'text-red-600', 'text-teal-600');
                if (met) { calculatedADDSEl.classList.add('text-red-600'); } else if (modsActive) { calculatedADDSEl.textContent = `MODS ${adds}`; calculatedADDSEl.classList.add('mod-score'); } else { calculatedADDSEl.classList.add('text-teal-600'); }
                if (breakdownReasons.length > 0) { currentAddsBreakdown = breakdownReasons.join(', '); } else { currentAddsBreakdown = 'Normal Parameters'; }
                addsBreakdownEl.textContent = currentAddsBreakdown;
                document.getElementById('crit_met_checkbox').checked=met;document.getElementById('crit_adds4_checkbox').checked=false;document.getElementById('adds_0_radio').checked=false;document.getElementById('adds_1-2_radio').checked=false;document.getElementById('adds_3_radio').checked=false;
                if(!met&&adds>=4)document.getElementById('crit_adds4_checkbox').checked=true;else if(!met&&adds===3)document.getElementById('adds_3_radio').checked=true;else if(!met&&adds>=1)document.getElementById('adds_1-2_radio').checked=true;else if(!met)document.getElementById('adds_0_radio').checked=true;
                calculateScore();
            }
            
            function calculateScore(){let total=0;scoreInputs.forEach(input=>{if(input.checked&&input.dataset.score!=="0"){total+=parseInt(input.dataset.score,10)}});totalScoreEl.textContent=total;updateRiskCategory(total)}
            function updateRiskCategory(score){riskCategoryEl.classList.remove('category-2','category-1','category-1-high','unsafe');let categoryKey='category-2';if(score>40){categoryKey='unsafe'}else if(score>=30){categoryKey='category-1-high'}else if(score>=12){categoryKey='category-1'}riskCategoryEl.textContent=categoryMap[categoryKey];riskCategoryEl.classList.add(categoryKey)}
            function copySummary(){emrSummaryEl.select();try{document.execCommand('copy');copySummaryButton.textContent='Copied!';setTimeout(()=>{copySummaryButton.textContent='Copy to Clipboard'},2000)}catch(err){alert('Could not copy text.')}}
            function handleFluidBalance(){const fbc24=parseFloat(safeGet('fbc_24hr_input')),fbcTotal=parseFloat(safeGet('fbc_total_input')),isSig=(!isNaN(fbc24)&&Math.abs(fbc24)>2000)||(!isNaN(fbcTotal)&&Math.abs(fbcTotal)>2000),isMild=(!isNaN(fbc24)&&Math.abs(fbc24)>1000)||(!isNaN(fbcTotal)&&Math.abs(fbcTotal)>1000);if(isSig)document.getElementById('fluid_sig_radio').checked=true;else if(isMild)document.getElementById('fluid_mild_radio').checked=true;else document.getElementById('fluid_0_radio').checked=true;calculateScore()}
            
            // --- Event Listeners ---
            resetButton.addEventListener('click', resetForm);
            generateSummaryButton.addEventListener('click', generateSummary);
            copySummaryButton.addEventListener('click', copySummary);
            addDrainButton.addEventListener('click', () => addDynamicInput(drainsContainer, 'Drain type & site...'));
            addWoundButton.addEventListener('click', () => addDynamicInput(woundsContainer, 'Wound location & description...'));
            addPivcButton.addEventListener('click', () => addDynamicInput(pivcsContainer, 'e.g., Pink 20G Lt forearm...'));
            addOtherDeviceButton.addEventListener('click', () => addDynamicInput(otherDevicesContainer, 'Other device...'));
            [drainsContainer, woundsContainer, pivcsContainer, otherDevicesContainer].forEach(c => c.addEventListener('click', e => { if (e.target.classList.contains('remove-btn')) e.target.parentElement.remove(); }));
            bloodInputs.forEach(input => input.addEventListener('input', handleBloodInputs));
            scoreInputs.forEach(input => input.addEventListener('change', calculateScore));
            nursingConcernRadios.forEach(radio => radio.addEventListener('change', () => { nursingConcernText.style.display = safeIsChecked('concern_present') ? 'block' : 'none'; if (!safeIsChecked('concern_present')) nursingConcernText.value = ''; }));
            addsModCheckbox.addEventListener('change', () => { addsModDetails.classList.toggle('hidden', !addsModCheckbox.checked); calculateADDS(); });
            picsRadios.forEach(radio => radio.addEventListener('change', (e) => { picsUnableDetails.classList.toggle('hidden', e.target.value !== 'unable'); }));
            modParamCheckboxes.forEach(cb => { cb.addEventListener('change', (e) => { e.target.closest('.space-y-1').querySelector('.mod-details').classList.toggle('hidden', !e.target.checked); calculateADDS(); }); });
            modOperators.forEach(op => { op.addEventListener('change', (e) => { const param = e.target.dataset.param; const val2Container = document.getElementById(`mod_${param}_val2_container`); if (val2Container) { val2Container.style.display = e.target.value === 'between' ? 'inline' : 'none'; } calculateADDS(); }); });
            vitalInputs.forEach(i=>i.addEventListener('input', calculateADDS));
            document.getElementById('losDays').addEventListener('input', () => { const days = parseFloat(safeGet('losDays')); document.getElementById('losCheckbox').checked = days > 3; document.getElementById('losCheckbox').dispatchEvent(new Event('change')); });
            document.querySelectorAll('.fluid-input').forEach(i=>i.addEventListener('input', handleFluidBalance));

            // --- Initialise Form ---
            resetForm();
        });
    </script>
</body>
</html>
