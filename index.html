<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALERT Nursing Risk Assessment Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f0f9f9; --card:#ffffff; --ink:#111827; --muted:#4b5563; --accent:#007a7a;
      --red:#ef4444; --amber:#f59e0b; --green:#10b981; --line:#d1e3e3; --input-bg:#f8fbfb;
      --blue-hint:#2563eb; --toast-bg: rgba(0,0,0,0.8); --toast-color:#fff;
    }
    /* Dark mode tokens */
    body.dark { --bg:#0b1112; --card:#0f1720; --ink:#e6eef0; --muted:#9aa9ad; --line:#132022; --input-bg:#071018; --toast-bg: rgba(255,255,255,0.06); --toast-color:#e6eef0; }
    html,body{height:100%}
    body{font-family:'Inter', system-ui, sans-serif; background:var(--bg); color:var(--ink); margin:0 0 220px 0; line-height:1.4; -webkit-font-smoothing:antialiased;}
    header{padding:14px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; flex-wrap:wrap; background: var(--card); z-index:30;}
    header h1 {
      font-size: 2.0rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -0.5px;
      margin: 0;
      flex: 1;
      text-align: center;
    }
    header h1 .logo-em {
      color: var(--red);
      margin: 0 4px;
      font-weight: 800;
    }
    .header-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .top-meta { font-size:0.9rem; color:var(--muted); white-space:nowrap; }
    .last-saved { font-size:0.85rem; color:var(--muted); }
    .container{max-width:980px; margin:12px auto; padding:12px;}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); column-gap:12px; row-gap:18px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin-bottom:14px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);}
    .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    label{display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px; font-weight:500;}
    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); box-sizing:border-box;
      background:var(--input-bg); color:var(--ink); outline:none; font-size:1rem;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,122,0.12); }
    textarea{min-height:80px; resize:vertical; max-height:240px;}
    .concern-note { margin-top: 8px; }
    .concern-note textarea { min-height: 40px; font-size: 0.95rem; }
    .btn, .override-btn, .select-btn { background-color: var(--bg); color: var(--muted); border: 1px solid var(--line); padding: 8px 12px; border-radius: 10px; cursor:pointer; font-weight: 600; transition: all 0.15s; min-height:44px; display:inline-flex; align-items:center; justify-content:center; gap:8px;}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent);}
    .btn.danger{background: transparent; color: var(--red); border-color: rgba(239,68,68,0.15); }
    .btn.small { padding: 6px 10px; font-size: 0.9rem; min-height:40px; }
    .override-btn:hover, .select-btn:hover { background-color: var(--line); }
    .override-btn.amber.active { background-color: var(--amber); color:white; border-color:var(--amber);}
    .override-btn.red.active { background-color: var(--red); color:white; border-color:var(--red); }
    .select-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .kpi{display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:12px;}
    .kpi .box{background:var(--bg); border:1px solid var(--line); padding:12px; border-radius:12px; text-align:center}
    #categoryBox {
        padding: 16px 12px;
        border-width: 2px;
        transition: border-color 0.2s;
    }
    #categoryBox h3 {
        font-size: 2.25rem;
        margin-top: 4px;
        font-weight: 800;
    }
    .kpi .box h3{margin:0; font-size:1.75rem}
    .kpi .box small{color:var(--muted); font-size: 0.9rem;}
    .status{font-weight:700}
    .status.red{color:var(--red)} .status.amber{color:var(--amber)} .status.green{color:var(--green)}
    .section-title{margin-bottom:12px; font-size:1.05rem; font-weight:700;}
    .input-group { margin-bottom: 18px; }
    .toggle-label {
      display: flex; align-items: center; justify-content:space-between; gap:12px; background-color: var(--bg); padding: 12px; border-radius: 10px;
      border: 1px solid var(--line); cursor: pointer; transition: all 0.12s; margin-bottom: 8px; font-weight:600; color:var(--muted);
    }
    .toggle-label.active { background-color: var(--accent); color: white; border-color: var(--accent); }
    .toggle-label .state { font-weight:700; font-size:0.9rem; color:var(--muted); }
    .toggle-label.active .state { color: #fff; }
    .comorbidity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px;
    }
    .bloods-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px 12px;}
    .blood-item { display: grid; grid-template-columns: 50px 1fr 80px; align-items: center; gap: 6px; position: relative;}
    .blood-item label { margin-bottom: 0; font-size:0.9rem; color:var(--muted); }
    .blood-item input { font-size:0.95rem; padding: 8px; }
    .trend-buttons { display: flex; justify-self: end;}
    .trend-btn { font-size: 0.9rem; border: 1px solid var(--line); background: transparent; border-radius: 6px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--muted); padding:0;}
    .trend-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .blood-abnormal { border-color: var(--red) !important; background-color: rgba(239,68,68,.06) !important; }
    .range-annotation { font-size: 0.75rem; color: var(--muted); position: absolute; bottom: -14px; left: 56px; display: none; }
    footer {
      position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card);
      border-top: 1px solid var(--line); padding: 8px 16px;
      display: flex; flex-wrap:wrap; align-items: center; justify-content: space-between; gap: 8px 12px; box-sizing: border-box; z-index:25;
    }
    .footer-item { color: var(--muted); font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
    .footer-item.reason { flex: 1 1 auto; min-width: 120px; }
    .footer-score { padding: 6px 12px; border-radius: 8px; font-weight: 700; text-align: center; flex-shrink: 0;}
    .footer-buttons { display:flex; gap: 8px; }
    .tag{display:inline-flex; align-items:center; padding: 4px 10px; border-radius:999px; font-size:.85rem; margin:2px; border:1px solid; font-weight:600;}
    .tag.red{background:rgba(239,68,68,.08); color:var(--red); border-color:rgba(239,68,68,.2)}
    .tag.amber{background:rgba(245,158,11,.08); color:var(--amber); border-color:rgba(245,158,11,.18)}
    .tag.green{background:rgba(16,185,129,.07); color:var(--green); border-color:rgba(16,185,129,.12)}
    hr { border: none; height: 1px; background-color: var(--line); margin: 24px 0 18px 0; }
    .optional-note { text-align:center; color: var(--muted); font-size: 0.9rem; margin: 18px 0; }
    .accordion-wrapper { border: 1px solid var(--line); border-radius: 12px; overflow:hidden; margin-bottom: 12px;}
    .accordion {
      background-color: transparent; color: var(--ink); cursor: pointer; padding: 14px; width: 100%; border: none;
      border-bottom: 1px solid var(--line); text-align: left; outline: none; font-size: 1rem; font-weight:700;
      display:flex; align-items:center; justify-content:space-between;
    }
    .accordion .icon { color: var(--muted); font-size:0.9rem; margin-left:8px; }
    .panel { padding: 14px; background-color: transparent; display: none; overflow: hidden; }
    .device-entry, .pivc-entry, .wound-entry, .drain-entry {
      background: var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; margin-bottom:10px; display:flex; flex-direction:column; gap:8px;
    }
    .device-entry textarea, .pivc-entry textarea, .wound-entry textarea, .drain-entry textarea { width:100%; min-height:44px; font-size:1rem; background:var(--input-bg); }
    .remove-entry { background: transparent; border:1px solid rgba(239,68,68,0.12); color:var(--red); border-radius:8px; padding:8px; cursor:pointer; text-align:center; font-weight:700; }
    .remove-entry:hover { background: rgba(239,68,68,0.04); }
    .floating-toolbar { display: none; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:110px; background:var(--toast-bg); color:var(--toast-color); padding:10px 14px; border-radius:8px; z-index:60; display:none; font-weight:600; text-align: center; }
    .toast.show { display:block; animation: fadeIn .18s ease; }
    .toast button { margin-left: 12px; }
    @keyframes fadeIn { from { opacity:0; transform:translateX(-50%) translateY(6px); } to { opacity:1; transform:translateX(-50%) translateY(0);} }
    .devices-subtitle {
      font-weight: 700;
      font-size: 1rem;
      margin-top: 18px;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .device-add-buttons { display: flex; flex-direction: column; gap: 8px; }
    .device-add-buttons .btn { justify-content: flex-start; padding-left: 16px; }
    #panel_context .devices-input-group > * {
      margin-bottom: 10px;
    }
    #panel_context .devices-input-group > *:last-child {
      margin-bottom: 0;
    }
    #panel_context .devices-input-group label {
      margin-bottom: 4px; /* less for labels above inputs */
    }
    #panel_devices input[type="text"], #panel_devices textarea, #panel_context textarea {
      border-color: #b0c9c9; /* Slightly darker border */
    }
    body.dark #panel_devices input[type="text"], body.dark #panel_devices textarea, body.dark #panel_context textarea {
      border-color: #2a3d3f; /* Darker border for dark mode */
    }
    #cvc_details textarea {
      min-height: 50px; /* smaller textarea for CVC site */
    }
    .flag-red { box-shadow: 0 0 0 2px var(--red); }
    .flag-amber { box-shadow: 0 0 0 2px var(--amber); }

    /* Responsive */
    @media (max-width:900px){
      .col-2,.col-3,.col-4,.col-6,.col-8{grid-column:span 12}
      .grid { column-gap:10px; row-gap:12px; }
      input, textarea { font-size:1.05rem; padding:12px; }
      .btn, .select-btn, .toggle-label { padding:10px 12px; font-size:1rem; min-height:48px; }
    }
     @media (max-width: 600px) {
        .kpi { grid-template-columns: 1fr; }
        header h1 { font-size: 1.2rem; line-height: 1.2; }
     }
     @media (max-width: 400px) {
      .footer-item { white-space: normal; }
    }
  </style>
</head>
<body>
<header role="banner">
  <h1><span class="logo-em">!</span> ALERT <span class="logo-em">!</span> <br> Nursing Risk Assessment Tool</h1>
  <div class="header-controls">
    <div style="display:flex; gap:8px;">
        <button class="btn small" id="darkToggle" aria-pressed="false">Dark mode</button>
        <button class="btn danger small" id="clearDataBtnTop">Clear Data / Next Patient</button>
    </div>
    <div class="top-meta last-saved" id="lastSaved">Last saved: --:--</div>
  </div>
</header>

<main class="container" role="main">
  <div class="card" aria-labelledby="patientHeading">
    <div class="grid">
       <div class="col-6">
        <label>Clinician Role</label>
        <div style="display:flex; gap:8px; padding-top:6px;">
          <label style="font-weight:500"><input type="radio" name="clinicianRole" value="ALERT CNS" checked> CNS</label>
          <label style="font-weight:500"><input type="radio" name="clinicianRole" value="ALERT CN"> CN</label>
        </div>
      </div>
       <div class="col-6">
        <label>Review Type</label>
        <div style="display:flex; gap:8px; padding-top:6px;">
          <label style="font-weight:500"><input type="radio" name="reviewType" value="pre"> Pre-Stepdown</label>
          <label style="font-weight:500"><input type="radio" name="reviewType" value="post" checked> Post-Stepdown</label>
        </div>
      </div>
      <div class="col-6"><label for="ptName">Patient Initials</label><input id="ptName" type="text" autocomplete="off" /></div>
      <div class="col-6"><label for="ptMrn">Last 3 digits of URN</label><input id="ptMrn" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="3" autocomplete="off" /></div>
      <div class="col-3"><label for="ptAge">Age</label><input id="ptAge" type="number" min="0" /></div>
      <div class="col-3"><label for="icuLos">ICU LOS (days)</label><input id="icuLos" type="number" min="0" /></div>
      <div class="col-4">
          <label for="ptWard">Ward</label>
          <select id="ptWard">
              <option value="" selected disabled>Select Ward...</option>
              <option value="3A">3A</option>
              <option value="3B">3B</option>
              <option value="3C">3C</option>
              <option value="3D">3D</option>
              <option value="4A">4A</option>
              <option value="4B">4B</option>
              <option value="4C">4C</option>
              <option value="4D">4D</option>
              <option value="5A">5A</option>
              <option value="5B">5B</option>
              <option value="5C">5C</option>
              <option value="5D">5D</option>
              <option value="6A">6A</option>
              <option value="6B">6B</option>
              <option value="6C">6C</option>
              <option value="6D">6D</option>
              <option value="7A">7A</option>
              <option value="7B">7B</option>
              <option value="7C">7C</option>
              <option value="7D">7D</option>
              <option value="SRS2A">SRS2A</option>
              <option value="SRS1A">SRS1A</option>
              <option value::"SRSA">SRSA</option>
              <option value="SRSB">SRSB</option>
              <option value="Medihotel 8">Medihotel 8</option>
              <option value="Medihotel 7">Medihotel 7</option>
              <option value="Medihotel 6">Medihotel 6</option>
              <option value="Medihotel 5">Medihotel 5</option>
              <option value="Short Stay">Short Stay</option>
              <option value="Transit Lounge">Transit Lounge</option>
              <option value="Mental Health Adult">Mental Health Adult</option>
              <option value="Mental Health Youth">Mental Health Youth</option>
              <option value="Other">Other</option>
          </select>
      </div>
      <div class="col-2">
          <label for="ptBed">Bed</label>
          <input id="ptBed" type="number" min="1" />
      </div>
      <div class="col-6" id="ptWardOtherWrapper" style="display:none;">
          <label for="ptWardOther">Specify Other Ward</label>
          <input id="ptWardOther" type="text" />
      </div>
      <div class="col-12"><label for="ptAdmissionReason">Reason for ICU Admission</label><input id="ptAdmissionReason" type="text" /></div>
      <div class="col-4"><label>Stepdown Date</label><input type="date" id="stepdownDate"></div>
      <div class="col-8">
        <label>Stepdown Time</label>
        <div class="button-group" id="stepdownTime" role="tablist">
          <button class="select-btn" data-value="Morning">Morning</button>
          <button class="select-btn" data-value="Afternoon">Afternoon</button>
          <button class="select-btn" data-value="Evening">Evening</button>
          <button class="select-btn" data-value="Night">Night</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="col-4"><label for="adds">ADDS</label><input id="adds" type="number" min="0" max="10" /></div>
      <div class="col-4"><label for="lactate">Lactate (mmol/L)</label><input id="lactate" type="number" step="0.1" min="0"/></div>
      <div class="col-4"><label for="hb">Hb (g/L)</label><input id="hb" type="number" step="1" min="0"/></div>
    </div>
    <hr>
    <div class="input-group">
      <label>Oxygen Modality?</label>
      <div class="button-group" id="oxMod" role="tablist" aria-label="Oxygen Modality">
        <button class="select-btn" data-value="RA">Room Air</button>
        <button class="select-btn" data-value="NP">Nasal Prongs</button>
        <button class="select-btn" data-value="HFNP">HFNP</button>
        <button class="select-btn" data-value="NIV">NIV</button>
        <button class="select-btn" data-value="Trache">Trache / Lary</button>
      </div>

      <div class="grid">
        <div class="col-6 npOnly" style="display:none"><label for="npFlow">NP Flow (L/min)</label><input id="npFlow" type="number" step="0.5" min="0" /></div>
        <div class="col-3 hfnpOnly" style="display:none"><label for="hfnpFio2">HFNP FiO2 (%)</label><input id="hfnpFio2" type="number" step="1" min="21" max="100" /></div>
        <div class="col-3 hfnpOnly" style="display:none"><label for="hfnpFlow">HFNP Flow (L/min)</label><input id="hfnpFlow" type="number" step="1" min="0" /></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivFio2">FiO2 (%)</label><input id="nivFio2" type="number" min="21" max="100"/></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivPeep">PEEP</label><input id="nivPeep" type="number" min="0"/></div>
        <div class="col-2 nivOnly" style="display:none;"><label for="nivPs">PS</label><input id="nivPs" type="number" min="0"/></div>
      </div>
      
      <div class="grid tracheOnly" style="display:none; margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px;">
          <div class="col-12">
              <label>Tracheostomy / Laryngectomy Details</label>
          </div>
          <div class="col-6">
              <label>Type</label>
              <div class="button-group" id="tracheType" role="tablist">
                  <button class="select-btn" data-value="Tracheostomy">Tracheostomy</button>
                  <button class="select-btn" data-value="Laryngectomy">Laryngectomy</button>
              </div>
          </div>
          <div class="col-6">
              <label>Status</label>
              <div class="button-group" id="tracheStatus" role="tablist">
                  <button class="select-btn" data-value="Stable">Long-term / Stable</button>
                  <button class="select-btn" data-value="New">New / Unstable</button>
              </div>
          </div>
          <div class="col-12" style="margin-top: 8px;">
              <label for="trache_details_note">Optional Airway Details</label>
              <textarea id="trache_details_note" placeholder="e.g., size, cuffed/uncuffed, date of change..."></textarea>
          </div>
      </div>

      <div style="margin-top:10px">
        <label>Dyspnea/Respiratory Distress?</label>
        <div class="button-group" id="dyspneaConcern">
          <button class="select-btn" data-value="none">None</button>
          <button class="select-btn" data-value="mild">Mild</button>
          <button class="select-btn" data-value="severe">Severe</button>
        </div>
        <div id="dyspneaConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="dyspneaConcern_note" placeholder="Optional: enter details of dyspnea"></textarea>
        </div>
      </div>
    </div>
    
    <div class="input-group">
      <label>Neurological Concern?</label>
      <div class="button-group" id="neuroConcern">
        <button class="select-btn" data-value="none">None</button>
        <button class="select-btn" data-value="mild">Mild Confusion/Delirium</button>
        <button class="select-btn" data-value="severe">Severe Confusion/Delirium</button>
      </div>
       <div id="neuroConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="neuroConcern_note" placeholder="Optional: enter details of neurological concern"></textarea>
      </div>
    </div>
    
    <div class="input-group">
      <label>Electrolyte Concern?</label>
      <div class="button-group" id="electrolyteConcern" role="tablist" aria-label="Electrolyte Concern">
        <button class="select-btn" data-value="none">None</button>
        <button class="select-btn" data-value="mild">Mild/moderate</button>
        <button class="select-btn" data-value="severe">Severe</button>
      </div>
       <div id="electrolyteConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="electrolyteConcern_note" placeholder="Optional: enter details of electrolyte concern (e.g., Na 128, K 2.9)"></textarea>
      </div>
    </div>

    <hr>
    <div class="input-group">
      <div class="toggle-label" id="toggle_after_hours_discharge" data-value="false" role="button" aria-pressed="false"><span>Discharged after-hours? <small style="font-weight:400; color:var(--muted)">(only score for first night on ward)</small></span><span class="state">No</span></div>
      <div id="after_hours_discharge_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="after_hours_discharge_note" placeholder="Optional: enter details"></textarea>
      </div>

      <div class="toggle-label" id="toggle_pressors24h" data-value="false" role="button" aria-pressed="false"><span>Vasopressors in last 24h?</span><span class="state">No</span></div>
       <div id="pressors24h_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="pressors24h_note" placeholder="Optional: enter details of vasopressor use"></textarea>
      </div>

      <div class="toggle-label" id="toggle_np3Last12h" data-value="false" role="button" aria-pressed="false"><span>Historical O2: NP ≥3L, HFNP >30%, NIV in last 12h, or intubated in last 24h?</span><span class="state">No</span></div>
       <div id="np3Last12h_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="np3Last12h_note" placeholder="Optional: enter details of historical O2 use"></textarea>
      </div>

      <div class="toggle-label" id="toggle_rapidWean" data-value="false" role="button" aria-pressed="false"><span>Rapid oxygen wean in last 12h?</span><span class="state">No</span></div>
       <div id="rapidWean_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="rapidWean_note" placeholder="Optional: enter details of rapid wean"></textarea>
      </div>
      
      <div class="toggle-label" id="toggle_renalConcern" data-value="false" role="button" aria-pressed="false"><span>Renal Concern (AKI, rising Cr, or ESRD/dialysis)?</span><span class="state">No</span></div>
       <div id="renalConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="renalConcern_note" placeholder="Optional: enter details of renal concern"></textarea>
      </div>

      <div class="toggle-label" id="toggle_uopLow" data-value="false" role="button" aria-pressed="false"><span>UOP concerning / downtrending (&lt;0.5 mL/kg/hr)?</span><span class="state">No</span></div>
       <div id="uopLow_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="uopLow_note" placeholder="Optional: enter urine output details"></textarea>
      </div>
      
      <div class="toggle-label" id="toggle_immobility48h" data-value="false" role="button" aria-pressed="false">Immobility >48h? <span class="state">No</span></div>
      <div id="immobility48h_note_wrapper" class="concern-note" style="display:none;">
          <textarea id="immobility48h_note" placeholder="Optional: enter details of immobility"></textarea>
      </div>
      
      <div class="toggle-label" id="toggle_infectionConcern" data-value="false" role="button" aria-pressed="false"><span>Infection Concern?</span><span class="state">No</span></div>
       <div id="infectionConcern_note_wrapper" class="concern-note" style="display:none;">
            <textarea id="infectionConcern_note" placeholder="Optional: enter details of clinical signs of infection"></textarea>
      </div>
      <div id="infectionMarkers" style="display:none; margin-top:12px; padding:12px; border-radius:10px; background:var(--bg)">
        <label style="margin-bottom:8px; display:block; font-weight:600;">Optional: Enter Infection Markers</label>
        <div class="grid">
          <div class="col-4" style="position: relative;"><label for="wcc">WCC (x10^9/L)</label><input id="wcc" type="number" step="0.1" /><span id="wcc_range" class="range-annotation" style="left:0;"></span></div>
          <div class="col-4" style="position: relative;"><label for="crp">CRP (mg/L)</label><input id="crp" type="number" step="1" /><span id="crp_range" class="range-annotation" style="left:0;"></span></div>
          <div class="col-4">
            <label for="neut">Neut / Lymph (NLR)</label>
            <div style="position: relative; margin-bottom: 22px;">
                <input id="neut" type="number" step="0.1" placeholder="Neut" />
                <span id="neut_range" class="range-annotation" style="left: 0; bottom: -16px;"></span>
            </div>
            <div style="position: relative; margin-bottom: 22px;">
                <input id="lymph" type="number" step="0.1" placeholder="Lymph" />
                 <span id="lymph_range" class="range-annotation" style="left: 0; bottom: -16px;"></span>
            </div>
            <div id="nlrCalc" style="margin-top:6px; font-size:0.9rem; color:var(--muted)">NLR: --</div>
          </div>
        </div>
      </div>
    </div>
    
    <hr>
    <div class="input-group">
      <div class="section-title">Concerning Comorbidities?</div>
      <div class="comorbidity-grid">
        <div class="toggle-label" id="toggle_comorb_copd" data-value="false" role="button" aria-pressed="false">COPD/Asthma <span class="state">No</span></div>
        <div class="toggle-label" id="toggle_comorb_hf" data-value="false" role="button" aria-pressed="false">Active HF <span class="state">No</span></div>
        <div class="toggle-label" id="toggle_comorb_esrd" data-value="false" role="button" aria-pressed="false">ESRD/Dialysis <span class="state">No</span></div>
        <div class="toggle-label" id="toggle_comorb_diabetes" data-value="false" role="button" aria-pressed="false">Uncontrolled Diabetes <span class="state">No</span></div>
        <div class="toggle-label" id="toggle_comorb_cirrhosis" data-value="false" role="button" aria-pressed="false">Cirrhosis <span class="state">No</span></div>
        <div class="toggle-label" id="toggle_comorb_other" data-value="false" role="button" aria-pressed="false">Other <span class="state">No</span></div>
      </div>
      <div id="comorb_other_note_wrapper" class="concern-note" style="display:none; margin-top: 10px;">
          <label for="comorb_other_note">Specify other comorbidity</label>
          <textarea id="comorb_other_note" placeholder="Enter details..."></textarea>
      </div>
    </div>

    <hr>
    <div class="section-title">Clinical Judgement Override?</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <button class="override-btn red" id="override_red">Upgrade to CAT 1</button>
      <button class="override-btn amber" id="override_amber">Upgrade to CAT 2</button>
      <button class="override-btn" id="override_clear">Clear Override</button>
    </div>
    <input type="hidden" id="override" value="none">
    <div id="override_reason_box" style="display:none;"><label>Reason for override</label><input id="overrideNote" type="text"/></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box" id="categoryBox"><h3 id="catText" class="status green">CAT 3</h3></div>
      <div class="box"><small>CAT 1 Flags</small><h3 id="redCount">0</h3></div>
      <div class="box"><small>CAT 2 Flags</small><h3 id="amberCount">0</h3></div>
    </div>
    <hr>
    <div class="section-title">Identified Risk Factors</div>
    <div id="flagList" style="margin-top:12px; min-height:28px; color:var(--muted);"></div>
    <hr>
    <div class="section-title">Follow-up Plan</div>
    <div id="followUpInstructions" style="margin-top:12px; font-weight: 500;"></div>
    
    <div id="dischargeNudge" style="font-size: 0.9rem; color: var(--blue-hint); font-weight: 600; margin-top: 15px; display: none;"></div>
    <div class="toggle-label" id="toggle_discharge_from_alert" data-value="false" role="button" aria-pressed="false" style="margin-top:10px; border-color: var(--blue-hint);">
        <span>Suitable for discharge from ALERT list?</span>
        <span class="state">No</span>
    </div>
  </div>

  <div class="optional-note">The following sections are optional DMR note helpers</div>

  <div class="accordion-wrapper" data-accordion-id="ae">
    <button class="accordion" aria-expanded="false" aria-controls="panel_ae">A-E Assessment <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_ae">
      <div class="grid">
        <div class="col-12"><div class="toggle-label" id="toggle_use_mods" data-value="false" role="button" aria-pressed="false"><span>MODS in place?</span> <span class="state">No</span></div></div>
        <div class="col-12" id="mods_inputs" style="display:none;">
          <div class="grid">
            <div class="col-12"><label>MODS Score</label><input id="mods_score" type="text"/></div>
            <div class="col-12"><label>MODS Details</label><input id="mods_details" type="text"/></div>
          </div>
        </div>
        <div class="col-12" id="adds_input_container"><label>ADDS</label><input id="atoe_adds" type="number"/></div>

        <div class="col-12"><label>A</label><input id="airway_a" type="text" placeholder="Patent?" data-manual="false"/></div>
        <div class="col-3"><label>B</label><input id="b_rr" type="text" placeholder="RR"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="b_spo2" type="text" placeholder="SpO2 (%)"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="b_device" type="text" placeholder="Device" data-manual="false"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="b_wob" type="text" placeholder="WOB"/></div>

        <div class="col-3"><label>C</label><input id="c_hr" type="text" placeholder="HR"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="c_nibp" type="text" placeholder="NIBP"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="c_cr" type="text" placeholder="Cap Refill"/></div>
        <div class="col-3"><label>&nbsp;</label><input id="c_perf" type="text" placeholder="Perfusion"/></div>

        <div class="col-4"><label>D</label><input id="d_alert" type="text" placeholder="Alert?"/></div>
        <div class="col-4"><label>&nbsp;</label><input id="d_gcs" type="text" placeholder="GCS"/></div>
        <div class="col-4"><label>&nbsp;</label><input id="d_pain" type="text" placeholder="Pain"/></div>

        <div class="col-4"><label>E</label><input id="e_temp" type="text" placeholder="Temp"/></div>
        <div class="col-4"><label>&nbsp;</label><input id="e_bsl" type="text" placeholder="BSL"/></div>
        <div class="col-4"><label>&nbsp;</label><input id="e_uop" type="text" placeholder="UOP"/></div>

        <div class="col-12"><hr></div>
        <div class="col-12"><label for="ae_mobility">Mobility/MSK</label><input id="ae_mobility" type="text" placeholder="Current mobility level"/></div>
        <div class="col-12"><label for="ae_diet">Diet</label><input id="ae_diet" type="text" placeholder="Current diet/fluids"/></div>
        <div class="col-12"><label for="ae_bowels">Bowels</label><input id="ae_bowels" type="text" placeholder="Last bowel motion"/></div>
      </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="bloods">
    <button class="accordion" aria-expanded="false" aria-controls="panel_bloods">Bloods <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_bloods">
      <div class="bloods-grid">
        <div class="blood-item"><label for="bl_lac_review">Lac</label><input id="bl_lac_review" type="number" step="0.1"/><div class="trend-buttons" id="bl_lac_review_trend"></div><span id="bl_lac_review_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_hb">Hb</label><input id="bl_hb" type="number"/><div class="trend-buttons" id="bl_hb_trend"></div><span id="bl_hb_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_wcc">WCC</label><input id="bl_wcc" type="number" step="0.1"/><div class="trend-buttons" id="bl_wcc_trend"></div><span id="bl_wcc_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_crp">CRP</label><input id="bl_crp" type="number"/><div class="trend-buttons" id="bl_crp_trend"></div><span id="bl_crp_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_cr_review">Cr</label><input id="bl_cr_review" type="number"/><div class="trend-buttons" id="bl_cr_review_trend"></div><span id="bl_cr_review_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_k">K</label><input id="bl_k" type="number" step="0.1"/><div class="trend-buttons" id="bl_k_trend"></div><span id="bl_k_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_na">Na</label><input id="bl_na" type="number" step="1"/><div class="trend-buttons" id="bl_na_trend"></div><span id_=""bl_na_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_mg">Mg</label><input id="bl_mg" type="number" step="0.1"/><div class="trend-buttons" id="bl_mg_trend"></div><span id="bl_mg_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_plts">Plts</label><input id="bl_plts" type="number"/><div class="trend-buttons" id="bl_plts_trend"></div><span id="bl_plts_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_alb">Alb</label><input id="bl_alb" type="number"/><div class="trend-buttons" id="bl_alb_trend"></div><span id="bl_alb_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_neut">Neut</label><input id="bl_neut" type="number" step="0.1"/><div class="trend-buttons" id="bl_neut_trend"></div><span id="bl_neut_range" class="range-annotation"></span></div>
        <div class="blood-item"><label for="bl_lymph">Lymph</label><input id="bl_lymph" type="number" step="0.1"/><div class="trend-buttons" id="bl_lymph_trend"></div><span id="bl_lymph_range" class="range-annotation"></span></div>
      </div>

      <div style="margin-top:12px" class="grid">
        <div class="col-12"><label>Electrolyte Plan</label><input id="elec_replace_note" type="text" placeholder="Replacement plan..."/></div>
        <div class="col-12" style="margin-top:8px"><div class="toggle-label" id="toggle_new_bloods_ordered" data-value="false" role="button" aria-pressed="false">New blood request ordered for next phleb round? <span class="state">No</span></div></div>
      </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="devices">
    <button class="accordion" aria-expanded="false" aria-controls="panel_devices">Lines, Drains & Wounds <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_devices" style="display:flex; flex-direction:column; gap: 12px;">
       <div id="devices-container"></div>
       <div class="button-group" style="justify-content: flex-start; flex-wrap: wrap;">
           <button class="btn small" data-device-type="CVC">+ Add CVC</button>
           <button class="btn small" data-device-type="Other CVAD">+ Add Other CVAD</button>
           <button class="btn small" data-device-type="PIVC">+ Add PIVC</button>
           <button class="btn small" data-device-type="Enteral Tube">+ Add Enteral Tube</button>
           <button class="btn small" data-device-type="IDC">+ Add IDC</button>
           <button class="btn small" data-device-type="Pacing Wire">+ Add Pacing Wire</button>
           <button class="btn small" data-device-type="Drain">+ Add Drain</button>
           <button class="btn small" data-device-type="Wound">+ Add Wound</button>
           <button class="btn small" data-device-type="Other Device">+ Add Other Device</button>
       </div>
    </div>
  </div>

  <div class="accordion-wrapper" data-accordion-id="context">
    <button class="accordion" aria-expanded="false" aria-controls="panel_context">Other Factors <span class="icon" aria-hidden="true">[+]</span></button>
    <div class="panel" id="panel_context">
        <div class="devices-subtitle">▶ Goals of Care (GOC)</div>
        <div class="devices-input-group">
            <textarea id="goc_note" placeholder="GOC / Resuscitation Status"></textarea>
        </div>

        <div class="devices-subtitle">▶ Allergies</div>
        <div class="devices-input-group">
            <textarea id="allergies_note" placeholder="List any known allergies"></textarea>
        </div>
        
        <div class="devices-subtitle">▶ Significant Past Medical History (PMH)</div>
        <div class="devices-input-group">
            <textarea id="pmh_note" placeholder="Auto-populates from 'Other' comorbidity. Editable."></textarea>
        </div>

        <div class="devices-subtitle">▶ PICS Assessment</div>
        <div class="devices-input-group">
            <textarea id="pics_note" placeholder="Note PICS assessment"></textarea>
        </div>

        <div class="devices-subtitle">▶ Other</div>
        <div class="devices-input-group">
            <textarea id="context_other_note" placeholder="Hometeam plan, other notes"></textarea>
        </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Auto-Generated Summary</div>
    <textarea id="summary" placeholder="Summary will auto-generate here..." style="min-height:240px; font-family:ui-monospace,monospace;"></textarea>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" id="copyBtn">Copy Summary</button>
      <button class="btn danger" id="clearDataBtnBottom">Clear Data / Next Patient</button>
    </div>
  </div>
  
  <div style="text-align:center; color: var(--muted); font-weight: 600; margin: 24px 0; letter-spacing: 1px;">- END ASSESSMENT -</div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<footer role="contentinfo">
  <div class="footer-item"><strong>Patient:</strong> <span id="footerName">--</span></div>
  <div class="footer-item"><strong>Room:</strong> <span id="footerLocation">--</span></div>
  <div class="footer-item reason"><strong>Reason:</strong> <span id="footerAdmission">--</span></div>
  <div id="footerScore" class="footer-score tag green">CAT 3</div>
  <div class="footer-buttons">
      <button class="btn primary" id="footerSave">Save</button>
      <button class="btn" id="footerCopy">Copy</button>
  </div>
</footer>

<script>
/* ===========================
   Utilities & State
   =========================== */
const $ = id => document.getElementById(id);
const debounce = (fn, wait=350) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; };
const computeAllAndSave = ()=>{ computeAll(); saveState(true); };
const num = v => { const x = parseFloat(v); return isNaN(x) ? null : x; };
const STORAGE_KEY = 'alertNursingToolData_v2';
const ACCORDION_KEY = 'alertNursingToolAccordions_v2';
const UNDO_KEY = 'alertNursingToolUndo_v2';
const normalRanges = {
  wcc: { low: 4, high: 11 }, crp: { low: 0, high: 50 },
  neut: { low: 1.5, high: 7.5 }, lymph: { low: 1.0, high: 4.0 },
  hb: { low: 115, high: 165 }, plts: { low: 150, high: 400 },
  k: { low: 3.5, high: 5.2 }, na: { low: 135, high: 145 },
  cr_review: { low: 50, high: 98 },
  mg: { low: 0.7, high: 1.1 }, alb: { low: 35, high: 50 },
  lac_review: { low: 0.5, high: 2.0 }
};

/* fields to automatically save/restore */
const staticInputs = [
  'ptName','ptMrn','ptAge','ptWard','ptBed','ptWardOther','ptAdmissionReason','icuLos','stepdownDate',
  'npFlow','hfnpFio2','hfnpFlow','nivFio2', 'nivPeep', 'nivPs','override','overrideNote',
  'trache_details_note',
  'mods_score','mods_details','airway_a','b_rr','b_spo2','b_device','b_wob',
  'c_hr','c_nibp','c_cr','c_perf','d_alert','d_gcs','d_pain','e_temp','e_bsl','e_uop','atoe_adds',
  'ae_mobility','ae_diet','ae_bowels',
  'bl_wcc','bl_crp','bl_neut','bl_lymph',
  'bl_hb','bl_plts','bl_k','bl_na',
  'bl_cr_review','bl_mg','bl_alb','bl_lac_review',
  'elec_replace_note', 'goc_note', 'allergies_note', 'pics_note', 'context_other_note', 'pmh_note',
  'adds','lactate','hb','wcc','crp','neut','lymph',
  'dyspneaConcern_note', 'renalConcern_note', 'uopLow_note', 'neuroConcern_note', 'infectionConcern_note',
  'electrolyteConcern_note',
  'after_hours_discharge_note', 'pressors24h_note', 'np3Last12h_note', 'rapidWean_note', 'immobility48h_note', 'comorb_other_note'
];
const toggleInputs = [
  'after_hours_discharge','pressors24h','np3Last12h','rapidWean','renalConcern','uopLow',
  'infectionConcern','use_mods','new_bloods_ordered',
  'comorb_copd','comorb_hf','comorb_esrd','comorb_diabetes','comorb_cirrhosis', 'immobility48h', 'comorb_other',
  'discharge_from_alert'
];
const selectInputs = ['oxMod','dyspneaConcern','neuroConcern','electrolyteConcern','stepdownTime', 'tracheType', 'tracheStatus'];
const deviceTypes = ['CVC', 'Other CVAD', 'PIVC', 'Enteral Tube', 'IDC', 'Pacing Wire', 'Drain', 'Wound', 'Other Device'];


/* ---------------------------
   Persistence helpers
   --------------------------- */
function nowTimeStr() {
  const d = new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function showToast(msg, timeout=2500, actionText=null, actionCallback=null) {
  const t = $('toast');
  t.innerHTML = msg;
  if (actionText && actionCallback) {
    const btn = document.createElement('button');
    btn.textContent = actionText;
    btn.className = 'btn small';
    btn.style.marginLeft = '12px';
    btn.addEventListener('click', actionCallback);
    t.appendChild(btn);
  }
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), timeout);
}
function saveState(instantly=false) {
  const state = getState();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  localStorage.setItem('alertNursingToolLastSaved', new Date().toISOString());
  updateLastSaved();
}
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e){ return null; }
}
function pushUndo(snapshot) {
  try {
    localStorage.setItem(UNDO_KEY, JSON.stringify({ snapshot, created: Date.now() }));
  } catch(e){}
}
function popUndo() {
  try {
    const raw = localStorage.getItem(UNDO_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    const age = Date.now() - (obj.created || 0);
    if (age > 10000) { localStorage.removeItem(UNDO_KEY); return null; }
    localStorage.removeItem(UNDO_KEY);
    return obj.snapshot;
  } catch(e){ return null; }
}
function updateLastSaved() {
  const iso = localStorage.getItem('alertNursingToolLastSaved');
  if (!iso) { $('lastSaved').textContent = 'Last saved: --:--'; return; }
  const t = new Date(iso);
  $('lastSaved').textContent = 'Last saved: ' + t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

/* ===========================
   DOM Helpers for Dynamic lists
   =========================== */
function createDeviceEntry(type, value = '') {
    const container = $('devices-container');
    const index = container.querySelectorAll(`.device-entry[data-type="${type}"]`).length + 1;
    const div = document.createElement('div');
    div.className = 'device-entry';
    div.dataset.type = type;
    div.innerHTML = `
        <label>${type}</label>
        <div style="display: flex; gap: 8px; align-items: center;">
            <textarea style="flex: 1;" placeholder="Enter details for ${type}...">${value}</textarea>
            <div class="remove-entry" role="button" tabindex="0">Remove</div>
        </div>
    `;
    container.appendChild(div);

    const ta = div.querySelector('textarea');
    ta.addEventListener('input', debounce(() => { computeAll(); saveState(); }, 300));
    const rem = div.querySelector('.remove-entry');
    rem.addEventListener('click', () => { 
        div.remove(); 
        computeAll(); 
        saveState(); 
    });
    rem.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter' || e.key === ' ') { 
            e.preventDefault(); 
            div.remove(); 
            computeAll(); 
            saveState(); 
        }
    });
    div.scrollIntoView({ behavior: 'smooth', block: 'center' });
    ta.focus();
}

/**
 * Calculates the display text for the oxygen device (B) based on form state.
 * This is used for auto-populating the A-E 'Device' field.
 * @param {object} s - The current state object.
 * @returns {string} The formatted oxygen device text.
 */
function getOxyDeviceText(s) {
    let oxyDeviceText = '';
    switch (s.oxMod) {
        case 'RA':
            oxyDeviceText = 'RA';
            break;
        case 'NP':
            const npFlow = s.npFlow;
            oxyDeviceText = npFlow ? `${npFlow}L NP` : 'NP';
            break;
        case 'HFNP':
            const hfnpFlow = s.hfnpFlow;
            const hfnpFio2 = s.hfnpFio2;
            let hfnpParts = [];
            if (hfnpFlow) hfnpParts.push(`${hfnpFlow}L`);
            if (hfnpFio2) hfnpParts.push(`${hfnpFio2}%`);
            oxyDeviceText = `HFNP ${hfnpParts.join(' / ')}`;
            break;
        case 'NIV':
            const nivFio2 = s.nivFio2;
            const nivPeep = s.nivPeep;
            const nivPs = s.nivPs;
            let nivParts = [];
            if (nivFio2) nivParts.push(`${nivFio2}% FiO2`);
            if (nivPeep) nivParts.push(`${nivPeep} PEEP`);
            if (nivPs) nivParts.push(`${nivPs} PS`);
            oxyDeviceText = `NIV ${nivParts.join(', ')}`;
            break;
        case 'Trache':
            oxyDeviceText = ''; // Moved to getAirwayDeviceText
            break;
    }
    return oxyDeviceText.trim();
}

/**
 * Calculates the display text for the airway device (A) (trache/lary) based on form state.
 * This is used for auto-populating the A-E 'Airway' field.
 * @param {object} s - The current state object.
 * @returns {string} The formatted airway device text.
 */
function getAirwayDeviceText(s) {
    let airwayDeviceText = '';
    if (s.oxMod === 'Trache') {
        const tracheType = s.tracheType; // e.g., "Tracheostomy"
        if (!tracheType) {
            airwayDeviceText = 'Altered Airway'; // User request: "Altered Airway" if no type selected
        } else {
            airwayDeviceText = tracheType; // "Tracheostomy" or "Laryngectomy"
        }

        // Now append the details if they exist
        const details = s.trache_details_note ? s.trache_details_note.trim() : '';
        if (details) {
            airwayDeviceText += ` (${details})`;
        }
    }
    return airwayDeviceText.trim();
}


/* ===========================
   Save / Load DOM <-> State
   =========================== */
function getState() {
  const state = {};
  for (const id of staticInputs) {
    const el = $(id);
    if (!el) continue;
    state[id] = el.value;
  }
  for (const id of toggleInputs) {
    const el = $(`toggle_${id}`);
    state[id] = el ? el.dataset.value === 'true' : false;
  }
  for (const groupId of selectInputs) {
    const el = $(groupId);
    if (!el) continue;
    const active = el.querySelector('.select-btn.active');
    state[groupId] = active ? active.dataset.value : '';
  }
  let checked = document.querySelector('input[name="reviewType"]:checked');
  state['reviewType'] = checked ? checked.value : 'post';

  checked = document.querySelector('input[name="clinicianRole"]:checked');
  state['clinicianRole'] = checked ? checked.value : 'ALERT CNS';
  
  state.devices = {};
  deviceTypes.forEach(type => {
      state.devices[type] = Array.from(document.querySelectorAll(`.device-entry[data-type="${type}"] textarea`)).map(ta => ta.value);
  });
  
  // Blood trends
  document.querySelectorAll('.trend-buttons').forEach(group => {
    const activeBtn = group.querySelector('.trend-btn.active');
    state[group.id] = activeBtn ? activeBtn.dataset.value : '';
  });

  return state;
}

function updateWardOtherVisibility() {
    const wardSelect = $('ptWard');
    const otherWrapper = $('ptWardOtherWrapper');
    if (wardSelect && otherWrapper) {
        otherWrapper.style.display = (wardSelect.value === 'Other') ? 'block' : 'none';
    }
}

function restoreState(state) {
  if (!state) return;
  for (const id of staticInputs) {
    const el = $(id);
    if (!el) continue;
    if (state[id] !== undefined) el.value = state[id];
  }
  for (const id of toggleInputs) {
    const el = $(`toggle_${id}`);
    if (!el) continue;
    const val = state[id];
    el.dataset.value = val ? 'true' : 'false';
    el.classList.toggle('active', !!val);
    const stateSpan = el.querySelector('.state'); if (stateSpan) stateSpan.textContent = val ? 'Yes' : 'No';
  }
  for (const groupId of selectInputs) {
    const value = state[groupId];
    if (!value) continue;
    const btn = $(groupId).querySelector(`.select-btn[data-value="${value}"]`);
    if (btn) btn.classList.add('active');
  }
  let radioState = state['reviewType'];
  if (radioState) {
    const radioEl = document.querySelector(`input[name="reviewType"][value="${radioState}"]`);
    if (radioEl) radioEl.checked = true;
  }
  
  radioState = state['clinicianRole'];
  if (radioState) {
    const radioEl = document.querySelector(`input[name="clinicianRole"][value="${radioState}"]`);
    if (radioEl) radioEl.checked = true;
  }

  // Devices
  $('devices-container').innerHTML = '';
  if (state.devices) {
      deviceTypes.forEach(type => {
          if (state.devices[type]) {
              state.devices[type].forEach(value => createDeviceEntry(type, value));
          }
      });
  }
  
  // Blood trends
  document.querySelectorAll('.trend-buttons').forEach(group => {
    const value = state[group.id] || '';
    group.querySelectorAll('.trend-btn').forEach(btn => btn.classList.remove('active'));
    const btnToActivate = group.querySelector(`.trend-btn[data-value="${value}"]`);
    if(btnToActivate) btnToActivate.classList.add('active');
  });
  
  // Set manual flag for b_device
  const expectedOxyText = getOxyDeviceText(state);
  const bDeviceEl = $('b_device');
  if (state.b_device === expectedOxyText || state.b_device === "") {
      bDeviceEl.dataset.manual = "false";
  } else {
      bDeviceEl.dataset.manual = "true";
  }

  // Set manual flag for airway_a
  const aDeviceEl = $('airway_a');
  const expectedAirwayText = getAirwayDeviceText(state);
  if (state.airway_a === expectedAirwayText) {
      aDeviceEl.dataset.manual = "false"; // Matches exactly
  } else if (!expectedAirwayText && state.airway_a) {
        aDeviceEl.dataset.manual = "true"; // Manually typed "Patent"
  } else if (expectedAirwayText && state.airway_a !== expectedAirwayText) {
        aDeviceEl.dataset.manual = "true"; // Manually typed something else
  } else {
        aDeviceEl.dataset.manual = "false"; // Default
  }


  updateWardOtherVisibility();
}

/* ===========================
   Interactivity wiring
   =========================== */
function initialize() {
  updateLastSaved();
  const debouncedComputeAndSave = debounce(()=>{ computeAll(); saveState(true); }, 600);
  
  // Create trend buttons
  const trends = ['↑', '↓', '→'];
  document.querySelectorAll('.trend-buttons').forEach(group => {
      trends.forEach(trend => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'trend-btn';
          btn.dataset.value = trend;
          btn.textContent = trend;
          btn.addEventListener('click', () => {
              const wasActive = btn.classList.contains('active');
              group.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
              if (!wasActive) {
                btn.classList.add('active');
              }
              debouncedComputeAndSave();
          });
          group.appendChild(btn);
      });
  });

  document.querySelectorAll('.toggle-label').forEach(el => {
    el.addEventListener('click', ()=> {
      el.dataset.value = el.dataset.value === 'true' ? 'false' : 'true';
      el.classList.toggle('active', el.dataset.value === 'true');
      const stateSpan = el.querySelector('.state'); if (stateSpan) stateSpan.textContent = el.dataset.value === 'true' ? 'Yes' : 'No';
      const noteWrapperId = el.id.replace('toggle_', '') + '_note_wrapper';
      const noteWrapper = $(noteWrapperId);
      if(noteWrapper) noteWrapper.style.display = el.dataset.value === 'true' ? 'block' : 'none';
      if (el.id === 'toggle_infectionConcern') $('infectionMarkers').style.display = el.dataset.value === 'true' ? 'block' : 'none';
      if (el.id === 'toggle_use_mods') $('mods_inputs').style.display = el.dataset.value === 'true' ? 'block' : 'none';
      debouncedComputeAndSave();
    });
  });

  document.querySelectorAll('.button-group').forEach(group => {
    group.querySelectorAll('.select-btn').forEach(btn => {
      btn.addEventListener('click', ()=> {
        // Clear manual flag on b_device if user clicks an O2 mod button
        if (group.id === 'oxMod' || group.id === 'tracheType' || group.id === 'tracheStatus') {
            $('b_device').dataset.manual = "false";
            $('airway_a').dataset.manual = "false"; // Also reset airway manual flag
        }
          
        group.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (group.id === 'oxMod') toggleOxyFields();
        const noteWrapperId = group.id + '_note_wrapper';
        const noteWrapper = $(noteWrapperId);
        if(noteWrapper) noteWrapper.style.display = (btn.dataset.value !== 'none' && btn.dataset.value !== '') ? 'block' : 'none';
        
        const fn = (group.id === 'stepdownTime') ? computeAllAndSave : debouncedComputeAndSave;
        fn();
      });
    });
  });

  staticInputs.forEach(id => {
    const el = $(id); if (!el) return;
    const evt = (el.tagName==='SELECT' || el.type==='date') ? 'change' : 'input';
    const fn = (id === 'stepdownDate') ? computeAllAndSave : debouncedComputeAndSave;
    el.addEventListener(evt, fn);
  });
  
  // Add listener for b_device manual entry
  $('b_device').addEventListener('input', () => {
      $('b_device').dataset.manual = "true";
  });
  // Add listener for airway_a manual entry
  $('airway_a').addEventListener('input', () => {
      $('airway_a').dataset.manual = "true";
  });


  // --- PMH Note Auto-population ---
  function updatePmhNoteFromComorbs() {
      const otherNote = $('comorb_other_note').value.trim();
      const pmhEl = $('pmh_note');
      if (pmhEl) {
         pmhEl.value = otherNote; // Just set it directly from the 'other' comorb box
         debouncedComputeAndSave(); // Trigger re-compute and save
      }
  }
  
  const comorbOtherNoteEl = $('comorb_other_note');
  if (comorbOtherNoteEl) {
      comorbOtherNoteEl.addEventListener('input', () => {
          updatePmhNoteFromComorbs();
      });
  }
  // --- End PMH Note ---
  
  document.querySelectorAll('input[name="reviewType"]').forEach(r => r.addEventListener('change', debouncedComputeAndSave));
  document.querySelectorAll('input[name="clinicianRole"]').forEach(r => r.addEventListener('change', debouncedComputeAndSave));

  $('ptWard').addEventListener('change', () => {
    updateWardOtherVisibility();
    debouncedComputeAndSave();
  });

  ['neut','lymph'].forEach(id => {
    const el = $(id); if (!el) return;
    el.addEventListener('input', ()=>{ updateNLR(); debouncedComputeAndSave(); });
  });

  const sync = (a,b) => { if (!$(a) || !$(b)) return; $(a).addEventListener('input', ()=>{ $(b).value = $(a).value; debouncedComputeAndSave(); }); $(b).addEventListener('input', ()=>{ $(a).value = $(b).value; debouncedComputeAndSave(); }); };
  sync('adds','atoe_adds'); sync('lactate','bl_lac_review'); sync('hb','bl_hb'); sync('wcc','bl_wcc'); sync('crp','bl_crp'); sync('neut','bl_neut'); sync('lymph','bl_lymph');
  
  const ovA = $('override_amber'), ovR = $('override_red'), ovC = $('override_clear');
  const setOverride = (level) => {
    $('override').value = level;
    $('override_reason_box').style.display = level==='none' ? 'none' : 'block';
    ovA.classList.toggle('active', level==='amber');
    ovR.classList.toggle('active', level==='red');
    debouncedComputeAndSave();
  };
  ovA.addEventListener('click', ()=> setOverride('amber'));
  ovR.addEventListener('click', ()=> setOverride('red'));
  ovC.addEventListener('click', ()=> setOverride('none'));

  document.querySelectorAll('.accordion-wrapper').forEach(wrapper => {
    const btn = wrapper.querySelector('.accordion');
    const panel = wrapper.querySelector('.panel');
    const id = wrapper.dataset.accordionId || Math.random().toString(36).slice(2,8);
    wrapper.dataset.accordionId = id;
    btn.addEventListener('click', ()=>{
      const open = panel.style.display !== 'block';
      panel.style.display = open ? 'block' : 'none';
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.querySelector('.icon').textContent = open ? '[-]' : '[+]';
      const maps = JSON.parse(localStorage.getItem(ACCORDION_KEY) || '{}');
      maps[id] = open;
      localStorage.setItem(ACCORDION_KEY, JSON.stringify(maps));
    });
  });

  document.querySelectorAll('#panel_devices .btn[data-device-type]').forEach(button => {
        button.addEventListener('click', () => {
            createDeviceEntry(button.dataset.deviceType);
            computeAll();
            saveState();
        });
    });

  $('copyBtn').addEventListener('click', ()=> {
    navigator.clipboard.writeText($('summary').value).then(()=> showToast('Summary copied',1400)).catch(()=> showToast('Copy failed',2000));
  });
  
  $('footerSave').addEventListener('click', ()=> { saveState(true); showToast('Saved',900); });
  $('footerCopy').addEventListener('click', ()=> $('copyBtn').click() );

  const clearDataAction = () => {
    if (!confirm('Are you sure you want to clear all data for this patient?')) return;
    const snapshot = getState();
    pushUndo(snapshot);
    staticInputs.forEach(id=>{ const el=$(id); if(el) el.value=''; });
    toggleInputs.forEach(id=>{ const el = $(`toggle_${id}`); if (el) { el.dataset.value='false'; el.classList.remove('active'); const sp = el.querySelector('.state'); if(sp) sp.textContent='No'; } });
    selectInputs.forEach(g=>{ const el=$(g); if(el) el.querySelectorAll('.select-btn').forEach(b=>b.classList.remove('active')); });
    
    toggleOxyFields(); // <-- This will hide all sub-options

    document.querySelectorAll('.trend-buttons .trend-btn').forEach(btn => btn.classList.remove('active'));

    document.querySelectorAll('.concern-note').forEach(el => el.style.display = 'none');
    $('devices-container').innerHTML = '';
    document.querySelectorAll('.accordion-wrapper').forEach(wrapper => {
      const btn = wrapper.querySelector('.accordion');
      const panel = wrapper.querySelector('.panel');
      panel.style.display = 'none';
      btn.setAttribute('aria-expanded', 'false');
      btn.querySelector('.icon').textContent = '[+]';
    });
    localStorage.removeItem(ACCORDION_KEY);
    $('summary').value = '';
    $('b_device').dataset.manual = "false"; // Reset manual flag
    $('airway_a').dataset.manual = "false"; // Reset manual flag
    
    // Reset discharge toggle
    const dischargeToggle = $('toggle_discharge_from_alert');
    // dischargeToggle.style.display = 'none'; // No longer needed, it's always visible
    dischargeToggle.dataset.value = 'false';
    dischargeToggle.classList.remove('active');
    const stateSpan = dischargeToggle.querySelector('.state'); 
    if (stateSpan) stateSpan.textContent = 'No';
    
    $('dischargeNudge').style.display = 'none'; // Hide the nudge message

    computeAll();
    saveState(true);
    showToast('Cleared — Undo?', 10000, 'Undo', ()=> {
      const snap = popUndo();
      if (snap) { restoreState(snap); computeAll(); saveState(true); showToast('Restored',1400); } else { showToast('Undo expired',1400); }
    });
  };

  $('clearDataBtnTop').addEventListener('click', clearDataAction);
  $('clearDataBtnBottom').addEventListener('click', clearDataAction);

  const darkBtn = $('darkToggle');
  const applyDark = (on) => {
    document.body.classList.toggle('dark', !!on);
    darkBtn.setAttribute('aria-pressed', !!on);
    darkBtn.textContent = (!!on) ? 'Light mode' : 'Dark mode';
    localStorage.setItem('alertToolDark', !!on ? '1' : '0');
  };
  darkBtn.addEventListener('click', ()=> { const on = !document.body.classList.contains('dark'); applyDark(on); });
  const darkPref = localStorage.getItem('alertToolDark');
  if (darkPref === '1') applyDark(true);

  
  const saved = loadState();
  if (saved) {
    restoreState(saved);
  }
  
  toggleOxyFields(); // Must be after restoreState

  const maps = JSON.parse(localStorage.getItem(ACCORDION_KEY) || '{}');
  document.querySelectorAll('.accordion-wrapper').forEach(wrapper => {
      const id = wrapper.dataset.accordionId;
      if (maps[id]) {
          const btn = wrapper.querySelector('.accordion');
          const panel = wrapper.querySelector('.panel');
          panel.style.display = 'block';
          btn.setAttribute('aria-expanded','true');
          btn.querySelector('.icon').textContent='[-]';
      }
  });

  computeAll();
  window.addEventListener('beforeunload', ()=> saveState(true));
}

/* ===========================
   UX helpers & compute
   =========================== */
function getRoundedTime() {
    const now = new Date();
    const minutes = now.getMinutes();
    const roundedMinutes = Math.round(minutes / 15) * 15;
    if (roundedMinutes === 60) {
        now.setHours(now.getHours() + 1);
        now.setMinutes(0);
    } else {
        now.setMinutes(roundedMinutes);
    }
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
}

function toggleOxyFields() {
  const mod = $('oxMod').querySelector('.select-btn.active')?.dataset.value || 'RA';
  document.querySelectorAll('.npOnly').forEach(el => el.style.display = (mod === 'NP') ? '' : 'none');
  document.querySelectorAll('.hfnpOnly').forEach(el => el.style.display = (mod === 'HFNP') ? '' : 'none');
  document.querySelectorAll('.nivOnly').forEach(el => el.style.display = (mod === 'NIV') ? '' : 'none');
  document.querySelectorAll('.tracheOnly').forEach(el => el.style.display = (mod === 'Trache') ? '' : 'none');
}

function updateNLR() {
  const neut = num($('neut').value), lymph = num($('lymph').value);
  const nlrCalc = $('nlrCalc');
  if(neut !== null && lymph > 0){
    const nlr = (neut / lymph).toFixed(1);
    nlrCalc.textContent = `NLR: ${nlr}`;
    nlrCalc.classList.remove('status', 'red', 'amber');
    if (nlr > 10) nlrCalc.classList.add('status', 'red');
    else if (nlr >=5) nlrCalc.classList.add('status', 'amber');
    return num(nlr);
  } else {
    nlrCalc.textContent = `NLR: --`;
    nlrCalc.classList.remove('status', 'red', 'amber');
    return null;
  }
}

function updateSingleBloodFlag(key, value, inputElIdPrefix = 'bl_') {
    const range = normalRanges[key];
    if(!range) return;

    const inputEl = $(`${inputElIdPrefix}${key}`);
    const rangeEl = $(`${inputElIdPrefix}${key}_range`);
    
    if (inputEl) {
        const isAbnormal = value !== null && (value < range.low || value > range.high);
        inputEl.classList.toggle('blood-abnormal', isAbnormal);
        if (rangeEl) {
            if(isAbnormal){
              rangeEl.textContent = `(Normal: ${range.low}-${range.high})`;
              rangeEl.style.display = 'block';
            } else {
              rangeEl.style.display = 'none';
            }
        }
    }
}


function updateBloodFlags(s) {
  for (const key of Object.keys(normalRanges)) {
    updateSingleBloodFlag(key, num(s[`bl_${key}`]));
  }
}

/**
 * Calculates time on ward.
 * @returns {object} { text: "...", hours: diffHours }
 */
function calculateTimeOnWard(dateStr, timeOfDay) {
  if (!dateStr) return { text: null, hours: null };
  const timeMap = { 'Morning': 9, 'Afternoon': 15, 'Evening': 18, 'Night': 21 };
  const stepdownHour = timeMap[timeOfDay] || 12;
  const [year, month, day] = dateStr.split('-').map(Number);
  const stepdownDate = new Date(year, month - 1, day, stepdownHour, 0, 0);
  if (isNaN(stepdownDate.getTime())) return { text: null, hours: null };
  
  const diffMs = new Date().getTime() - stepdownDate.getTime();
  const diffHours = diffMs / 3600000;

  if (diffHours < 0) return { text: '(future date)', hours: diffHours };

  let text;
  if (diffHours < 24) {
      text = `${Math.round(diffHours)} hours`;
  } else {
      const days = (diffHours / 24).toFixed(1); // Use toFixed(1) for more precision
      text = `${days} day${days === "1.0" ? '' : 's'}`;
  }
  return { text: text, hours: diffHours };
}


function updateDisplay(s, red, amber, flaggedElements, location, cat, diffHours = null) {
    const redCount = red.length, amberCount = amber.length;

    // Clear previous highlights
    document.querySelectorAll('.flag-red, .flag-amber').forEach(el => el.classList.remove('flag-red', 'flag-amber'));
    
    // Apply new highlights
    flaggedElements.red.forEach(id => {
      const el = $(id);
      if(el) el.classList.add('flag-red');
    });
    flaggedElements.amber.forEach(id => {
      const el = $(id);
      if(el) el.classList.add('flag-amber');
    });


    $('redCount').textContent = redCount;
    $('amberCount').textContent = amberCount;
    $('redCount').style.color = redCount > 0 ? 'var(--red)' : 'var(--ink)';
    $('amberCount').style.color = amberCount > 0 ? 'var(--amber)' : 'var(--ink)';
    
    const catTextEl = $('catText');
    catTextEl.className = 'status ' + cat.id;
    catTextEl.textContent = cat.text; // Removed "HIGH PRIORITY"
    
    const catBox = $('categoryBox');
    catBox.style.borderColor = `var(--${cat.id})`;

    const flagListEl = $('flagList');
    if (redCount > 0 || amberCount > 0) {
        const redFlagsHTML = red.map(f => `<div style="color:var(--red); font-weight:600; margin:6px 0;">[CAT 1] ${f}</div>`);
        const amberFlagsHTML = amber.map(f => `<div style="color:var(--amber); font-weight:600; margin:6px 0;">[CAT 2] ${f}</div>`);
        flagListEl.innerHTML = [...redFlagsHTML, ...amberFlagsHTML].join('');
    } else {
        flagListEl.innerHTML = `<div style="color:var(--muted)">No risk factors identified</div>`;
    }

    const followUpEl = $('followUpInstructions');
    let followUpHTML = '';
    // Check if discharge is ticked
    if (s.discharge_from_alert) {
         followUpHTML = `<div class="status" style="color:var(--blue-hint);">Discharge from ALERT nursing post ICU review list.</div>`;
    } else if (cat.id === 'red') {
        if (redCount >= 3) {
            followUpHTML = `<div class="status red">Twice-daily ALERT review for up to 72h post-ICU stepdown.</div>`;
        } else {
            followUpHTML = `<div class="status red">At least daily ALERT review for up to 72h post-ICU stepdown.</div>`;
        }
    } else if (cat.id === 'amber') {
        followUpHTML = `<div class="status amber">Once-daily ALERT review for up to 48h post-ICU stepdown.</div>`;
    } else {
        followUpHTML = `<div class="status green">Single ALERT review on ward to ensure continued stability.</div>`;
    }
    followUpEl.innerHTML = followUpHTML;

    // --- Discharge Nudge Logic ---
    const nudgeEl = $('dischargeNudge');
    nudgeEl.style.display = 'none'; // Reset
    nudgeEl.textContent = '';

    if (diffHours !== null && diffHours > 0 && !s.discharge_from_alert) {
        let nudgeText = '';
        const days = (diffHours / 24).toFixed(1);
        const daysText = `${days} day${days === "1.0" ? '' : 's'}`;

        if (cat.id === 'red' && diffHours >= 72) {
            nudgeText = `Patient stepped down ${daysText} ago (CAT 1 ≥ 72h). Consider discharge from ALERT.`;
        } else if (cat.id === 'amber' && diffHours >= 48) {
            nudgeText = `Patient stepped down ${daysText} ago (CAT 2 ≥ 48h). Consider discharge from ALERT.`;
        } else if (cat.id === 'green' && diffHours >= 24) {
            // Assuming 24h for CAT 3
            nudgeText = `Patient stepped down ${daysText} ago (CAT 3 ≥ 24h). Consider discharge from ALERT.`;
        }

        if (nudgeText) {
            nudgeEl.textContent = nudgeText;
            nudgeEl.style.display = 'block';
        }
    }
    
    // --- Discharge Toggle Logic (REMOVED) ---
    // This is no longer needed as the toggle is always visible.

    // Footer and score
    $('footerName').textContent = s.ptName || '--';
    $('footerLocation').textContent = location || '--';
    $('footerAdmission').textContent = s.ptAdmissionReason || '--';
    const scoreEl = $('footerScore');
    scoreEl.className = `footer-score tag ${cat.id}`;
    const flagCount = redCount > 0 ? redCount : amberCount;
    const flagText = flagCount > 0 ? ` (${flagCount} Flag${flagCount>1?'s':''})` : '';
    scoreEl.textContent = `${cat.text}${flagText}`;
}


function computeAll() {
  const s = getState(); // current state from DOM
  
  // === Auto-populate A-E assessment fields ===
  
  // --- Handle Airway (A) ---
  const airwayText = getAirwayDeviceText(s); // This will be "Tracheostomy (details...)", "Altered Airway", or ""
  const airwayEl = $('airway_a');
  
  if (airwayEl.dataset.manual !== "true") {
      // Not manually edited.
      if (airwayText) {
          // It's a trache, auto-populate
          airwayEl.value = airwayText;
          s.airway_a = airwayText; // Update state for summary
      }
      // If airwayText is "", we do nothing, preserving placeholder or saved "Patent" text.
  }
  // If manual, s.airway_a is already correct from getState().

  // --- Handle Breathing (B) ---
  const oxyDeviceText = getOxyDeviceText(s); // Calculate text from scorable section (will be "" for trache)
  const bDeviceEl = $('b_device');

  if (bDeviceEl.dataset.manual !== "true") {
      // User has not typed manually, so we are free to auto-populate.
      bDeviceEl.value = oxyDeviceText.trim();
      s.b_device = oxyDeviceText.trim(); // Update state for summary
  } else {
      // User *has* typed manually.
      // The correct value is already in s.b_device (captured by getState()).
      // We do nothing, preserving the user's manual entry.
  }

  // Sync notes to A-E fields if the source note has content
  if (s.dyspneaConcern_note && s.dyspneaConcern_note.trim() !== '') {
      $('b_wob').value = s.dyspneaConcern_note;
      s.b_wob = s.dyspneaConcern_note;
  }
  if (s.uopLow_note && s.uopLow_note.trim() !== '') {
      $('e_uop').value = s.uopLow_note;
      s.e_uop = s.uopLow_note;
  }
  if (s.immobility48h_note && s.immobility48h_note.trim() !== '') {
      $('ae_mobility').value = s.immobility48h_note;
      s.ae_mobility = s.immobility48h_note;
  }


  const red = [], amber = [];
  const flaggedElements = { red: [], amber: [] };

  const addRisk = (list, text, note, elementId, flagType) => {
    if (note && note.trim()) {
        list.push(`${text} (${note.trim()})`);
    } else {
        list.push(text);
    }
    if (elementId && flagType) {
        flaggedElements[flagType].push(elementId);
    }
  }

  const ward = s.ptWard === 'Other' ? s.ptWardOther : s.ptWard;
  const location = [ward, s.ptBed].filter(Boolean).join(' ').trim();
  
  const icuLos = num(s.icuLos);
  const immobility = s.immobility48h;
  const pressors = s.pressors24h;
  const lactateVal = num(s.lactate);
  const hasSignificantFlags = pressors || (lactateVal !== null && lactateVal > 2.0);
  let hasCombinedRedFlag = false;

  if ((immobility && icuLos >= 4) || (icuLos >= 4 && hasSignificantFlags)) {
      let reason = (immobility && icuLos >= 4) 
          ? `Immobility >48h + ICU LOS ${icuLos} days` 
          : `ICU LOS ${icuLos} days + Significant flag (${pressors ? 'vasopressors' : 'lactate >2'})`;
      red.push(reason);
      if (immobility) flaggedElements.red.push('toggle_immobility48h');
      flaggedElements.red.push('icuLos');
      if (pressors) flaggedElements.red.push('toggle_pressors24h');
      if (lactateVal > 2.0) flaggedElements.red.push('lactate');
      hasCombinedRedFlag = true;
  }

  if (immobility && !hasCombinedRedFlag) {
      addRisk(amber, 'Immobility >48h', s.immobility48h_note, 'toggle_immobility48h', 'amber');
  }

  if (icuLos > 7 && !hasCombinedRedFlag) {
      amber.push(`ICU LOS ${icuLos} days`);
      flaggedElements.amber.push('icuLos');
  }

  const oxModGroup = $('oxMod');
  if (s.oxMod === 'NP') {
    const flow = num(s.npFlow);
    if (flow !== null && flow >= 3) { red.push(`NP flow ${flow} L/min`); flaggedElements.red.push(oxModGroup.id); flaggedElements.red.push('npFlow'); }
    else if (flow !== null && flow >= 2) { amber.push(`NP flow ${flow} L/min`); flaggedElements.amber.push(oxModGroup.id); flaggedElements.amber.push('npFlow');}
  } else if (s.oxMod === 'HFNP') {
    const fio2 = num(s.hfnpFio2), flow = num(s.hfnpFlow);
    const hfnpParts = [];
    if (fio2 > 30) { hfnpParts.push(`FiO2 ${fio2}%`); flaggedElements.red.push('hfnpFio2');}
    if (flow > 30) { hfnpParts.push(`flow ${flow}L`); flaggedElements.red.push('hfnpFlow');}
    if (hfnpParts.length > 0) {
      red.push(`HFNP concern: ${hfnpParts.join(' & ')}`);
      flaggedElements.red.push(oxModGroup.id);
    } else if ((fio2 > 21) || (flow > 0)) {
      amber.push('On HFNP (low settings)');
      flaggedElements.amber.push(oxModGroup.id);
    }
  } else if (s.oxMod === 'NIV') {
    red.push('On NIV');
    flaggedElements.red.push(oxModGroup.id);
  } else if (s.oxMod === 'Trache') {
    const tracheType = s.tracheType || 'Altered Airway'; // User request: default to 'Altered Airway'
    const tracheStatus = s.tracheStatus;
    
    if (tracheStatus === 'New') {
      addRisk(red, tracheType, null, 'oxMod', 'red');
    } else if (tracheStatus === 'Stable') {
      addRisk(amber, tracheType, null, 'oxMod', 'amber');
    } else {
      // No status selected
      addRisk(amber, tracheType, null, 'oxMod', 'amber');
    }
  }

  if (s.np3Last12h) addRisk(red, 'Historical high O2 use', s.np3Last12h_note, 'toggle_np3Last12h', 'red');
  if (s.rapidWean) addRisk(red, 'Rapid oxygen wean in last 12h', s.rapidWean_note, 'toggle_rapidWean', 'red');
  if (s.after_hours_discharge) addRisk(red, 'Discharged after-hours', s.after_hours_discharge_note, 'toggle_after_hours_discharge', 'red');
  if (s.pressors24h && !hasCombinedRedFlag) addRisk(red, 'Vasopressors in last 24h', s.pressors24h_note, 'toggle_pressors24h', 'red');
  if (num(s.adds) >= 3) { red.push(`ADDS ${s.adds}`); flaggedElements.red.push('adds');}

  if (lactateVal > 2.5) {red.push(`Lactate ${lactateVal}`); flaggedElements.red.push('lactate');}
  else if (lactateVal >= 2.0 && !hasCombinedRedFlag) {amber.push(`Lactate ${lactateVal}`); flaggedElements.amber.push('lactate');}
  
  if (s.uopLow) addRisk(red, 'UOP concerning / downtrending', s.uopLow_note, 'toggle_uopLow', 'red');
  
  if (s.renalConcern) {
    let renalDetails = [];
    if (s.bl_cr_review) renalDetails.push(`Cr ${s.bl_cr_review}`);
    let renalText = 'Renal Concern';
    if(renalDetails.length > 0) renalText += ` (${renalDetails.join(', ')})`;
    addRisk(red, renalText, s.renalConcern_note, 'toggle_renalConcern', 'red');
  }
  
  if (s.neuroConcern === 'severe' || s.neuroConcern === 'mild') {
      let neuroDetailsParts = [];
      if (s.d_alert && s.d_alert.trim()) {
          neuroDetailsParts.push(s.d_alert.trim());
      }
      if (s.d_gcs && s.d_gcs.trim()) {
          neuroDetailsParts.push(`GCS ${s.d_gcs.trim()}`);
      }

      let neuroDetailsText = '';
      if (neuroDetailsParts.length > 0) {
          neuroDetailsText = ` (${neuroDetailsParts.join(', ')})`;
      }

      if (s.neuroConcern === 'severe') {
          const baseText = `Severe confusion/delirium${neuroDetailsText}`;
          addRisk(red, baseText, s.neuroConcern_note, 'neuroConcern', 'red');
      } else if (s.neuroConcern === 'mild') {
          const baseText = `Mild confusion/delirium${neuroDetailsText}`;
          addRisk(amber, baseText, s.neuroConcern_note, 'neuroConcern', 'amber');
      }
  }
  
  if (s.electrolyteConcern === 'severe') {
      addRisk(red, 'Severe electrolyte concern', s.electrolyteConcern_note, 'electrolyteConcern', 'red');
  } else if (s.electrolyteConcern === 'mild') {
      addRisk(amber, 'Mild/moderate electrolyte concern', s.electrolyteConcern_note, 'electrolyteConcern', 'amber');
  }

  if (s.dyspneaConcern === 'severe') {
    let dyspneaDetails = [];
    if (s.b_rr) dyspneaDetails.push(`RR ${s.b_rr}`);
    if (s.b_wob) dyspneaDetails.push(`WOB ${s.b_wob}`);
    let dyspneaText = 'Severe dyspnea';
    if (dyspneaDetails.length > 0) dyspneaText += ` (${dyspneaDetails.join(', ')})`;
    addRisk(red, dyspneaText, s.dyspneaConcern_note, 'dyspneaConcern', 'red');
  } else if (s.dyspneaConcern === 'mild') {
    addRisk(amber, 'Mild dyspnea', s.dyspneaConcern_note, 'dyspneaConcern', 'amber');
  }

  const hb = num(s.hb);
  if (hb !== null && hb < 80) { red.push(`Anemia concern (Hb ${hb})`); flaggedElements.red.push('hb'); }
  else if (hb !== null && hb < 100) { amber.push(`Anemia concern (Hb ${hb})`); flaggedElements.amber.push('hb'); }


  const comorbIds = ['comorb_copd','comorb_hf','comorb_esrd','comorb_diabetes','comorb_cirrhosis', 'comorb_other'];
  const comorbCount = comorbIds.filter(id => s[id]).length;
  if (comorbCount >= 3) { 
      red.push('Multiple comorbidities'); 
      comorbIds.forEach(id => {if(s[id]) flaggedElements.red.push('toggle_'+id) });
  }
  else if (comorbCount > 0) { 
      amber.push(`Comorbidities (${comorbCount})`); 
      comorbIds.forEach(id => {if(s[id]) flaggedElements.amber.push('toggle_'+id) });
  }

  if (s.infectionConcern) {
    const wcc = num(s.wcc), crp = num(s.crp), nlr = updateNLR(), temp = num(s.e_temp);
    let markerParts = [];
    let hasRedMarker = false;
    let hasAmberMarker = false;

    if (wcc !== null && (wcc < normalRanges.wcc.low || wcc > normalRanges.wcc.high)) { markerParts.push(`WCC ${wcc}`); hasRedMarker = true; }
    if (crp > 100) { markerParts.push(`CRP ${crp}`); hasRedMarker = true; }
    else if (crp > 50) { markerParts.push(`CRP ${crp}`); hasAmberMarker = true; }
    if (nlr > 10) { markerParts.push(`NLR ${nlr}`); hasRedMarker = true; }
    else if (nlr >= 5) { markerParts.push(`NLR ${nlr}`); hasAmberMarker = true; }
    if (temp >= 38.0) { markerParts.push(`Temp ${temp}C`); hasAmberMarker = true; }

    let baseText = 'Infection Concern';
    if (markerParts.length > 0) {
      baseText += `: High markers (${markerParts.join(', ')})`;
    }

    let category = 'red'; // Default to red if box is ticked with no markers
    if (hasRedMarker) {
      category = 'red';
    } else if (hasAmberMarker) {
      category = 'amber';
    }
    
    addRisk(category === 'red' ? red : amber, baseText, s.infectionConcern_note, 'toggle_infectionConcern', category);
  }

  const overrideNote = $('overrideNote')?.value ? ` (${$('overrideNote').value})` : '';
  if ($('override').value === 'red') red.push(`Override: CAT 1 concern${overrideNote}`);
  else if ($('override').value === 'amber') amber.push(`Override: CAT 2 concern${overrideNote}`);

  updateBloodFlags(s);
  updateSingleBloodFlag('wcc', num(s.wcc), '');
  updateSingleBloodFlag('crp', num(s.crp), '');
  updateSingleBloodFlag('neut', num(s.neut), '');
  updateSingleBloodFlag('lymph', num(s.lymph), '');

  // --- Calculate Category ---
  const redCount = red.length;
  const amberCount = amber.length;
  const cat = (redCount > 0) ? {id: 'red', text: 'CAT 1', catNum: 1} : (amberCount > 0) ? {id: 'amber', text: 'CAT 2', catNum: 2} : {id: 'green', text: 'CAT 3', catNum: 3};
  
  // Get time on ward
  const wardTime = calculateTimeOnWard(s.stepdownDate, s.stepdownTime);
  const timeOnWardText = wardTime.text;
  const timeOnWardHours = wardTime.hours;

  // --- Update UI ---
  updateDisplay(s, red, amber, flaggedElements, location, cat, timeOnWardHours);

  // --- Generate Summary ---
  
  // Helper function to clean A-E parts: trim whitespace and remove trailing periods
  const clean = (str) => str ? str.trim().replace(/\.$/, '').trim() : null;

  const role = s.clinicianRole || 'ALERT CNS';
  let reviewTitle = `${role} Review`;
  if (s.reviewType === 'post') {
      reviewTitle = `${role} post ICU review`;
  } else {
      reviewTitle = `${role} pre ICU stepdown review`;
  }
  
  const headerLines = [];
  
  const patientDetailsParts = [];
  if (s.ptName) patientDetailsParts.push(`Patient: ${s.ptName}`);
  if (s.ptMrn) patientDetailsParts.push(`URN: ...${s.ptMrn}`);
  if (location) patientDetailsParts.push(`Location: ${location}`);
  
  if (patientDetailsParts.length > 0) {
      headerLines.push(patientDetailsParts.join(' | '));
  }

  headerLines.push(reviewTitle, `Time of review: ${getRoundedTime()}`);

  const stepdownParts = [];
  if (s.reviewType === 'post') {
      if(timeOnWardText) stepdownParts.push(`Time since stepdown: ${timeOnWardText}.`);
  }
  if (s.icuLos) stepdownParts.push(`ICU LOS: ${s.icuLos} days.`);
  if(stepdownParts.length > 0) headerLines.push('', ...stepdownParts);
  
  if(s.ptAdmissionReason) headerLines.push(`Reason for ICU Admission: ${s.ptAdmissionReason}`);
  
  const lines = [...headerLines, ''];
  
  lines.push(`ALERT Nursing Review Category - ${cat.text}`);

  if (s.pmh_note && s.pmh_note.trim() !== '') {
      lines.push('', 'PMH:', s.pmh_note.trim());
  }

  const atoe = [];
  const score_line = (s.use_mods) ? [s.mods_score ? `MODS Score: ${s.mods_score}`:null, s.mods_details ? `Details: ${s.mods_details}`:null].filter(Boolean).join(' | ') : s.adds ? `ADDS: ${s.adds}` : '';
  if (score_line) atoe.push(score_line);
  
  // A-line: Use s.airway_a which is now populated by manual entry or getAirwayDeviceText
  if (s.airway_a) atoe.push(`A: ${s.airway_a.trim()}`);
  
  // B-line: Use s.b_device which is populated by manual entry or getOxyDeviceText
  const b_parts = [
    clean(s.b_rr) ? `RR ${clean(s.b_rr)}`:null, 
    clean(s.b_spo2) ? `SpO2 ${clean(s.b_spo2)}${clean(s.b_spo2).includes('%') ? '' : '%'}`:null, 
    clean(s.b_device),
    clean(s.b_wob) ? `WOB ${clean(s.b_wob)}`:null
  ];
  const b_line = b_parts.filter(Boolean).join(', ');
  if (b_line) atoe.push(`B: ${b_line}`);
  
  const c_parts = [
    clean(s.c_hr) ? `HR ${clean(s.c_hr)}`:null, 
    clean(s.c_nibp) ? `NIBP ${clean(s.c_nibp)}`:null, 
    clean(s.c_cr) ? `Cap Refill ${clean(s.c_cr)}`:null, 
    clean(s.c_perf)
  ];
  const c_line = c_parts.filter(Boolean).join(', ');
  if (c_line) atoe.push(`C: ${c_line}`);
  
  const d_parts = [
    clean(s.d_alert), 
    clean(s.d_gcs) ? `GCS ${clean(s.d_gcs)}`:null, 
    clean(s.d_pain) ? `Pain ${clean(s.d_pain)}`:null
  ];
  const d_line = d_parts.filter(Boolean).join(', ');
  if (d_line) atoe.push(`D: ${d_line}`);
  
  const e_parts = [
    clean(s.e_temp) ? `Temp ${clean(s.e_temp)}${String(clean(s.e_temp)).toLowerCase().match(/febrile|afebrile/) ? '' : 'C'}`:null, 
    clean(s.e_bsl) ? `BSL ${clean(s.e_bsl)}`:null, 
    clean(s.e_uop) ? `UOP ${clean(s.e_uop)}`:null
  ];
  const e_line = e_parts.filter(Boolean).join(', ');
  if (e_line) atoe.push(`E: ${e_line}`);
  
  const otherSystemItems = [];
  // These are free-text fields, so we just trim whitespace, not trailing periods.
  if (s.ae_mobility) otherSystemItems.push(`Mobility/MSK: ${s.ae_mobility.trim()}`);
  if (s.ae_diet) otherSystemItems.push(`Diet: ${s.ae_diet.trim()}`);
  if (s.ae_bowels) otherSystemItems.push(`Bowels: ${s.ae_bowels.trim()}`);

  if (atoe.length > 0 && otherSystemItems.length > 0) {
      atoe.push('---');
  }
  atoe.push(...otherSystemItems);

  if (atoe.length > 0) lines.push('', 'A-E ASSESSMENT', ...atoe);

  const bloodLines = [];
  const bloodParts = ['lac_review','hb','wcc','crp','cr_review','k','na','mg','plts','alb','neut','lymph'];
  const bloodLabelMap = {
    'lac_review': 'Lac', 'hb': 'Hb', 'wcc': 'WCC', 'crp': 'CRP', 'cr_review': 'Cr',
    'k': 'K', 'na': 'Na', 'mg': 'Mg', 'plts': 'Plts', 'alb': 'Alb', 'neut': 'Neut', 'lymph': 'Lymph'
  };
  const trendWord = val => ({ '↑': ' (uptrending)', '↓':' (downtrending)', '→':' (stable)'}[val] || '');
  const bloods = bloodParts.map(k => {
    const v = s[`bl_${k}`]; if (!v) return null;
    const trendKey = `bl_${k}_trend`;
    const trend = s[trendKey] || '';
    const label = bloodLabelMap[k] || k.replace('_review',''); // Use map
    return `${label} ${v}${trendWord(trend)}`; // Removed .toUpperCase()
  }).filter(Boolean).join(', ');

  let fullBloodLine = bloods;
  if (s.new_bloods_ordered) {
      fullBloodLine += `${bloods ? ' ' : ''}(new bloods ordered for next round.)`;
  }
  if (fullBloodLine) bloodLines.push(`Bloods: ${fullBloodLine}`);
  if (s.elec_replace_note) bloodLines.push(`Electrolyte Plan: ${s.elec_replace_note.trim()}`);

  if (bloodLines.length > 0) lines.push('', ...bloodLines);
  
  const deviceParts = [];
  if(s.devices){
    deviceTypes.forEach(type => {
        if (s.devices[type] && s.devices[type].length > 0) {
            s.devices[type].forEach((details) => {
                let deviceString = '';
                const detailsTrimmed = details ? details.trim() : '';

                if (type === 'Other CVAD' || type === 'Other Device') {
                    // Request: Only show the free text
                    if (detailsTrimmed) {
                        deviceString = detailsTrimmed;
                    } else {
                        // Edge case: user added 'Other Device' but wrote nothing.
                        deviceString = type; 
                    }
                } else {
                    // Original logic for all other types
                    deviceString = type;
                    if (detailsTrimmed) deviceString += ` (${detailsTrimmed})`;
                }
                deviceParts.push(deviceString);
            });
        }
    });
  }
  
  if (deviceParts.length > 0) {
    lines.push('');
    lines.push('DEVICES:');
    deviceParts.forEach(p=> lines.push('- ' + p));
  }
  
  const contextLines = [];
  if (s.goc_note) {
    const gocText = s.goc_note.trim();
    if (gocText.toLowerCase().startsWith('goc')) {
      contextLines.push(gocText);
    } else {
      contextLines.push(`GOC: ${gocText}`);
    }
  }
  if (s.allergies_note) contextLines.push(`Allergies: ${s.allergies_note.trim()}`);
  if (s.pics_note) contextLines.push(`Post ICU Syndrome: ${s.pics_note.trim()}`);
  if (s.context_other_note) contextLines.push(`Other: ${s.context_other_note.trim()}`);
  if (contextLines.length > 0) {
      lines.push('', ...contextLines);
  }

  const allFlags = [...red, ...amber];
  if (allFlags.length > 0) {
    lines.push('', 'IDENTIFIED RISK FACTORS:');
    allFlags.forEach(f => lines.push('- ' + f));
  }

  lines.push('', 'PLAN & FOLLOW-UP:');
  if (s.discharge_from_alert) {
      lines.push('- Follow-up: Discharge from ALERT nursing post ICU review list.');
  } else if (redCount > 0) {
      if (redCount >= 3) {
         lines.push(`- Follow-up: Twice-daily ALERT review for up to 72h post-ICU stepdown.`);
      } else {
         lines.push(`- Follow-up: At least daily ALERT review for up to 72h post-ICU stepdown.`);
      }
  } else if (amberCount > 0) {
      lines.push('- Follow-up: Once-daily ALERT review for up to 48h post-ICU stepdown.');
  } else {
      lines.push('- Follow-up: Single ALERT review on ward to ensure continued stability.');
  }


  $('summary').value = lines.join('\n');
  updateLastSaved();
}

/* ===========================
   Init
   =========================== */
document.addEventListener('DOMContentLoaded', ()=> {
  initialize();
  // computeAll(); // This is now called inside initialize after restore
  updateLastSaved();
});
</script>
</body>
</html>


